<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Before Us Universe — Media Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #001a1a;
            --fg: #00ffff;
            --accent: #ffcc00;
            --border: #00cccc;
            --panel-bg: #002b2b;
            --text-gray: #e6f7f7;
            --muted: #00aaaa;
            --online: #00ff9d;
            --yahoo-blue: #1e73be;
            --yahoo-dark: #0961a6;
        }
        body {
            margin: 0;
            background: var(--bg);
            font-family: 'Roboto Mono', monospace;
            color: var(--fg);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            height: 100vh;
            overflow: hidden;
            transition: filter 0.4s;
        }
        #player-container {
            width: 100%;
            height: 40px; /* Slim banner height to match server selection box */
            border-bottom: 2px solid var(--border);
            background: rgba(0, 20, 40, 0.8);
            box-shadow: 0 0 20px var(--fg);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .aplayer {
            background: transparent !important;
            border: none !important;
            width: 100%;
            max-width: 800px;
            font-family: 'Press Start 2P', cursive !important;
            font-size: 8px !important; /* Smaller font for thin layout */
            color: var(--fg) !important;
            height: 40px !important;
        }
        .aplayer .aplayer-body {
            background: var(--panel-bg) !important;
            border: 1px solid var(--border) !important;
            border-radius: 4px;
            padding: 3px; /* Reduced padding for thinness */
            height: 30px; /* Force thin height */
            display: flex;
            align-items: center;
        }
        .aplayer-bar-wrap {
            height: 4px !important; /* Thin progress bar */
            margin: 0 5px;
        }
        .aplayer-bar, .aplayer-played {
            background-color: var(--accent) !important;
            height: 4px !important;
        }
        .aplayer-play .aplayer-icon,
        .aplayer-pause .aplayer-icon,
        .aplayer-icon {
            fill: var(--fg) !important;
            stroke: var(--border) !important;
            width: 12px;
            height: 12px; /* Smaller icons for thin layout */
        }
        .aplayer-title, .aplayer-author {
            color: var(--fg) !important;
            text-shadow: 0 0 5px var(--fg);
            font-size: 8px; /* Ensure track name is visible */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Limit width to fit in thin bar */
            display: inline-block !important; /* Force display */
        }
        .aplayer .aplayer-lrc {
            display: none; /* Hide lyrics to keep thin */
        }
        .aplayer .aplayer-list {
            display: none; /* Hide playlist to keep thin */
        }
        .aplayer .aplayer-info {
            display: flex !important;
            align-items: center;
            height: 100%;
        }
        .aplayer .aplayer-controller {
            display: flex !important;
            align-items: center;
        }
        .aplayer .aplayer-time {
            font-size: 8px;
        }
        /* static render layer */
        #static-overlay {
            position: fixed;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            mix-blend-mode: screen;
            z-index: 50;
            transition: opacity 0.3s linear;
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        /* glitch keyframes */
        @keyframes glitchshake {
            0% { transform: translate(0,0); }
            20% { transform: translate(3px,-2px); }
            40% { transform: translate(-3px,1px); }
            60% { transform: translate(2px,2px); }
            80% { transform: translate(-2px,-3px); }
            100% { transform: translate(0,0); }
        }
        @keyframes luxpulse {
            0% { box-shadow: 0 0 10px var(--fg); }
            50% { box-shadow: 0 0 25px var(--fg); }
            100% { box-shadow: 0 0 10px var(--fg); }
        }
        .glitching {
            animation: glitchshake 0.25s infinite;
        }
        .luxpulse {
            animation: luxpulse 1s infinite;
        }
        /* hidden whisper popup */
        #whisper {
            position: fixed;
            bottom: 10%;
            width: 100%;
            text-align: center;
            color: #f0f;
            font-size: 24px;
            text-shadow: 0 0 20px #f0f;
            opacity: 0;
            transition: opacity 1.2s;
            z-index: 200;
            pointer-events: none;
            font-family: Georgia, serif;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
<div id="player-container">
    <div id="aplayer"></div>
</div>
<video id="static-overlay" loop muted playsinline src="https://static.vecteezy.com/system/resources/previews/026/716/053/non_2x/user-upload.mp4"></video>
<div id="whisper">“…you should not be here…”</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
<script>
async function loadPlaylist() {
    try {
        const response = await fetch("playlist.json");
        if (!response.ok) throw new Error(`Failed to load playlist: ${response.statusText}`);
        const playlist = await response.json();
        const shuffle = (array) => array.sort(() => Math.random() - 0.5);
        shuffle(playlist);
        const player = new APlayer({
            container: document.getElementById('aplayer'),
            audio: playlist,
            autoplay: false,
            theme: '#0ff',
            loop: 'all',
            order: 'random',
            mini: false, 
            fixed: true
        });

        // --- DISTORTION + GLITCH ENGINE SETUP ---
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let trackSource = null; // Will store the MediaElementSourceNode
        let distortionActive = false;
        let distortionTimer = null;
        let intervals = [];
        const staticOverlay = document.getElementById("static-overlay");
        const whisper = document.getElementById("whisper");
        const container = document.getElementById("player-container");

        // Function to set up the Web Audio graph (Run only ONCE)
        function setupAudioContext() {
            if (trackSource) return; // Already set up

            // Create the source from the existing APlayer audio element
            trackSource = audioCtx.createMediaElementSource(player.audio);
            
            // Connect the source directly to the destination
            trackSource.connect(audioCtx.destination);
            
            console.log("Web Audio Context initialized and connected.");
        }

        function createStaticNoise() {
            const bufferSize = audioCtx.sampleRate * 3;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.07;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            noise.loop = true;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.12;
            noise.connect(gain).connect(audioCtx.destination);
            return { noise, gain };
        }

        function whisperEvent() {
            whisper.textContent = Math.random() > 0.5
                ? "“…you opened the wrong door…”"
                : "“…Tiamat is awake…”";
            whisper.style.opacity = 1;
            setTimeout(() => whisper.style.opacity = 0, 2500);
        }

        function activateDistortionMode() {
            if (distortionActive) return;
            // Ensure audio context is resumed (required for all audio manipulation)
            audioCtx.resume(); 
            
            distortionActive = true;
            staticOverlay.currentTime = 0;
            staticOverlay.play().catch(console.error);
            staticOverlay.style.opacity = 0.25;
            container.classList.add("luxpulse");
            intervals.push(setInterval(() => { container.classList.add("glitching"); setTimeout(() => container.classList.remove("glitching"), 300); }, 4000));
            intervals.push(setInterval(() => { document.body.style.filter = "invert(1)"; setTimeout(() => document.body.style.filter = "invert(0)", 500); }, 10000));
            intervals.push(setInterval(() => { if (Math.random() < 0.33) whisperEvent(); }, 12000));
            
            const sn = createStaticNoise();
            sn.noise.start();
            staticNoise = sn;
            
            intervals.push(setInterval(() => {
                // Adjust volume and rate directly on the player's underlying audio element
                player.audio.volume = 0.7 + Math.random() * 0.25;
                player.audio.playbackRate = 1 + (Math.random() * 0.07 - 0.035);
            }, 8000));
        }

        function resetDistortion() {
            distortionActive = false;
            staticOverlay.pause();
            staticOverlay.currentTime = 0;
            staticOverlay.style.opacity = 0;
            container.classList.remove("luxpulse", "glitching");
            document.body.style.filter = "invert(0)";
            if (staticNoise) { staticNoise.noise.stop(); staticNoise = null; }
            
            // Set volume and rate back to normal
            player.audio.playbackRate = 1.0;
            player.audio.volume = 1.0; 
            
            if (distortionTimer) { clearTimeout(distortionTimer); distortionTimer = null; }
            intervals.forEach(clearInterval);
            intervals = [];
        }

        // --- PLAYER HOOKS ---
        player.on('play', () => {
            // CRITICAL STEP: Setup the context only once
            setupAudioContext(); 
            
            resetDistortion();
            audioCtx.resume();
            
            // Start the timer for distortion mode
            distortionTimer = setTimeout(activateDistortionMode, 30000);
        });
        
        // Ensure distortion is reset on pause/end/track switch
        player.on('pause', resetDistortion);
        player.on('ended', resetDistortion);
        player.on('listswitch', resetDistortion);
        window.addEventListener('beforeunload', resetDistortion);

    } catch (error) {
        console.error('Playlist load failed:', error);
        document.getElementById("aplayer").innerHTML = "<p style='color: red; text-align: center;'>Error loading playlist. Please try again.</p>";
    }
}
loadPlaylist();
</script>
</body>
</html>
