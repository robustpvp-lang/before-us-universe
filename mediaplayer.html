<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Before Us Universe — Media Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #001a1a;
        --fg: #00ffff;
        --accent: #ffcc00;
        --border: #00cccc;
        --panel-bg: #002b2b;
        --text-gray: #e6f7f7;
        --muted: #00aaaa;
        --online: #00ff9d;
        --yahoo-blue: #1e73be;
        --yahoo-dark: #0961a6;
    }
    body {
        margin: 0;
        background: var(--bg);
        font-family: 'Roboto Mono', monospace;
        color: var(--fg);
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        height: 100vh;
        overflow: hidden;
        transition: filter 0.4s;
    }
    #player-container {
        width: 100%;
        height: 60px; /* Slim banner height */
        border-bottom: 2px solid var(--border);
        background: rgba(0, 20, 40, 0.8);
        box-shadow: 0 0 20px var(--fg);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .aplayer {
        background: transparent !important;
        border: none !important;
        width: 100%;
        max-width: 800px;
        font-family: 'Press Start 2P', cursive !important;
        font-size: 10px !important;
        color: var(--fg) !important;
    }
    .aplayer .aplayer-body {
        background: var(--panel-bg) !important;
        border: 1px solid var(--border) !important;
        border-radius: 4px;
        padding: 5px;
    }
    .aplayer-bar, .aplayer-played {
        background-color: var(--accent) !important;
    }
    .aplayer-play .aplayer-icon,
    .aplayer-pause .aplayer-icon,
    .aplayer-icon {
        fill: var(--fg) !important;
        stroke: var(--border) !important;
    }
    .aplayer-title, .aplayer-author {
        color: var(--fg) !important;
        text-shadow: 0 0 5px var(--fg);
    }
    /* static render layer */
    #static-overlay {
        position: fixed;
        inset: 0;
        background: url('https://static.vecteezy.com/system/resources/previews/026/716/053/non_2x/user-upload.mp4');
        opacity: 0;
        pointer-events: none;
        mix-blend-mode: screen;
        z-index: 50;
        transition: opacity 0.3s linear;
    }
    /* glitch keyframes */
    @keyframes glitchshake {
        0% { transform: translate(0,0); }
        20% { transform: translate(3px,-2px); }
        40% { transform: translate(-3px,1px); }
        60% { transform: translate(2px,2px); }
        80% { transform: translate(-2px,-3px); }
        100% { transform: translate(0,0); }
    }
    @keyframes luxpulse {
        0% { box-shadow: 0 0 10px var(--fg); }
        50% { box-shadow: 0 0 25px var(--fg); }
        100% { box-shadow: 0 0 10px var(--fg); }
    }
    .glitching {
        animation: glitchshake 0.25s infinite;
    }
    .luxpulse {
        animation: luxpulse 1s infinite;
    }
    /* hidden whisper popup */
    #whisper {
        position: fixed;
        bottom: 10%;
        width: 100%;
        text-align: center;
        color: #f0f;
        font-size: 24px;
        text-shadow: 0 0 20px #f0f;
        opacity: 0;
        transition: opacity 1.2s;
        z-index: 200;
        pointer-events: none;
        font-family: Georgia, serif;
        letter-spacing: 2px;
    }
</style>
</head>
<body>
<div id="player-container">
    <div id="aplayer"></div>
</div>
<div id="static-overlay"></div>
<div id="whisper">“…you should not be here…”</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
<script>
async function loadPlaylist() {
    const response = await fetch("playlist.json");
    const playlist = await response.json();
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j] = [array[j], array[i]];
        }
    }
    shuffle(playlist);
    const player = new APlayer({
        container: document.getElementById('aplayer'),
        audio: playlist,
        autoplay: false,
        theme: '#0ff',
        loop: 'all',
        order: 'random',
        mini: true  // Mini mode for toolbar-like compact view
    });
    //----------------------------
    // DISTORTION + GLITCH ENGINE
    //----------------------------
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let trackSource = null;
    let staticNoise = null;
    let distortionActive = false;
    let distortionTimer = null;
    let intervals = [];
    const staticOverlay = document.getElementById("static-overlay");
    const whisper = document.getElementById("whisper");
    const container = document.getElementById("player-container");
    function createStaticNoise() {
        const bufferSize = audioCtx.sampleRate * 3;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.07;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        noise.loop = true;
        const gain = audioCtx.createGain();
        gain.gain.value = 0.12;
        noise.connect(gain).connect(audioCtx.destination);
        return { noise, gain };
    }
    function whisperEvent() {
        whisper.textContent = Math.random() > 0.5
            ? "“…you opened the wrong door…”"
            : "“…Tiamat is awake…”";
        whisper.style.opacity = 1;
        setTimeout(() => whisper.style.opacity = 0, 2500);
    }
    function activateDistortionMode() {
        if (distortionActive) return;
        distortionActive = true;
        staticOverlay.style.opacity = 0.25;
        container.classList.add("luxpulse");
        intervals.push(setInterval(() => { container.classList.add("glitching"); setTimeout(()=>container.classList.remove("glitching"),300); }, 4000));
        intervals.push(setInterval(() => { document.body.style.filter="invert(1)"; setTimeout(()=>document.body.style.filter="invert(0)",500); }, 10000));
        intervals.push(setInterval(()=>{ if(Math.random()<0.33) whisperEvent(); },12000));
        const sn = createStaticNoise();
        sn.noise.start();
        staticNoise = sn;
        intervals.push(setInterval(() => {
            if(!trackSource) return;
            player.audio.audio.volume = 0.7 + Math.random()*0.25;
            trackSource.playbackRate.value = 1 + (Math.random()*0.07-0.035);
        }, 8000));
    }
    function resetDistortion() {
        distortionActive = false;
        staticOverlay.style.opacity=0;
        container.classList.remove("luxpulse","glitching");
        document.body.style.filter="invert(0)";
        if(staticNoise){ staticNoise.noise.stop(); staticNoise=null; }
        if(trackSource) trackSource.playbackRate.value=1.0;
        player.audio.audio.volume=1.0;
        if(distortionTimer){ clearTimeout(distortionTimer); distortionTimer=null; }
        intervals.forEach(i=>clearInterval(i));
        intervals=[];
    }
    //----------------------------
    // PLAYER HOOKS
    //----------------------------
    player.on('play', () => {
        resetDistortion();
        audioCtx.resume();
        trackSource = audioCtx.createMediaElementSource(player.audio.audio);
        trackSource.connect(audioCtx.destination);
        distortionTimer = setTimeout(()=>{ activateDistortionMode(); }, 30000);
    });
    player.on('pause', resetDistortion);
    player.on('ended', resetDistortion);
    player.on('listswitch', resetDistortion);
}
loadPlaylist();
</script>
</body>
</html>
loadPlaylist();
</script>

</body>
</html>
