<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before Us Universe — Chat Servers</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #001a1a;
        --fg: #00ffff;
        --accent: #ffcc00;
        --border: #00cccc;
        --panel-bg: #002b2b;
        --text-gray: #e6f7f7;
        --muted: #00aaaa;
        --online: #00ff9d;
        --yahoo-blue: #1e73be;
        --yahoo-dark: #0961a6;
    }
    body { 
        font-family: 'Roboto Mono', monospace; 
        background: var(--bg); 
        color: var(--fg); 
        margin: 0; 
        padding: 0; 
    }
    .panel {
        background: var(--panel-bg);
        border: 3px solid var(--border);
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .panel-title {
        padding: 6px;
        background: linear-gradient(90deg, var(--yahoo-blue), var(--yahoo-dark));
        color: #fff;
        font-family: 'Press Start 2P';
        font-size: 12px;
    }
    .panel-body {
        padding: 8px;
        color: var(--text-gray);
    }
    .chat-win {
        display: flex;
        flex-direction: column;
        height: 520px;
    }
    @media (max-width: 600px) {
        .chat-win { height: 400px; }
    }
    .chat-main {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .chat-messages {
        flex: 1;
        overflow: auto;
        background: #e6e6fa;
        border-right: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        color: #000;
    }
    .chat-users {
        background: #fffacd;
        border-left: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        overflow: auto;
        width: 200px;
        flex-shrink: 0;
    }
    .chat-row {
        display: flex;
        gap: 8px;
        margin: 6px 0;
        align-items: flex-start;
    }
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #add8e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 12px;
        color: #001a1a;
        flex-shrink: 0;
    }
    .chat-bubble {
        max-width: 78%;
        padding: 10px;
        border-radius: 8px;
        background: #e6e6fa;
        border: 1px solid rgba(0,0,0,0.1);
        font-family: Arial;
        color: #000;
    }
    .chat-bubble.me {
        background: #fffacd;
        border: 1px solid #f0d280;
        text-align: right;
        color: #222;
    }
    .chat-meta {
        font-size: 11px;
        color: #808080;
        font-weight: 700;
        margin-bottom: 4px;
    }
    .user-row {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px 4px;
        font-size: 12px;
    }
    .status-dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--online);
    }
    .uname {
        font-family: 'Press Start 2P';
        color: #ff0000;
        font-size: 12px;
    }
    .chat-controls {
        display: flex;
        gap: 6px;
        padding: 8px;
        background: #fffacd;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    .chat-controls input {
        flex: 1;
        padding: 8px;
        border: 2px inset rgba(0,0,0,0.1);
        background: #fff;
        color: #000;
    }
    .chat-controls button {
        padding: 8px 16px;
        border: 2px outset rgba(0,0,0,0.1);
        background: #add8e6;
        cursor: pointer;
        color: #000;
        font-weight: bold;
    }
    .typing-indicator {
        font-size: 12px;
        color: var(--muted);
        padding: 6px 8px;
        font-style: italic;
        min-height: 24px;
    }
    .small {
        font-size: 11px;
        color: var(--muted);
    }
</style>
</head>
<body>

<div id="serverSelectPanel" class="panel" style="display:none;"> <!-- hidden until needed, but kept if you want manual switch -->
    <div class="small">SELECT SERVER (auto-selected from boot)</div>
    <div class="controls">
        <select id="channelSelect">
            <option value="sam">//Sam</option>
            <option value="exuro">//Exuro</option>
            <option value="nero">//Nero</option>
            <option value="nora">//Nora</option>
            <option value="loktal">//Loktal</option>
        </select>
        <button id="serverConfirm">Switch</button>
    </div>
</div>

<div class="panel">
    <div class="panel-title">
        //<span id="channelName">LOADING...</span> <span class="small" id="userCountSmall">0 users</span>
    </div>
    <div class="panel-body chat-win">
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-users">
                <div class="small" style="margin-bottom:6px">USERS ONLINE</div>
                <div id="activeUsersList"></div>
            </div>
        </div>
        <div id="typingIndicator" class="typing-indicator"></div>
        <div class="chat-controls">
            <input id="chatInput" placeholder="Waiting for boot data..." disabled>
            <button id="sendBtn" disabled>SEND</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const serverConfirm = document.getElementById('serverConfirm');
const userCountSmall = document.getElementById('userCountSmall');
const activeUsersList = document.getElementById('activeUsersList');
const channelName = document.getElementById('channelName');
const typingIndicator = document.getElementById('typingIndicator');

let uid = null;
let username = null;
let currentChannel = null;
let presenceRef = null;
let isTyping = false; // tracks local typing state to prevent unnecessary DB writes

window.parent.postMessage({ type: 'requestUserData' }, '*');

window.addEventListener('message', (event) => {
    if (event.data.type === 'userData') {
        username = event.data.handle?.trim() || null;
        uid = event.data.uid;
        currentChannel = event.data.channel?.trim() || 'sam';

        if (!username) {
            channelName.textContent = 'NO HANDLE';
            chatInput.placeholder = "Set handle on boot page";
            return;
        }

        channelName.textContent = currentChannel.toUpperCase();
        channelSelect.value = currentChannel;

        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.placeholder = "Say something...";

        initializeChat();
    }
});

function initializeChat() {
    setPresence();
    listenMessages();
    watchOnline();
}

function setPresence() {
    if (presenceRef) remove(presenceRef);
    presenceRef = ref(db, `online/${currentChannel}/${uid}`);
    const payload = { name: username, ts: Date.now(), uid, typing: false };
    set(presenceRef, payload);
    onDisconnect(presenceRef).remove();
}

function watchOnline() {
    const onlineRef = ref(db, `online/${currentChannel}`);
    onValue(onlineRef, snap => {
        const data = snap.val() || {};
        const users = Object.values(data);
        users.sort((a, b) => a.name.localeCompare(b.name));

        activeUsersList.innerHTML = '';
        users.forEach(u => {
            const row = document.createElement('div');
            row.className = 'user-row';
            row.innerHTML = `<div class="status-dot"></div><div class="uname">${esc(u.name)}</div>`;
            activeUsersList.appendChild(row);
        });

        const count = users.length;
        userCountSmall.textContent = `${count} ${count === 1 ? 'user' : 'users'}`;

        // Typing indicator - stable as long as someone has text in their box
        const typingUsers = users.filter(u => u.typing && u.uid !== uid).map(u => u.name);
        if (typingUsers.length > 0) {
            typingIndicator.textContent = typingUsers.length === 1 
                ? `${typingUsers[0]} is typing...`
                : `${typingUsers.slice(0,3).join(', ')}${typingUsers.length > 3 ? ' and others' : ''} are typing...`;
        } else {
            typingIndicator.textContent = '';
        }
    });
}

function listenMessages() {
    const chatRef = ref(db, `chat/${currentChannel}`);
    onValue(chatRef, snap => {
        chatMessages.innerHTML = '';
        const data = snap.val() || {};
        Object.values(data)
            .sort((a, b) => a.ts - b.ts)
            .forEach(msg => renderMessage(msg));
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

function renderMessage(o) {
    const row = document.createElement('div');
    row.className = 'chat-row';
    const avatar = document.createElement('div');
    avatar.className = 'chat-avatar';
    avatar.textContent = (o.name || '?').slice(0,2).toUpperCase();
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';
    if (o.uid === uid) bubble.classList.add('me');
    bubble.innerHTML = `<div class="chat-meta">${esc(o.name)} · ${new Date(o.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>${esc(o.msg)}`;
    row.appendChild(avatar);
    row.appendChild(bubble);
    chatMessages.appendChild(row);
}

function esc(s) {
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

chatInput.addEventListener('input', () => {
    const hasText = chatInput.value.trim() !== '';
    if (hasText !== isTyping) {
        update(ref(db, `online/${currentChannel}/${uid}`), { typing: hasText });
        isTyping = hasText;
    }
});

sendBtn.addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if (!msg || !username) return;
    push(ref(db, `chat/${currentChannel}`), {
        name: username,
        msg,
        ts: Date.now(),
        uid
    });
    chatInput.value = '';
    if (isTyping) {
        update(ref(db, `online/${currentChannel}/${uid}`), { typing: false });
        isTyping = false;
    }
});

chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
    }
});

serverConfirm.addEventListener('click', () => {
    const newCh = channelSelect.value;
    if (newCh === currentChannel) return;
    if (presenceRef) remove(presenceRef);
    currentChannel = newCh;
    channelName.textContent = currentChannel.toUpperCase();
    initializeChat();
});

// Fallback for direct access
if (window.BUU && window.BUU.myHandle && window.dispatchEvent(new MessageEvent('message', {data: {type: 'userData', handle: window.BUU.myHandle, uid: window.BUU.uid, channel: window.BUU.currentChannel || 'sam'}}));

signInAnonymously(auth).catch(() => {});
</script>
</body>
</html>
