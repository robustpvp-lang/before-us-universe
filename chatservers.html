<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before Us Universe — Chat Servers</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #001a1a;
        --fg: #00ffff;
        --accent: #ffcc00;
        --border: #00cccc;
        --panel-bg: #002b2b;
        --text-gray: #e6f7f7;
        --muted: #00aaaa;
        --online: #00ff9d;
        --yahoo-blue: #1e73be;
        --yahoo-dark: #0961a6;
    }
    body { 
        font-family: 'Roboto Mono', monospace; 
        background: var(--bg); 
        color: var(--fg); 
        margin: 0; 
        padding: 0; 
    }
    #bootOverlay {
        position: fixed;
        inset: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.95));
        color: var(--fg);
        z-index: 99998;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-family: 'Roboto Mono', monospace;
    }
    #bootPanel {
        width: 92%;
        max-width: 820px;
        background: var(--panel-bg);
        border: 4px solid var(--border);
        padding: 18px;
        box-shadow: 0 0 30px rgba(0,255,255,0.06);
    }
    #bootLog {
        line-height: 1.6;
        white-space: pre-wrap;
        margin-bottom: 12px;
        font-size: 13px;
        color: var(--text-gray);
    }
    #bootPrompt {
        color: var(--accent);
        margin-bottom: 6px;
        animation: blink 1s step-end infinite;
    }
    @keyframes blink {
        50% { opacity: 0; }
    }
    #bootInputs {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }
    #bootInput {
        background: #001f1f;
        border: 2px solid var(--border);
        color: var(--fg);
        padding: 8px;
        width: 48%;
        min-width: 160px;
        font-family: monospace;
    }
    #bootChannel {
        background: #001f1f;
        border: 2px solid var(--border);
        color: var(--fg);
        padding: 8px;
        font-family: monospace;
        width: 48%;
        min-width: 160px;
    }
    #bootBtn {
        background: var(--accent);
        border: 2px solid #000;
        color: #000;
        padding: 8px 14px;
        cursor: pointer;
        font-weight: 700;
    }
    #bootStatus {
        margin-top: 8px;
        color: var(--accent);
    }
    #app {
        display: none;
        padding: 20px;
    }
    .panel {
        background: var(--panel-bg);
        border: 3px solid var(--border);
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .panel-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px;
        background: linear-gradient(90deg, var(--yahoo-blue), var(--yahoo-dark));
        color: #fff;
        font-family: 'Press Start 2P';
        font-size: 12px;
    }
    .panel-body {
        padding: 8px;
        color: var(--text-gray);
    }
    #serverSelectPanel {
        margin-bottom: 12px;
        padding: 8px;
    }
    #serverSelectPanel .controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    #serverSelectPanel select {
        flex: 1;
        padding: 12px;
        background: #001f1f;
        border: 3px solid var(--border);
        color: var(--fg);
        font-weight: 700;
        font-size: 14px;
        border-radius: 6px;
    }
    #serverConfirm {
        background: var(--accent);
        color: #000;
        padding: 10px;
        border: 3px solid #000;
        cursor: pointer;
        font-weight: 900;
        border-radius: 6px;
        font-size: 14px;
        box-shadow: 0 0 10px var(--accent);
    }
    .chat-win {
        display: flex;
        flex-direction: column;
        height: 520px;
    }
    @media (max-width: 600px) {
        .chat-win { height: 400px; }
    }
    .chat-main {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .chat-messages {
        flex: 1;
        overflow: auto;
        background: #e6e6fa;
        border-right: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        color: #000;
    }
    .chat-users {
        background: #fffacd;
        border-left: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        overflow: auto;
        width: 200px;
    }
    @media (max-width: 700px) {
        .chat-main { flex-direction: column; }
        .chat-users { width: auto; border-left: 0; border-top: 1px solid rgba(0,0,0,0.1); }
    }
    .chat-row {
        display: flex;
        gap: 8px;
        margin: 6px 0;
        align-items: flex-start;
    }
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #add8e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 12px;
        color: #001a1a;
    }
    @media (max-width: 600px) {
        .chat-avatar { width: 24px; height: 24px; font-size: 10px; }
    }
    .chat-bubble {
        max-width: 78%;
        padding: 10px;
        border-radius: 8px;
        background: #e6e6fa;
        border: 1px solid rgba(0,0,0,0.1);
        font-family: Arial;
        color: #000;
    }
    .chat-bubble.me {
        background: #fffacd;
        border: 1px solid #f0d280;
        text-align: right;
        color: #222;
    }
    .chat-meta {
        font-size: 11px;
        color: #808080;
        font-weight: 700;
        margin-bottom: 4px;
    }
    @media (max-width: 600px) {
        .chat-meta { font-size: 9px; }
    }
    .user-row {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px;
        font-size: 12px;
        cursor: pointer;
    }
    @media (max-width: 600px) {
        .user-row { font-size: 10px; }
    }
    .status-dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--online);
    }
    .uname {
        font-family: 'Press Start 2P';
        color: #ff0000;
        font-size: 12px;
    }
    @media (max-width: 600px) {
        .uname { font-size: 10px; }
    }
    .chat-controls {
        display: flex;
        gap: 6px;
        padding: 8px;
        background: #fffacd;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    .chat-controls input {
        flex: 1;
        padding: 8px;
        border: 2px inset rgba(0,0,0,0.1);
        background: #fff;
        color: #000;
    }
    .chat-controls button {
        padding: 8px;
        border: 2px outset rgba(0,0,0,0.1);
        background: #add8e6;
        cursor: pointer;
        color: #000;
    }
    .typing-indicator {
        font-size: 12px;
        color: var(--muted);
        padding: 6px;
        font-style: italic;
    }
    #serverTrackingPanel .server-branch {
        margin-bottom: 12px;
    }
    #serverTrackingPanel .server-title {
        font-weight: 700;
        color: var(--accent);
        font-size: 13px;
        cursor: pointer;
    }
    #serverTrackingPanel .user-list {
        margin-left: 12px;
        margin-top: 4px;
        font-size: 12px;
    }
    #serverTrackingPanel .user-list div {
        margin: 2px 0;
        padding: 6px;
        background: #001f1f;
        border-radius: 4px;
        cursor: pointer;
    }
    #serverTrackingPanel .current-server .server-title {
        color: #000;
        background: var(--accent);
        padding: 6px;
        border-radius: 4px;
    }
    .server-title .status-icon {
        margin-left: 5px;
        font-size: 14px;
    }
    .status-icon.animated {
        animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    .small {
        font-size: 11px;
        color: var(--muted);
    }
</style>
</head>
<body>
<div id="bootOverlay">
    <div id="bootPanel">
        <div id="bootLog" class="small"></div>
        <div id="bootPrompt">> ENTER HANDLE & SELECT SERVER</div>
        <div id="bootInputs">
            <input id="bootInput" type="text" maxlength="30" placeholder="//YourHandle (required)" aria-label="Enter your handle">
            <select id="bootChannel" aria-label="Select server">
                <option value="sam">//Sam</option>
                <option value="exuro">//Exuro</option>
                <option value="nero">//Nero</option>
                <option value="nora">//Nora</option>
                <option value="loktal">//Loktal</option>
            </select>
            <button id="bootBtn" aria-label="Enter Network">ENTER NETWORK</button>
        </div>
        <div id="bootStatus" class="small" style="margin-top:8px;color:var(--accent)"></div>
    </div>
</div>
<div id="app">
    <div id="serverSelectPanel" class="panel">
        <div class="small">SELECT SERVER</div>
        <div class="controls">
            <select id="channelSelect" aria-label="Choose server">
                <option value="sam">//Sam</option>
                <option value="exuro">//Exuro</option>
                <option value="nero">//Nero</option>
                <option value="nora">//Nora</option>
                <option value="loktal">//Loktal</option>
            </select>
            <button id="serverConfirm" aria-label="Switch server">Switch Server</button>
        </div>
    </div>
    <div class="panel">
        <div class="panel-title"><div class="title" id="chatTitle">//SAM <span class="small" id="userCountSmall">0 users</span></div></div>
        <div class="panel-body chat-win" id="chatBody">
            <div class="chat-main">
                <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
                <div class="chat-users">
                    <div class="small" style="margin-bottom:6px">USERS ONLINE</div>
                    <div id="activeUsersList"></div>
                </div>
            </div>
            <div id="typingIndicator" class="typing-indicator"></div>
            <div class="chat-controls">
                <input id="chatInput" placeholder="Say something..." maxlength="500" autocomplete="off" aria-label="Chat input">
                <button id="sendBtn" aria-label="Send message">SEND</button>
            </div>
        </div>
    </div>
    <div class="panel" id="serverTrackingPanel">
        <div class="panel-title"><div class="small">SERVER LIST</div></div>
        <div class="panel-body" id="serverTrackingList" style="height:auto;min-height:150px;"></div>
    </div>
</div>
<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove, onDisconnect, update, get, off, onChildRemoved, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.firebasestorage.app",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const bootOverlay = document.getElementById('bootOverlay');
const bootLog = document.getElementById('bootLog');
const bootInput = document.getElementById('bootInput');
const bootBtn = document.getElementById('bootBtn');
const bootStatus = document.getElementById('bootStatus');
const bootChannel = document.getElementById('bootChannel');
const appRoot = document.getElementById('app');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const serverConfirm = document.getElementById('serverConfirm');
const userCountSmall = document.getElementById('userCountSmall');
const activeUsersList = document.getElementById('activeUsersList');
const serverTrackingList = document.getElementById('serverTrackingList');
const chatTitle = document.getElementById('chatTitle');

let uid = null, myHandle = null, currentChannel = 'sam', presenceRef = null;
let channelListeners = {};
let typingTimeout = null;

const bootLines = [
    "C:\\> INITIALIZING BEFORE US UNIVERSE...",
    "C:\\> Loading kernel.............[ONLINE]",
    "C:\\> Checking Ra'Norric link....[ONLINE]",
    "C:\\> MEMORY CHECK PASSED",
    "C:\\> DISK VERIFIED",
    "C:\\> NETWORK ACTIVE",
    "C:\\> System is .....[ONLINE]",
    "C:\\> Ready for authentication..."
];
let lineIdx = 0;
function typeBootLine() {
    if (lineIdx < bootLines.length) {
        bootLog.textContent += bootLines[lineIdx] + "\n";
        lineIdx++;
        setTimeout(typeBootLine, 240 + Math.random() * 360);
    }
}
typeBootLine();

onAuthStateChanged(auth, u => { if (u) uid = u.uid; });

function setPresence(h, ch) {
    if (presenceRef) remove(presenceRef);
    presenceRef = ref(db, `online/${ch}/${uid}`);
    set(presenceRef, { name: h, ts: Date.now(), uid, typing: false });
    onDisconnect(presenceRef).remove();
}

let onlineWatchRef = ref(db, 'online');
function watchOnline() {
    onValue(onlineWatchRef, snap => {
        const data = snap.val() || {};
        renderServerTracking(data);
        renderActiveUsers(data[currentChannel] || {});
        updateUserCount(data[currentChannel] || {});
        updateTypingIndicator(data[currentChannel] || {});
    });
}

function renderServerTracking(data) {
    serverTrackingList.innerHTML = '';
    const channels = ['sam', 'exuro', 'nero', 'nora', 'loktal'];
    channels.forEach(ch => {
        const users = Object.values(data[ch] || {}).filter(u => u.name);
        const count = users.length;
        const iconColor = count > 0 ? 'lime' : 'red';
        const branch = document.createElement('div');
        branch.className = `server-branch ${ch === currentChannel ? 'current-server' : ''}`;
        branch.innerHTML = `<div class="server-title">//${ch.toUpperCase()} (${count}) <span class="status-icon ${count > 0 ? 'animated' : ''}" style="color:${iconColor}">●</span></div><div class="user-list"></div>`;
        const userList = branch.querySelector('.user-list');
        if (count === 0) {
            userList.innerHTML = '<div>—</div>';
        } else {
            users.forEach(u => {
                const div = document.createElement('div');
                div.textContent = u.name + (u.typing ? ' (typing...)' : '');
                userList.appendChild(div);
            });
        }
        serverTrackingList.appendChild(branch);
    });
}

function renderActiveUsers(data) {
    activeUsersList.innerHTML = '';
    Object.values(data).forEach(u => {
        const row = document.createElement('div');
        row.className = 'user-row';
        const dot = document.createElement('div');
        dot.className = 'status-dot';
        const name = document.createElement('div');
        name.className = 'uname';
        name.textContent = u.name;
        row.appendChild(dot);
        row.appendChild(name);
        activeUsersList.appendChild(row);
    });
}

function updateUserCount(data) {
    const count = Object.keys(data).length;
    userCountSmall.textContent = `${count} users`;
    chatTitle.innerHTML = `//${currentChannel.toUpperCase()} <span class="small" id="userCountSmall">${count} users</span>`;
}

function updateTypingIndicator(data) {
    const typingUsers = Object.values(data).filter(u => u.typing && u.uid !== uid).map(u => u.name);
    const indicator = document.getElementById('typingIndicator');
    if (typingUsers.length > 0) {
        indicator.textContent = `${typingUsers.join(', ')} ${typingUsers.length > 1 ? 'are' : 'is'} typing...`;
    } else {
        indicator.textContent = '';
    }
}

function listenChannel(ch) {
    if (channelListeners.ref) off(channelListeners.ref);
    currentChannel = ch;
    chatMessages.innerHTML = '';
    const chatRef = ref(db, `chat/${ch}`);
    const q = query(chatRef, orderByChild('ts'));
    onChildAdded(q, snap => {
        const o = snap.val();
        if (o) renderChatMessage(o);
    });
    channelListeners = { ref: chatRef };
    channelSelect.value = ch;
    setPresence(myHandle, ch);
}

function renderChatMessage(o) {
    const row = document.createElement('div');
    row.className = 'chat-row';
    const avatar = document.createElement('div');
    avatar.className = 'chat-avatar';
    avatar.textContent = (o.name || 'A').slice(0, 2).toUpperCase();
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';
    if (o.uid === uid) bubble.classList.add('me');
    bubble.innerHTML = `<div class="chat-meta">${o.name || 'Anonymous'} · ${new Date(o.ts).toLocaleTimeString()}</div>${esc(o.msg)}`;
    row.appendChild(avatar);
    row.appendChild(bubble);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function esc(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

signInAnonymously(auth);

bootBtn.addEventListener('click', () => {
    const handle = bootInput.value.trim();
    if (!handle) {
        bootStatus.textContent = 'Enter a handle.';
        return;
    }
    myHandle = handle;
    currentChannel = bootChannel.value;
    bootStatus.textContent = 'Connecting...';
    setTimeout(() => {
        bootOverlay.style.display = 'none';
        appRoot.style.display = 'block';
        setPresence(myHandle, currentChannel);
        listenChannel(currentChannel);
        watchOnline();
    }, 1000);
});

sendBtn.addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if (msg) {
        push(ref(db, `chat/${currentChannel}`), { name: myHandle, msg, ts: Date.now(), uid });
        chatInput.value = '';
    }
});

chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
});

chatInput.addEventListener('input', () => {
    const typing = chatInput.value.trim() !== '';
    update(ref(db, `online/${currentChannel}/${uid}`), { typing });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => update(ref(db, `online/${currentChannel}/${uid}`), { typing: false }), 2000);
});

serverConfirm.addEventListener('click', () => {
    const newCh = channelSelect.value;
    if (newCh !== currentChannel) {
        currentChannel = newCh;
        listenChannel(newCh);
    }
});
</script>
</body>
</html>
