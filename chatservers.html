<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before Us Universe â€” BUU Chat Servers</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Roboto Mono', monospace;
    background: #000;
    color: #0f0;
  }
  .server-list { max-width: 300px; float: left; padding: 10px; }
  .server { border-bottom: 1px solid #0f0; cursor: pointer; padding: 5px; }
  .server.active { background: #0a0; }
  .users { margin-left: 10px; font-size: 0.9em; }
  .dm-panel { float: right; width: calc(100% - 320px); padding: 10px; }
  .marquee { width: 100%; overflow: hidden; white-space: nowrap; border-top: 1px solid #0f0; border-bottom: 1px solid #0f0; padding: 5px 0; }
  .marquee span { display: inline-block; padding-right: 50px; animation: scroll 20s linear infinite; }
  @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

  /* Pop-out DM window */
  .dm-window {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 250px;
    background: #010;
    border: 1px solid #0f0;
    font-size: 0.8em;
    display: flex;
    flex-direction: column;
    margin-left: 5px;
    z-index: 1000;
  }
  .dm-header { background: #0a0; padding: 2px 5px; cursor: move; }
  .dm-messages { flex: 1; padding: 5px; overflow-y: auto; max-height: 150px; }
  .dm-input { border-top: 1px solid #0f0; padding: 2px; }
  .dm-input input { width: 100%; background: #000; color: #0f0; border: none; padding: 2px; }
</style>
</head>
<body>

<div class="server-list" id="serverList"></div>

<div class="dm-panel">
  <div class="marquee" id="feedMarquee"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, onValue, set, push, update, onChildAdded } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

const firebaseConfig = { /* your config here */ };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentChannel = null;
const uid = prompt("Enter your handle:");
const openDMs = {};

const servers = ["RobustPVP", "GalacticHub", "TimeStream"];
const serverRefs = servers.reduce((acc, name) => {
  acc[name] = ref(db, `online/${name}`);
  return acc;
}, {});

function renderServers() {
  const list = document.getElementById("serverList");
  list.innerHTML = "";
  servers.forEach(server => {
    const div = document.createElement("div");
    div.className = "server" + (server === currentChannel ? " active" : "");
    div.textContent = server;
    const usersDiv = document.createElement("div");
    usersDiv.className = "users";
    usersDiv.textContent = "Loading...";
    div.appendChild(usersDiv);

    div.onclick = () => joinChannel(server);

    // Listen for online changes dynamically
    onValue(serverRefs[server], snap => {
      const data = snap.val() || {};
      const count = Object.keys(data).length;
      const typingUsers = Object.entries(data).filter(([k,v])=>v.typing).map(([k])=>k);
      usersDiv.textContent = `Users: ${count}` + (typingUsers.length ? ` | Typing: ${typingUsers.join(", ")}` : "");

      // Show pop-out DM triggers
      usersDiv.innerHTML = Object.keys(data)
        .filter(user => user !== uid)
        .map(user => `<span style="cursor:pointer;" onclick="openDM('${user}')">${user}</span>`)
        .join(" | ");
    });

    list.appendChild(div);
  });
}

function joinChannel(channel) {
  if(currentChannel) leaveChannel(currentChannel);
  currentChannel = channel;
  set(ref(db, `online/${channel}/${uid}`), { typing: false });
  renderServers();
}

function leaveChannel(channel) {
  update(ref(db, `online/${channel}/${uid}`), { typing: null });
}

// Marquee feed
function renderFeed(message) {
  const feed = document.getElementById("feedMarquee");
  const span = document.createElement("span");
  span.textContent = message;
  feed.appendChild(span);
  if(feed.childNodes.length > 8) feed.removeChild(feed.firstChild);
}

// DM pop-out window
window.openDM = function(user) {
  if(openDMs[user]) return;

  const dmWin = document.createElement("div");
  dmWin.className = "dm-window";
  dmWin.style.right = `${10 + Object.keys(openDMs).length * 260}px`;

  const header = document.createElement("div");
  header.className = "dm-header";
  header.textContent = user + " (DM)";
  dmWin.appendChild(header);

  const messages = document.createElement("div");
  messages.className = "dm-messages";
  dmWin.appendChild(messages);

  const inputDiv = document.createElement("div");
  inputDiv.className = "dm-input";
  const input = document.createElement("input");
  input.placeholder = "Type message...";
  inputDiv.appendChild(input);
  dmWin.appendChild(inputDiv);

  document.body.appendChild(dmWin);
  openDMs[user] = { dmWin, messages, input };

  // Send messages on enter
  input.addEventListener("keypress", e => {
    if(e.key === "Enter" && input.value.trim()) {
      const msg = input.value.trim();
      push(ref(db, `dm/${uid}/${user}`), { from: uid, text: msg, timestamp: Date.now() });
      input.value = "";
    }
  });

  // Listen for incoming messages
  const dmRef = ref(db, `dm/${user}/${uid}`);
  onChildAdded(dmRef, snap => {
    const data = snap.val();
    const div = document.createElement("div");
    div.textContent = `[${data.from}] ${data.text}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
};

// Feed listener
const feedRef = ref(db, "feed");
onChildAdded(feedRef, snap => renderFeed(snap.val()));

// Initialize
renderServers();
window.addEventListener("beforeunload", () => { if(currentChannel) leaveChannel(currentChannel); });
</script>
</body>
</html>
