<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before Us Universe — Chat Servers</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #001a1a;
        --fg: #00ffff;
        --accent: #ffcc00;
        --border: #00cccc;
        --panel-bg: #002b2b;
        --text-gray: #e6f7f7;
        --muted: #00aaaa;
        --online: #00ff9d;
        --yahoo-blue: #1e73be;
        --yahoo-dark: #0961a6;
    }
    body { 
        font-family: 'Roboto Mono', monospace; 
        background: var(--bg); 
        color: var(--fg); 
        margin: 0; 
        padding: 0; 
    }
    .panel {
        background: var(--panel-bg);
        border: 3px solid var(--border);
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .panel-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px;
        background: linear-gradient(90deg, var(--yahoo-blue), var(--yahoo-dark));
        color: #fff;
        font-family: 'Press Start 2P';
        font-size: 12px;
    }
    .panel-body {
        padding: 8px;
        color: var(--text-gray);
    }
    #serverSelectPanel {
        margin-bottom: 12px;
        padding: 8px;
    }
    #serverSelectPanel .controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    #serverSelectPanel select {
        flex: 1;
        padding: 12px;
        background: #001f1f;
        border: 3px solid var(--border);
        color: var(--fg);
        font-weight: 700;
        font-size: 14px;
        border-radius: 6px;
    }
    #serverConfirm {
        background: var(--accent);
        color: #000;
        padding: 10px;
        border: 3px solid #000;
        cursor: pointer;
        font-weight: 900;
        border-radius: 6px;
        font-size: 14px;
        box-shadow: 0 0 10px var(--accent);
    }
    .chat-win {
        display: flex;
        flex-direction: column;
        height: 520px;
    }
    @media (max-width: 600px) {
        .chat-win { height: 400px; }
    }
    .chat-main {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .chat-messages {
        flex: 1;
        overflow: auto;
        background: #e6e6fa;
        border-right: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        color: #000;
    }
    .chat-users {
        background: #fffacd;
        border-left: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        overflow: auto;
        width: 200px;
    }
    @media (max-width: 700px) {
        .chat-main { flex-direction: column; }
        .chat-users { width: auto; border-left: 0; border-top: 1px solid rgba(0,0,0,0.1); }
    }
    .chat-row {
        display: flex;
        gap: 8px;
        margin: 6px 0;
        align-items: flex-start;
    }
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #add8e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 12px;
        color: #001a1a;
    }
    @media (max-width: 600px) {
        .chat-avatar { width: 24px; height: 24px; font-size: 10px; }
    }
    .chat-bubble {
        max-width: 78%;
        padding: 10px;
        border-radius: 8px;
        background: #e6e6fa;
        border: 1px solid rgba(0,0,0,0.1);
        font-family: Arial;
        color: #000;
    }
    .chat-bubble.me {
        background: #fffacd;
        border: 1px solid #f0d280;
        text-align: right;
        color: #222;
    }
    .chat-meta {
        font-size: 11px;
        color: #808080;
        font-weight: 700;
        margin-bottom: 4px;
    }
    @media (max-width: 600px) {
        .chat-meta { font-size: 9px; }
    }
    .user-row {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px;
        font-size: 12px;
        cursor: pointer;
    }
    @media (max-width: 600px) {
        .user-row { font-size: 10px; }
    }
    .status-dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--online);
    }
    .uname {
        font-family: 'Press Start 2P';
        color: #ff0000;
        font-size: 12px;
    }
    @media (max-width: 600px) {
        .uname { font-size: 10px; }
    }
    .chat-controls {
        display: flex;
        gap: 6px;
        padding: 8px;
        background: #fffacd;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    .chat-controls input {
        flex: 1;
        padding: 8px;
        border: 2px inset rgba(0,0,0,0.1);
        background: #fff;
        color: #000;
    }
    .chat-controls button {
        padding: 8px;
        border: 2px outset rgba(0,0,0,0.1);
        background: #add8e6;
        cursor: pointer;
        color: #000;
    }
    .typing-indicator {
        font-size: 12px;
        color: var(--muted);
        padding: 6px;
        font-style: italic;
    }
    .small {
        font-size: 11px;
        color: var(--muted);
    }
</style>
</head>
<body>
<div id="serverSelectPanel" class="panel">
    <div class="small">SELECT SERVER</div>
    <div class="controls">
        <select id="channelSelect" aria-label="Choose server">
            <option value="sam">//Sam</option>
            <option value="exuro">//Exuro</option>
            <option value="nero">//Nero</option>
            <option value="nora">//Nora</option>
            <option value="loktal">//Loktal</option>
        </select>
        <button id="serverConfirm" aria-label="Switch server">Switch Server</button>
    </div>
</div>
<div class="panel">
    <div class="panel-title"><div class="title" id="chatTitle">//SAM <span class="small" id="userCountSmall">0 users</span></div></div>
    <div class="panel-body chat-win" id="chatBody">
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
            <div class="chat-users">
                <div class="small" style="margin-bottom:6px">USERS ONLINE</div>
                <div id="activeUsersList"></div>
            </div>
        </div>
        <div id="typingIndicator" class="typing-indicator"></div>
        <div class="chat-controls">
            <input id="chatInput" placeholder="Say something..." maxlength="500" autocomplete="off" aria-label="Chat input">
            <button id="sendBtn" aria-label="Send message">SEND</button>
        </div>
    </div>
</div>
<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove, onDisconnect, update, get, off, onChildRemoved, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.firebasestorage.app",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const serverConfirm = document.getElementById('serverConfirm');
const userCountSmall = document.getElementById('userCountSmall');
const activeUsersList = document.getElementById('activeUsersList');
const chatTitle = document.getElementById('chatTitle');

let uid = null, username = null, currentChannel = null, presenceRef = null;
let channelListeners = {};
let typingTimeout = null;

// Request user data from parent (main index)
window.parent.postMessage({ type: 'requestUserData' }, '*');

// Listen for user data from parent
window.addEventListener('message', (event) => {
    if (event.data.type === 'userData') {
        username = event.data.handle;
        uid = event.data.uid;
        currentChannel = event.data.channel;
        initializeChat();
    }
});

onAuthStateChanged(auth, u => { if (u) uid = u.uid; });

function initializeChat() {
    if (!username || !currentChannel) return;
    setPresence(username, currentChannel);
    listenChannel(currentChannel);
    watchOnline();
}

function setPresence(h, ch) {
    if (presenceRef) remove(presenceRef);
    presenceRef = ref(db, `online/${ch}/${uid}`);
    set(presenceRef, { name: h, ts: Date.now(), uid, typing: false });
    onDisconnect(presenceRef).remove();
}

let onlineWatchRef = ref(db, 'online');
function watchOnline() {
    onValue(onlineWatchRef, snap => {
        const data = snap.val() || {};
        renderActiveUsers(data[currentChannel] || {});
        updateUserCount(data[currentChannel] || {});
        updateTypingIndicator(data[currentChannel] || {});
    });
}

function renderActiveUsers(data) {
    activeUsersList.innerHTML = '';
    Object.values(data).forEach(u => {
        const row = document.createElement('div');
        row.className = 'user-row';
        const dot = document.createElement('div');
        dot.className = 'status-dot';
        const name = document.createElement('div');
        name.className = 'uname';
        name.textContent = u.name;
        row.appendChild(dot);
        row.appendChild(name);
        activeUsersList.appendChild(row);
    });
}

function updateUserCount(data) {
    const count = Object.keys(data).length;
    userCountSmall.textContent = `${count} users`;
    chatTitle.innerHTML = `//${currentChannel.toUpperCase()} <span class="small" id="userCountSmall">${count} users</span>`;
}

function updateTypingIndicator(data) {
    const typingUsers = Object.values(data).filter(u => u.typing && u.uid !== uid).map(u => u.name);
    const indicator = document.getElementById('typingIndicator');
    if (typingUsers.length > 0) {
        indicator.textContent = `${typingUsers.join(', ')} ${typingUsers.length > 1 ? 'are' : 'is'} typing...`;
    } else {
        indicator.textContent = '';
    }
}

function listenChannel(ch) {
    if (channelListeners.ref) off(channelListeners.ref);
    currentChannel = ch;
    chatMessages.innerHTML = '';
    const chatRef = ref(db, `chat/${ch}`);
    const q = query(chatRef, orderByChild('ts'));
    onChildAdded(q, snap => {
        const o = snap.val();
        if (o) renderChatMessage(o);
    });
    channelListeners = { ref: chatRef };
    channelSelect.value = ch;
    setPresence(username, ch);
}

function renderChatMessage(o) {
    const row = document.createElement('div');
    row.className = 'chat-row';
    const avatar = document.createElement('div');
    avatar.className = 'chat-avatar';
    avatar.textContent = (o.name || 'A').slice(0, 2).toUpperCase();
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';
    if (o.uid === uid) bubble.classList.add('me');
    bubble.innerHTML = `<div class="chat-meta">${o.name || 'Anonymous'} · ${new Date(o.ts).toLocaleTimeString()}</div>${esc(o.msg)}`;
    row.appendChild(avatar);
    row.appendChild(bubble);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function esc(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

signInAnonymously(auth);

sendBtn.addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if (msg) {
        push(ref(db, `chat/${currentChannel}`), { name: username, msg, ts: Date.now(), uid });
        chatInput.value = '';
    }
});

chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
});

chatInput.addEventListener('input', () => {
    const typing = chatInput.value.trim() !== '';
    update(ref(db, `online/${currentChannel}/${uid}`), { typing });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => update(ref(db, `online/${currentChannel}/${uid}`), { typing: false }), 2000);
});

serverConfirm.addEventListener('click', () => {
    const newCh = channelSelect.value;
    if (newCh !== currentChannel) {
        currentChannel = newCh;
        listenChannel(newCh);
    }
});
</script>
</body>
</html>
