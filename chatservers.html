<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BUU — Chatroom</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#001a1a; --fg:#00ffff; --accent:#ffcc00; --border:#00cccc; --panel-bg:#002b2b;
  --text-gray:#e6f7f7; --muted:#00aaaa; --online:#00ff9d; --yahoo-blue:#1e73be; --yahoo-dark:#0961a6;
}
html,body{margin:0;height:100%;font-family:'Roboto Mono',monospace;background:var(--bg);color:var(--fg);overflow:hidden}
body{background:url('https://wallpapercave.com/wp/wp4468245.jpg') center/cover no-repeat}
.panel{border:3px solid var(--border); background: var(--panel-bg); border-radius:6px; box-shadow:0 0 14px rgba(0,255,255,0.06); padding:8px}
.panel-title{display:flex;align-items:center;justify-content:space-between;padding:6px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:12px}
.chat-win{display:flex;flex-direction:column;height:calc(100vh - 100px);margin:12px}
.chat-main{display:flex;flex:1;overflow:hidden;background:rgba(255,255,255,0.02);border-radius:4px}
.chat-messages{flex:1;overflow:auto;padding:12px;color:#000;background:rgba(255,255,255,0.95);border-right:1px solid rgba(0,0,0,0.06)}
.chat-users{width:220px;overflow:auto;padding:8px;background:#fffacd}
.chat-row{display:flex;gap:8px;margin:8px 0;align-items:flex-start}
.chat-avatar{width:36px;height:36px;border-radius:50%;background:#add8e6;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#001a1a}
.chat-bubble{max-width:78%;padding:10px;border-radius:8px;background:#e6e6fa;border:1px solid rgba(0,0,0,0.06);color:#000}
.chat-bubble.me{background:#fffacd;border:1px solid #f0d280;text-align:right;color:#222}
.chat-meta{font-size:11px;color:#808080;font-weight:700;margin-bottom:4px}
.user-row{display:flex;gap:8px;align-items:center;padding:6px;font-size:12px;cursor:pointer}
.status-dot{width:9px;height:9px;border-radius:50%;background:var(--online)}
.uname{font-family:'Press Start 2P';color:#ff0000;font-size:12px}
.chat-controls{display:flex;gap:6px;padding:8px;background:#fffacd;border-top:1px solid rgba(0,0,0,0.06)}
.chat-controls input{flex:1;padding:8px;border:2px inset rgba(0,0,0,0.06);background:#fff;color:#000}
.chat-controls button{padding:10px;border:none;background:var(--accent);color:#000;font-weight:700;flex:1;cursor:pointer;border-radius:4px}
.server-select{display:flex;gap:6px;margin:12px;align-items:center}
.server-select button{flex:1; padding:12px; border:none; cursor:pointer; border-radius:4px; font-weight:700;}
.server-join{background:var(--yahoo-blue); color:#fff}
.server-switch{background:var(--yahoo-dark); color:#fff}
.small{font-size:11px;color:var(--muted)}
.typing-indicator { font-size: 12px; color: var(--muted); padding: 6px; font-style: italic; }
@media(max-width:900px){ 
  .chat-users{display:none} 
  .chat-controls{flex-direction:column} 
  .server-select{flex-direction:column} 
}
</style>
</head>
<body>
  <!-- Server selection -->
  <div class="server-select panel">
    <button class="server-join" id="joinBtn">JOIN CHAT</button>
    <button class="server-switch" id="switchBtn">SWITCH SERVER</button>
    <select id="serverSelect">
      <option value="sam">//Sam</option>
      <option value="exuro">//Exuro</option>
      <option value="nero">//Nero</option>
      <option value="nora">//Nora</option>
      <option value="loktal">//Loktal</option>
    </select>
  </div>

  <div class="panel" style="margin:12px">
    <div class="panel-title"><div class="title" id="chatTitle">//SAM <span class="small" id="userCountSmall">0 users</span></div></div>
  </div>

  <div class="chat-win panel" id="chatBody" style="margin:12px;padding:0">
    <div class="chat-main">
      <div class="chat-messages panel" id="chatMessages" aria-live="polite"></div>
      <div class="chat-users panel">
        <div class="small" style="margin-bottom:6px">USERS ONLINE</div>
        <div id="activeUsersList"></div>
      </div>
    </div>
    <div id="typingIndicator" class="typing-indicator"></div>
    <div class="chat-controls">
      <input id="chatInput" placeholder="Say something..." maxlength="500" autocomplete="off" aria-label="Chat input">
      <button id="sendBtn" aria-label="Send message">SEND</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, off, query, orderByChild, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain:"before-us-universe.firebaseapp.com",
  databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",
  projectId:"before-us-universe",
  storageBucket:"before-us-universe.firebasestorage.app",
  messagingSenderId:"477103463228",
  appId:"1:477103463228:web:01b53b6b29cb9d54315c39"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ---------- DOM ---------- */
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const userCountSmall = document.getElementById('userCountSmall');
const activeUsersList = document.getElementById('activeUsersList');
const chatTitle = document.getElementById('chatTitle');
const typingIndicator = document.getElementById('typingIndicator');

const serverSelect = document.getElementById('serverSelect');
const joinBtn = document.getElementById('joinBtn');
const switchBtn = document.getElementById('switchBtn');

/* ---------- State ---------- */
let uid=null,myHandle=null,currentChannel='sam',presenceRef=null;
let channelListeners={},typingTimeout=null;

/* ---------- Utilities ---------- */
function esc(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* ---------- Presence & online ---------- */
function setPresence(h,ch){
  if(!uid) return;
  if(presenceRef) remove(presenceRef).catch(()=>{});
  presenceRef = ref(db,`online/${ch}/${uid}`);
  set(presenceRef,{name:h,ts:Date.now(),channel:ch,uid,typing:false}).then(()=>{onDisconnect(presenceRef).remove();});
}

function watchOnline(){
  onValue(ref(db,`online/${currentChannel}`),snap=>{
    const data=snap.val()||{};
    activeUsersList.innerHTML='';
    Object.values(data).forEach(u=>{
      const row=document.createElement('div'); row.className='user-row';
      const dot=document.createElement('div'); dot.className='status-dot';
      const name=document.createElement('div'); name.className='uname'; name.textContent=u.name;
      row.append(dot,name); activeUsersList.appendChild(row);
    });
    const count=Object.keys(data).length;
    userCountSmall.textContent=count+(count===1?' user':' users');
    chatTitle.innerHTML=`//${currentChannel.toUpperCase()} <span class="small">${count} user${count===1?'':'s'}</span>`;
    typingIndicator.textContent=Object.values(data).filter(u=>u.typing&&u.uid!==uid).map(u=>u.name).join(', ');
  });
}

/* ---------- Chat listeners ---------- */
function listenChannel(ch){
  if(channelListeners[currentChannel]){
    const l=channelListeners[currentChannel];
    off(l.ref,'child_added',l.fn);
  }
  channelListeners={}; currentChannel=ch; chatMessages.innerHTML='';
  const r=ref(db,`chat/${ch}`);
  const q=query(r,orderByChild('ts'));
  const fn=snap=>{const o=snap.val(); if(o&&!o.deleted) renderChatMessage(o,snap.key);};
  onChildAdded(q,fn);
  channelListeners[ch]={ref:r,fn};
}

function renderChatMessage(o,key){
  const row=document.createElement('div'); row.className='chat-row';
  const av=document.createElement('div'); av.className='chat-avatar'; av.textContent=(o.name||'').slice(0,2).toUpperCase();
  const bub=document.createElement('div'); bub.className='chat-bubble';
  if(o.uid===uid)bub.classList.add('me');
  bub.innerHTML=`<div class="chat-meta">${esc(o.name)} · ${new Date(o.ts).toLocaleTimeString()}</div><div>${esc(o.msg)}</div>`;
  row.append(av,bub); chatMessages.appendChild(row);
  setTimeout(()=>{chatMessages.scrollTop=chatMessages.scrollHeight;},30);
}

/* ---------- Posting ---------- */
async function postChatMessage(ch,name,msg){
  if(!uid||!name) return;
  const m=msg.trim(); if(!m) return;
  const ts=Date.now(); const key=push(ref(db,`chat/${ch}`)).key;
  set(ref(db,`chat/${ch}/${key}`),{name,msg:m,ts,uid}).catch(console.error);
  set(ref(db,`online/${ch}/${uid}/ts`),Date.now()).catch(()=>{});
}

/* ---------- Input handlers ---------- */
sendBtn.onclick=()=>{const val=chatInput.value.trim(); if(!val) return; postChatMessage(currentChannel,myHandle,val); chatInput.value=''; set(ref(db,`online/${currentChannel}/${uid}/typing`),false).catch(()=>{});};
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});
chatInput.addEventListener('input',()=>{if(!uid) return; set(ref(db,`online/${currentChannel}/${uid}/typing`),chatInput.value.trim().length>0).catch(()=>{}); clearTimeout(typingTimeout); typingTimeout=setTimeout(()=>{set(ref(db,`online/${currentChannel}/${uid}/typing`),false).catch(()=>{});},2200);});

/* ---------- Init ---------- */
async function initChat(channel){
  try{
    uid = window.BUU.uid;
    myHandle = window.BUU.myHandle;
    currentChannel = channel||window.BUU.currentChannel||'sam';
    setPresence(myHandle,currentChannel);
    listenChannel(currentChannel);
    watchOnline();
  }catch(e){console.error('Chat init failed',e);}
}

/* ---------- Buttons ---------- */
joinBtn.onclick = ()=>{initChat(serverSelect.value)};
switchBtn.onclick = ()=>{initChat(serverSelect.value)};
</script>
</body>
</html>
