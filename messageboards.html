<div class="panel">
  <style>
    .panel {
      background-color: #f0e0d6;
      border: 3px solid #000;
      border-radius: 8px;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    .panel-title {
      background: linear-gradient(to bottom, #bbbbbb, #999999);
      padding: 8px;
      font-weight: bold;
      user-select: none;
    }
    .panel-body {
      background-color: #fffff0;
      padding: 12px;
    }
    .board-thread {
      background: #f8f8f8;
      padding: 12px 16px;
      margin: 12px 0;
      border: 1px solid #ccc;
      border-left: 6px solid var(--accent);
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .board-thread:hover {
      background: #eaeaff;
    }
    .postName {
      color: var(--accent);
      cursor: pointer;
    }
    .quotelink {
      color: inherit;
      text-decoration: underline;
    }
    #postingInfo {
      margin: 12px 0 8px 0;
      color: #555;
      font-size: 12px;
      text-align: left;
    }
    #boardList:empty::before {
      content: "No posts yet";
      display: block;
      text-align: center;
      color: #888;
      padding: 20px;
    }
  </style>

  <div class="panel-title" style="cursor:pointer">
    <span id="boardToggle">[-]</span> <span id="boardTitle">//MESSAGE BOARD</span>
    <span class="small">Posts persist â€“ chat deletes after 24h</span>
  </div>
  <div class="panel-body" id="boardBody">
    <input id="boardSearch" placeholder="//search posts" aria-label="Search message board">
    <div id="boardList" style="overflow:auto;max-height:600px;margin:12px 0;"></div>
    <div id="postingInfo">Posting as <strong id="boardHandle">Anonymous</strong> in #<strong id="boardChannel">general</strong></div>
    <textarea id="boardMsg" placeholder="Message (max 1000 characters) Supports greentext with > at line start and >>postid quotes" style="width:100%;min-height:100px;margin-top:4px;font-family: monospace;" aria-label="Message board input"></textarea>
    <button id="postBoardBtn" style="margin-top:8px;padding:10px 16px;background:var(--accent);border:3px solid #000;cursor:pointer;font-weight:bold;" aria-label="Post to message board">POST</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, get, get, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain:"before-us-universe.firebaseapp.com",
  databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",
  projectId:"before-us-universe",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const boardList = document.getElementById('boardList');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const boardSearch = document.getElementById('boardSearch');
const boardBody = document.getElementById('boardBody');
const panelTitle = document.querySelector('.panel-title');
const toggleIcon = document.getElementById('boardToggle');
const boardTitleEl = document.getElementById('boardTitle');
const boardHandleEl = document.getElementById('boardHandle');
const boardChannelEl = document.getElementById('boardChannel');

let uid = null, myHandle = null;
let currentChannel = null, channelRef = null;

panelTitle.onclick = () => {
  if (boardBody.style.display === 'none') {
    boardBody.style.display = '';
    toggleIcon.textContent = '[-]';
  } else {
    boardBody.style.display = 'none';
    toggleIcon.textContent = '[+]';
  }
};

// Start open
boardBody.style.display = '';
toggleIcon.textContent = '[-]';

function esc(s) { 
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
}

function updateUI() {
  boardTitleEl.textContent = `//MESSAGE BOARD - #${currentChannel || '???'}`;
  boardHandleEl.textContent = myHandle || 'Anonymous';
  boardChannelEl.textContent = currentChannel || '???';
}

function renderBoardPost(p, id) {
  const el = document.createElement('div');
  el.className = 'board-thread';
  el.id = `post-${id}`;

  let messageHtml = '';

  const lines = p.msg.split('\n');

  for (let line of lines) {
    if (line.trim() === '') {
      messageHtml += '<br>';
      continue;
    }

    let lineHtml = esc(line);

    // Quote links >>postid
    lineHtml = lineHtml.replace(/(&gt;&gt;([a-zA-Z0-9-]+))/g, '<a href="#post-$2" class="quotelink" style="color:inherit;text-decoration:underline;">$1</a>');

    // Greentext
    if (line.startsWith('>')) {
      if (lineHtml.startsWith('&gt;')) {
        lineHtml = lineHtml.replace(/^&gt;/, '>');
      }
      lineHtml = '<span style="color:#789922;">' + lineHtml + '</span>';
    }

    messageHtml += lineHtml + '<br>';
  }

  el.innerHTML = `
    <div style="margin-bottom:6px;">
      <strong class="postName">${esc(p.name || 'Anonymous')}</strong>
      <span class="small"> ${new Date(p.ts).toLocaleString()}</span>
      <span class="reply-link" style="margin-left:12px;cursor:pointer;color:var(--accent);">[Reply]</span>
    </div>
    <div style="white-space:pre-wrap;overflow-wrap:anywhere;">${messageHtml}</div>
  `;

  el.querySelector('.reply-link').onclick = () => {
    boardMsg.value = `>>${id}\n` + boardMsg.value;
    boardMsg.focus();
  };

  boardList.appendChild(el);
}

function applySearch() {
  const term = boardSearch.value.toLowerCase();
  for (const el of boardList.children) {
    el.style.display = el.textContent.toLowerCase().includes(term) ? '' : 'none';
  }
}

function listenBoard(ch) {
  if (channelRef) off(channelRef);

  boardList.innerHTML = '';
  boardSearch.value = '';
  applySearch();

  channelRef = ref(db, `board/${ch}`);

  get(channelRef).then(snap => {
    const data = snap.val() || {};
    const entries = Object.entries(data);

    if (entries.length === 0) {
      boardList.innerHTML = '<div class="small" style="text-align:center;color:#888;padding:20px 0">No posts yet in this channel</div>';
      updateUI();
      return;
    }

    entries
      .sort((a, b) => a[1].ts - b[1].ts)
      .forEach(([id, o]) => renderBoardPost(o, id));

    boardList.scrollTop = boardList.scrollHeight;
    applySearch();
  }).catch(console.error);

  onChildAdded(channelRef, snap => {
    const isAtBottom = boardList.scrollTop + boardList.clientHeight >= boardList.scrollHeight - 20;
    renderBoardPost(snap.val(), snap.key);
    if (isAtBottom) boardList.scrollTop = boardList.scrollHeight;
    applySearch();
  });
}

function monitorChannelChanges() {
  let lastChannel = window.BUU.currentChannel;
  setInterval(() => {
    if (window.BUU.currentChannel !== lastChannel) {
      lastChannel = window.BUU.currentChannel;
      currentChannel = lastChannel;
      listenBoard(currentChannel);
      updateUI();
    }
  }, 300);
}

postBoardBtn.onclick = async () => {
  if (!uid || !myHandle) return alert('Boot system not initialized');

  const m = boardMsg.value.trim();
  if (!m) return;
  if (m.length > 1000) return alert('Message too long (max 1000 characters)');

  const r = push(ref(db, `board/${currentChannel}`));
  await set(r, { name: myHandle, msg: m, ts: Date.now(), uid });
  boardMsg.value = '';
};

boardSearch.addEventListener('input', applySearch);

boardMsg.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    postBoardBtn.click();
  }
});

async function waitForBootUser() {
  return new Promise(resolve => {
    const interval = setInterval(() => {
      if (window.BUU && window.BUU.uid && window.BUU.myHandle) {
        uid = window.BUU.uid;
        myHandle = window.BUU.myHandle;
        clearInterval(interval);
        resolve();
      }
    }, 100);
  });
}

await waitForBootUser();

currentChannel = window.BUU.currentChannel || 'sam';
listenBoard(currentChannel);
monitorChannelChanges();
updateUI(); // initial UI update
</script>
