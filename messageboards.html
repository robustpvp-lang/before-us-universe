<div class="panel">
  <div class="panel-title" style="cursor:pointer">
    <span id="boardToggle">[-]</span> //MESSAGE BOARD - #<span id="boardChannelName">sam</span>
    <span class="small">Posts persist – </span>
  </div>
  <div class="panel-body" id="boardBody" style="display:block;border-top:none;border-radius:0;">
    <style>
      #boardInner {
        background: #001111;
        min-height: 600px;
        display: flex;
        flex-direction: column;
      }
      #boardList {
        flex: 1;
        overflow: auto;
        padding: 10px;
      }
      .board-thread {
        background: #002222;
        border: 1px solid var(--border);
        border-left: 4px solid var(--accent);
        padding: 12px;
        margin-bottom: 16px;
        word-wrap: break-word;
        overflow-wrap: anywhere;
      }
      .board-thread:hover {
        box-shadow: 0 0 8px var(--accent);
      }
      .board-thread .post-meta {
        margin-bottom: 8px;
        opacity: 0.9;
      }
      .board-thread strong {
        color: var(--accent);
      }
      .quotelink {
        color: var(--accent);
        text-decoration: underline;
        cursor: pointer;
      }
      .reply-link {
        margin-left: 12px;
        cursor: pointer;
        color: var(--accent);
        font-size: 11px;
      }
      #boardSearch {
        width: 100%;
        padding: 10px;
        background: #001f1f;
        border: 2px solid var(--border);
        color: var(--fg);
        box-sizing: border-box;
        margin-bottom: 10px;
      }
      #postingArea {
        padding: 12px;
        background: #001111;
        border-top: 1px solid var(--border);
      }
      #postingInfo {
        margin-bottom: 8px;
        font-size: 13px;
      }
      #boardMsg {
        width: 100%;
        min-height: 120px;
        background: #001f1f;
        border: 2px solid var(--border);
        color: var(--fg);
        padding: 10px;
        box-sizing: border-box;
        font-family: 'Roboto Mono', monospace;
        resize: vertical;
      }
      #postBoardBtn {
        margin-top: 8px;
        padding: 10px 20px;
        background: var(--accent);
        border: 3px solid #000;
        font-weight: bold;
        cursor: pointer;
      }
      #boardList:empty::before {
        content: "No posts yet in this channel";
        display: block;
        text-align: center;
        color: #00aaaa;
        padding: 80px 20px;
        font-size: 14px;
      }
    </style>

    <div id="boardInner">
      <input id="boardSearch" placeholder="//search posts">
      <div id="boardList"></div>
      <div id="postingArea">
        <div id="postingInfo">Posting as <strong id="boardHandle" style="color:red">loading...</strong> in #<strong id="boardChannelEl">loading...</strong></div>
        <textarea id="boardMsg" placeholder="Message (max 1000 chars) – >greentext works – >>postid quotes work"></textarea>
        <button id="postBoardBtn" disabled>POST</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, get, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain:"before-us-universe.firebaseapp.com",
  databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",
  projectId:"before-us-universe",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const boardList = document.getElementById('boardList');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const boardSearch = document.getElementById('boardSearch');
const toggleIcon = document.getElementById('boardToggle');
const boardBody = document.getElementById('boardBody');
const boardChannelName = document.getElementById('boardChannelName');
const boardHandle = document.getElementById('boardHandle');
const boardChannelEl = document.getElementById('boardChannelEl');

let myHandle = null;
let uid = null;
let currentChannel = null;
let channelRef = null;

document.querySelector('.panel-title').onclick = () => {
  const isHidden = boardBody.style.display === 'none';
  boardBody.style.display = isHidden ? 'block' : 'none';
  toggleIcon.textContent = isHidden ? '[-]' : '[+]';
};

function esc(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function updateUI() {
  boardChannelName.textContent = (currentChannel || 'sam').toUpperCase();
  boardChannelEl.textContent = currentChannel || 'sam';
  if (myHandle) {
    boardHandle.textContent = myHandle;
    boardHandle.style.color = 'var(--accent)';
    postBoardBtn.disabled = false;
  } else {
    boardHandle.textContent = 'no handle set';
    boardHandle.style.color = 'red';
    postBoardBtn.disabled = true;
  }
}

function renderBoardPost(p, id) {
  const el = document.createElement('div');
  el.className = 'board-thread';
  el.id = `post-${id}`;

  let messageHtml = '';
  const lines = p.msg.split('\n');
  lines.forEach(line => {
    if (line.trim() === '') {
      messageHtml += '<br>';
      return;
    }
    let lineHtml = esc(line);
    lineHtml = lineHtml.replace(/(&gt;&gt;([a-zA-Z0-9-]+))/g, '<a href="#post-$2" class="quotelink">$1</a>');
    if (line.startsWith('>')) lineHtml = '<span style="color:#789922">' + lineHtml + '</span>';
    messageHtml += lineHtml + '<br>';
  });

  const date = new Date(p.ts);
  const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const dateStr = date.toLocaleDateString(undefined, {month: 'short', day: 'numeric'});

  el.innerHTML = `
    <div class="post-meta">
      <strong>${esc(p.name || 'Anonymous')}</strong>
      <span style="margin-left:8px;color:#00aaaa;">${dateStr} ${timeStr}</span>
      <span class="reply-link">[Reply]</span>
    </div>
    <div style="margin-top:8px;">${messageHtml}</div>
  `;

  el.querySelector('.reply-link').onclick = () => {
    boardMsg.value = `>>${id}\n` + boardMsg.value;
    boardMsg.focus();
  };

  boardList.appendChild(el);
}

function applySearch() {
  const term = boardSearch.value.toLowerCase();
  Array.from(boardList.children).forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
}

function listenBoard(ch) {
  if (channelRef) off(channelRef);
  boardList.innerHTML = '';
  channelRef = ref(db, `board/${ch}`);
  get(channelRef).then(snap => {
    const data = snap.val() || {};
    Object.entries(data)
      .sort((a, b) => a[1].ts - b[1].ts)
      .forEach(([id, o]) => renderBoardPost(o, id));
    boardList.scrollTop = boardList.scrollHeight;
  });
  onChildAdded(channelRef, snap => {
    renderBoardPost(snap.val(), snap.key);
    boardList.scrollTop = boardList.scrollHeight;
  });
}

postBoardBtn.onclick = async () => {
  if (!myHandle) return;
  const m = boardMsg.value.trim();
  if (!m || m.length > 1000) return;
  const r = push(ref(db, `board/${currentChannel}`));
  await set(r, { name: myHandle, msg: m, ts: Date.now(), uid });
  boardMsg.value = '';
};

boardSearch.addEventListener('input', applySearch);
boardMsg.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    postBoardBtn.click();
  }
});

async function waitForBootUser() {
  return new Promise(resolve => {
    if (window.BUU && window.BUU.uid && window.BUU.myHandle && window.BUU.currentChannel) {
      uid = window.BUU.uid;
      myHandle = window.BUU.myHandle;
      currentChannel = window.BUU.currentChannel;
      resolve();
      return;
    }
    const interval = setInterval(() => {
      if (window.BUU && window.BUU.uid && window.BUU.myHandle && window.BUU.currentChannel) {
        uid = window.BUU.uid;
        myHandle = window.BUU.myHandle;
        currentChannel = window.BUU.currentChannel;
        clearInterval(interval);
        resolve();
      }
    }, 100);
  });
}

await waitForBootUser();
updateUI();
listenBoard(currentChannel);
</script>
