<div class="panel">
  <div class="panel-title" style="cursor:pointer">
    <span id="boardToggle">[-]</span> <span id="boardTitle">//MESSAGE BOARD</span>
    <span class="small">Posts persist – chat deletes after 24h</span>
  </div>
  <div class="panel-body" id="boardBody" style="display:block">
    <style>
      .board-thread {
        background: #f8f8ff;
        border: 1px solid #ccc;
        border-left: 5px solid var(--accent);
        padding: 10px 14px;
        margin: 12px 0;
        word-wrap: break-word;
        overflow-wrap: anywhere;
      }
      .board-thread:hover {
        background: #eef2ff;
      }
      .quotelink {
        color: inherit;
        text-decoration: underline;
      }
      .reply-link {
        margin-left: 12px;
        cursor: pointer;
        color: var(--accent);
      }
      #postingInfo {
        margin: 10px 0 6px 0;
        font-size: 13px;
      }
      #postingInfo strong {
        font-weight: bold;
      }
      #boardList {
        min-height: 60px;
      }
      #boardList:empty::before {
        content: "No posts yet in this channel";
        display: block;
        text-align: center;
        color: #888;
        padding: 30px 0;
      }
    </style>

    <input id="boardSearch" placeholder="//search posts" style="width:100%;margin-bottom:8px;box-sizing:border-box;">
    <div id="boardList" style="overflow:auto;max-height:700px;margin:10px 0;"></div>
    <div id="postingInfo">Posting as <strong id="boardHandle" style="color:red">loading...</strong> in #<strong id="boardChannel">loading...</strong></div>
    <textarea id="boardMsg" placeholder="Message (max 1000 chars) – Greentext: start line with > – Quote: >>postid" style="width:100%;min-height:120px;font-family:Verdana,sans-serif;box-sizing:border-box;"></textarea>
    <button id="postBoardBtn" style="margin-top:8px;padding:10px 20px;background:var(--accent);border:3px solid #000;font-weight:bold;cursor:pointer;">POST</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, get, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain:"before-us-universe.firebaseapp.com",
  databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",
  projectId:"before-us-universe",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const boardList = document.getElementById('boardList');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const boardSearch = document.getElementById('boardSearch');
const boardBody = document.getElementById('boardBody');
const toggleIcon = document.getElementById('boardToggle');
const boardTitleEl = document.getElementById('boardTitle');
const boardHandleEl = document.getElementById('boardHandle');
const boardChannelEl = document.getElementById('boardChannel');

let uid = null;
let myHandle = null;
let currentChannel = null;
let channelRef = null;

document.querySelector('.panel-title').onclick = () => {
  if (boardBody.style.display === 'none') {
    boardBody.style.display = 'block';
    toggleIcon.textContent = '[-]';
  } else {
    boardBody.style.display = 'none';
    toggleIcon.textContent = '[+]';
  }
};

function esc(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function updateUI() {
  boardTitleEl.textContent = `//MESSAGE BOARD${currentChannel ? ' - #' + currentChannel : ''}`;
  boardChannelEl.textContent = currentChannel || '???';
  if (myHandle) {
    boardHandleEl.textContent = myHandle;
    boardHandleEl.style.color = '';
    postBoardBtn.disabled = false;
    postBoardBtn.style.opacity = 1;
  } else {
    boardHandleEl.textContent = 'no handle set';
    boardHandleEl.style.color = 'red';
    postBoardBtn.disabled = true;
    postBoardBtn.style.opacity = 0.5;
  }
}

function renderBoardPost(p, id) {
  const el = document.createElement('div');
  el.className = 'board-thread';
  el.id = `post-${id}`;

  let messageHtml = '';
  const lines = (p.msg || '').split('\n');

  lines.forEach(line => {
    if (line.trim() === '') {
      messageHtml += '<br>';
      return;
    }

    let lineHtml = esc(line);

    // >>quotes
    lineHtml = lineHtml.replace(/(&gt;&gt;([a-zA-Z0-9-]+))/g, '<a href="#post-$2" class="quotelink">$1</a>');

    // Greentext
    const isGreen = line.startsWith('>');
    if (isGreen) lineHtml = '<span style="color:#789922">' + lineHtml + '</span>';

    messageHtml += lineHtml + '<br>';
  });

  el.innerHTML = `
    <div style="margin-bottom:6px;">
      <strong>${esc(p.name || 'Anonymous')}</strong>
      <span class="small"> ${new Date(p.ts).toLocaleString()}</span>
      <span class="reply-link">[Reply]</span>
    </div>
    <div>${messageHtml}</div>
  `;

  el.querySelector('.reply-link').onclick = () => {
    boardMsg.value = `>>${id}\n` + boardMsg.value;
    boardMsg.focus();
  };

  boardList.appendChild(el);
}

function applySearch() {
  const term = boardSearch.value.toLowerCase();
  for (const child of boardList.children) {
    child.style.display = child.textContent.toLowerCase().includes(term) ? '' : 'none';
  }
}

function listenBoard(ch) {
  if (channelRef) off(channelRef);

  boardList.innerHTML = '';
  boardSearch.value = '';
  applySearch();

  channelRef = ref(db, `board/${ch}`);

  get(channelRef).then(snap => {
    const data = snap.val() || {};
    if (Object.keys(data).length === 0) return;

    Object.entries(data)
      .sort(([ , a], [ , b]) => a.ts - b.ts)
      .forEach(([id, o]) => renderBoardPost(o, id));

    boardList.scrollTop = boardList.scrollHeight;
    applySearch();
  });

  onChildAdded(channelRef, snap => {
    const isAtBottom = boardList.scrollTop + boardList.clientHeight >= boardList.scrollHeight - 30;
    renderBoardPost(snap.val(), snap.key);
    if (isAtBottom) boardList.scrollTop = boardList.scrollHeight;
    applySearch();
  });
}

function monitorBootChanges() {
  let lastChannel = null;
  let lastHandle = null;
  let lastUid = null;

  setInterval(() => {
    if (!window.BUU) return;

    const changed = window.BUU.currentChannel !== lastChannel ||
                   window.BUU.myHandle !== lastHandle ||
                   window.BUU.uid !== lastUid;

    if (changed) {
      currentChannel = window.BUU.currentChannel;
      myHandle = window.BUU.myHandle;
      uid = window.BUU.uid;

      if (window.BUU.currentChannel !== lastChannel) {
        listenBoard(currentChannel || 'sam');
      }

      updateUI();
      lastChannel = window.BUU.currentChannel;
      lastHandle = window.BUU.myHandle;
      lastUid = window.BUU.uid;
    }
  }, 350);
}

postBoardBtn.onclick = async () => {
  if (!myHandle) {
    alert('You must set a handle in the boot menu before posting.');
    return;
  }

  const m = boardMsg.value.trim();
  if (!m) return;
  if (m.length > 1000) {
    alert('Message too long (max 1000 characters)');
    return;
  }

  const r = push(ref(db, `board/${currentChannel || 'sam'}`));
  await set(r, { name: myHandle, msg: m, ts: Date.now(), uid });
  boardMsg.value = '';
};

boardSearch.addEventListener('input', applySearch);

boardMsg.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    postBoardBtn.click();
  }
});

async function init() {
  return new Promise(resolve => {
    const interval = setInterval(() => {
      if (window.BUU && window.BUU.uid !== undefined) {  // uid = window.BUU.uid;
        myHandle = window.BUU.myHandle || null;
        currentChannel = window.BUU.currentChannel || 'sam';
        clearInterval(interval);
        updateUI();
        listenBoard(currentChannel);
        monitorBootChanges();
        resolve();
      }
    }, 100);
  });
}

await init();
updateUI(); // initial state (will show "no handle set" until boot loads)
</script>
