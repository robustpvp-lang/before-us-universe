<div class="panel">
  <div class="panel-title" style="cursor:pointer" onclick="boardBody.style.display = boardBody.style.display==='none'?'block':'none'">
    <span>//MESSAGE BOARD</span>
    <span class="small">Posts persist â€“ chat deletes after 24h</span>
  </div>
  <div class="panel-body" id="boardBody">
    <input id="boardSearch" placeholder="//search posts" aria-label="Search message board">
    <div id="boardList" style="overflow:auto;max-height:300px;margin:8px 0;"></div>
    <textarea id="boardMsg" placeholder="Message (max 1000)" style="width:100%;min-height:80px;margin-top:4px" aria-label="Message board input"></textarea>
    <button id="postBoardBtn" style="margin-top:6px;padding:8px 12px;background:var(--accent);border:3px solid #000;cursor:pointer" aria-label="Post to message board">POST</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, get, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain:"before-us-universe.firebaseapp.com",
  databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",
  projectId:"before-us-universe",
  storageBucket:"before-us-universe.firebasestorage.app",
  messagingSenderId:"477103463228",
  appId:"1:477103463228:web:01b53b6b29cb9d54315c39"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const boardList = document.getElementById('boardList');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const boardSearch = document.getElementById('boardSearch');
const boardBody = document.getElementById('boardBody');

let uid = null, myHandle = null;
let currentChannel = null, channelRef = null;

async function waitForBootUser() {
  return new Promise(resolve => {
    const interval = setInterval(() => {
      if(window.BUU && window.BUU.uid && window.BUU.myHandle) {
        uid = window.BUU.uid;
        myHandle = window.BUU.myHandle;
        clearInterval(interval);
        resolve();
      }
    }, 100);
  });
}

function esc(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderBoardPost(p, id){
  const el = document.createElement('div'); el.className = 'board-thread';
  el.innerHTML = `<strong>${esc(p.name || 'Anonymous')}</strong><pre>${esc(p.msg)}</pre>
    <div class="small">Posted: ${new Date(p.ts).toLocaleString()}</div>`;
  const reply = document.createElement('span');
  reply.textContent = '[Reply]';
  reply.style.cursor = 'pointer';
  reply.style.color = 'var(--accent)';
  reply.onclick = () => { boardMsg.value = `>>${id}\n` + boardMsg.value; boardMsg.focus(); };
  el.appendChild(reply);
  boardList.appendChild(el);
}

function listenBoard(ch){
  if(channelRef) off(channelRef);
  boardList.innerHTML = '';
  channelRef = ref(db, `board/${ch}`);

  get(channelRef).then(snap => {
    const data = snap.val() || {};
    Object.entries(data).sort((a,b) => a[1].ts - b[1].ts)
      .forEach(([id,o]) => renderBoardPost(o,id));
    boardList.scrollTop = boardList.scrollHeight;
  }).catch(console.error);

  onChildAdded(channelRef, snap => {
    const isAtBottom = boardList.scrollTop + boardList.clientHeight >= boardList.scrollHeight - 20;
    renderBoardPost(snap.val(), snap.key);
    if(isAtBottom) boardList.scrollTop = boardList.scrollHeight;
  }, console.error);
}

function monitorChannelChanges() {
  let lastChannel = window.BUU.currentChannel;
  setInterval(() => {
    if(window.BUU.currentChannel !== lastChannel) {
      lastChannel = window.BUU.currentChannel;
      currentChannel = lastChannel;
      listenBoard(currentChannel);
    }
  }, 200);
}

postBoardBtn.onclick = async () => {
  if(!uid || !myHandle) return alert('Boot system not initialized');
  const m = boardMsg.value.trim();
  if(!m || m.length > 1000) return;
  const r = push(ref(db, `board/${currentChannel}`));
  await set(r, {name: myHandle, msg: m, ts: Date.now(), uid}).catch(console.error);
  boardMsg.value = '';
};

boardSearch.addEventListener('input', () => {
  const term = boardSearch.value.toLowerCase();
  Array.from(boardList.children).forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
});

boardMsg.addEventListener('keydown', e => { if(e.ctrlKey && e.key==='Enter'){ e.preventDefault(); postBoardBtn.click(); } });

await waitForBootUser();
currentChannel = window.BUU.currentChannel || 'sam';
listenBoard(currentChannel);
monitorChannelChanges();
</script>
