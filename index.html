<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Before Us Universe — BUU</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --panel:#e6e6e6; --panel-border:#000; --text:#111;
  --accent:#0aa; --muted:#555;
  --online:#00c853; --offline:#ff3d00;
  --bg-fallback:#08111a;
  --yahoo-blue: linear-gradient(180deg,#1e73be,#0961a6);
}
html,body{height:100%;margin:0;font-family:Roboto, "Press Start 2P", monospace;background:var(--bg-fallback);color:var(--text);-webkit-font-smoothing:antialiased}
/* Background */
body{
  background-color:var(--bg-fallback);
  background-image:url('https://wallpapercave.com/wp/wp4468245.jpg');
  background-position:center;
  background-repeat:no-repeat;
  background-size:cover;
  overflow-y:scroll;
}
/* Boot overlay (retro terminal) */
#bootOverlay{position:fixed;left:0;top:0;width:100%;height:100%;background:#000;color:#7fffd4;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:20px}
#bootText{font-family:Courier, monospace;max-width:900px;line-height:1.4;opacity:1;transform:translateY(0);transition:opacity 400ms}
#bootProgress{width:420px;height:8px;border:2px solid #063; margin-top:18px;background:#031}
/* Container */
.app{position:relative;z-index:1;max-width:1180px;margin:18px auto;padding:12px;box-sizing:border-box}
header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px;padding:10px;background:linear-gradient(180deg,var(--panel),#dcdcdc);border:3px solid var(--panel-border);border-radius:6px}
.nav-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
header a{display:inline-block;padding:8px 10px;background:#fff;border:1px solid var(--panel-border);text-decoration:none;color:var(--text);font-size:14px;border-radius:4px}
header a:hover{filter:brightness(0.95)}
/* Yahoo-style title bar */
.title-bar{display:flex;align-items:center;gap:16px;padding:8px 12px;border-radius:6px;background:linear-gradient(180deg,#1e73be,#0961a6);color:#fff;font-family:Courier, monospace}
.title-bar .logo{font-weight:700;letter-spacing:1px}
.title-bar .subtitle{font-size:12px;opacity:0.9}

/* Layout */
.layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
@media(max-width:980px){ .layout{grid-template-columns:1fr} }

/* Panels */
.panel{background:var(--panel);border:3px solid var(--panel-border);border-radius:6px;padding:10px;box-shadow:3px 3px 0 rgba(0,0,0,0.12);position:relative;overflow:hidden}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}

/* Join */
.join-row input[type="text"]{padding:8px;border:2px inset var(--panel-border);width:220px;font-family:monospace}
.join-row select{padding:8px;border:2px inset var(--panel-border)}
.join-row button{padding:8px 10px;border:2px outset var(--panel-border);background:#ddd;cursor:pointer}

/* YouTube */
.yt-wrap{display:flex;justify-content:center}
.yt-wrap iframe{width:100%;max-width:720px;height:405px;border:4px solid var(--panel-border);background:#000}

/* Chat */
.chat-win{border:3px solid var(--panel-border);background:linear-gradient(180deg,#f0f0f0,#e0e0e0);border-radius:6px;overflow:hidden;position:relative}
.chat-title{display:flex;justify-content:space-between;align-items:center;padding:8px;background:linear-gradient(180deg,#dcdcdc,#cfcfcf);border-bottom:2px solid var(--panel-border)}
.chat-title .left{display:flex;gap:8px;align-items:center}
.close-btn{background:#ffefef;border:1px solid #900;padding:4px 6px;border-radius:4px;cursor:pointer}
.chat-body{padding:8px}
.chat-messages{height:260px;overflow:auto;background:#fff;border:2px inset #bbb;padding:8px;white-space:pre-wrap;color:#111}
.msg{margin:6px 0;padding:6px;border-radius:4px;background:linear-gradient(180deg,#fff,#f7f7f7);border:1px solid rgba(0,0,0,0.06)}
.msg .meta{font-weight:700;color:var(--accent)}
.chat-controls{display:flex;gap:8px;margin-top:8px}
.chat-controls input[type="text"]{flex:1;padding:8px;border:2px inset var(--panel-border);font-family:monospace}

/* Yahoo-chat gradient aesthetic for channel header */
.channel-header{padding:8px;border-radius:4px;color:#fff;margin-bottom:8px;background:linear-gradient(90deg,#2b8bd0,#0b5ea8);font-family:Courier, monospace}

/* Active users */
.active-list{display:flex;flex-direction:column;gap:6px}
.user-row{display:flex;align-items:center;gap:8px;padding:6px;border-radius:4px;background:#fff;border:1px solid rgba(0,0,0,0.06)}
.status-dot{width:12px;height:12px;border-radius:50%;box-shadow:0 0 6px rgba(0,0,0,0.08)}
.dot-online{background:var(--online)}
.dot-offline{background:var(--offline)}
.uname{font-family:monospace;font-weight:700}

/* Board */
.board-thread{background:#fff;border:2px solid var(--panel-border);padding:10px;margin-bottom:8px}
textarea{width:100%;min-height:80px;padding:8px;border:2px inset var(--panel-border);font-family:monospace}

/* tooltip */
.tooltip{position:relative}
.tooltip .tip{position:absolute;left:110%;top:0;background:#111;color:#7fffd4;padding:6px;border:1px solid #333;border-radius:4px;display:none;white-space:nowrap;z-index:999}
.tooltip:hover .tip{display:block}

/* particles */
#particleCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:0}

/* mobile active users under handle */
#mobileActive{display:none;margin-top:8px;font-size:13px;color:#fff}
@media(max-width:980px){ #mobileActive{display:block} .nav-left{justify-content:center} }

/* small responsiveness */
@media(max-width:600px){ .yt-wrap iframe{height:220px} }

/* AIM-style DM windows */
.dm-window{
  position:fixed;background:#fff;border:3px solid #b8860b;border-radius:6px;padding:8px;z-index:9999;min-width:260px;max-width:420px;box-shadow:6px 6px 0 rgba(0,0,0,0.15)
}
.dm-title{background:linear-gradient(180deg,#fddc6b,#f2c200);padding:6px;border-radius:4px;font-weight:700;cursor:move;font-family:Courier, monospace}
.dm-msg{background:#fff7d6;padding:8px;border-radius:8px;margin:6px 0;max-width:90%}
.dm-input{width:100%;padding:6px;border:1px solid #ddd}

/* Random effects button */
#randomBtn{padding:8px 10px;border-radius:6px;border:2px solid var(--panel-border);cursor:pointer;margin-left:8px}
.effects-list{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

/* AI Lore Expert button */
#loreBtn{padding:8px;background:#fff;border:2px solid #999;border-radius:6px;cursor:pointer;margin-left:8px}
</style>
</head>
<body>
<!-- Boot overlay -->
<div id="bootOverlay" role="status" aria-live="polite">
  <div id="bootText">
    <div><strong>BEFORE US UNIVERSE — BOOT SEQUENCE</strong></div>
    <div style="margin-top:12px">Initializing archival link... establishing attunement with the Archivist nodes.</div>
    <div id="bootLog" style="margin-top:12px;font-size:13px">loading assets: ░░░░░░░░░░</div>
    <div id="bootProgress"></div>
  </div>
</div>

<canvas id="particleCanvas" aria-hidden="true"></canvas>

<div class="app" id="app" role="main" aria-hidden="true">
  <div class="title-bar">
    <div class="logo">BUU</div>
    <div class="subtitle">Before Us Universe — community portal</div>
    <div style="margin-left:auto">
      <button id="randomBtn" title="Random timeline effect">Random</button>
      <button id="loreBtn" title="AI Lore Expert — replace # with your NotebookLM link">AI Lore Expert</button>
    </div>
  </div>

  <header>
    <div class="nav-left">
      <a href="https://tokillamockinggoblin.boards.net/" target="_blank" rel="noopener">To Kill a Mocking Goblin</a>
      <a href="https://youtube.com/@Patrickauthor" target="_blank" rel="noopener">Melphia's Game (YouTube)</a>
      <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview" target="_blank" rel="noopener">Book 1</a>
      <a href="https://web.archive.org/" target="_blank" rel="noopener">Wayback Machine</a>
    </div>
    <div>
      <button id="openChatBtn" class="open-chat-mobile" aria-label="Open chat">Open Chat</button>
    </div>
  </header>

  <div class="layout" aria-live="polite">
    <!-- LEFT column -->
    <div>
      <!-- Join & YouTube -->
      <div class="panel" aria-labelledby="joinHeading">
        <div style="display:flex;justify-content:space-between;gap:12px">
          <div style="flex:1">
            <div class="small" id="joinHeading">Enter handle (required to join chat)</div>
            <div class="join-row" style="margin-top:8px">
              <input id="handleField" placeholder="//YourHandle" maxlength="30" aria-label="Handle" />
              <select id="channelSelectTop" style="width:140px" aria-label="Choose channel">
                <option value="exuro">//Exuro</option>
                <option value="sam">//Sam</option>
                <option value="nero">//Nero</option>
                <option value="nora">//Nora</option>
                <option value="loktal">//Loktal</option>
                <option value="pilgrim" style="display:none">//Pilgrim</option>
              </select>
              <button id="joinBtn" aria-label="Join chat">JOIN</button>
              <button id="leaveBtn" style="display:none" aria-label="Leave chat">LEAVE</button>
            </div>
            <div id="mobileActive" aria-hidden="false"></div>
            <div class="small" style="margin-top:8px">Handles are reserved; choose carefully.</div>
          </div>

          <div style="width:160px">
            <div class="small">Theme</div>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <div class="theme-swatch" data-theme="default" style="width:24px;height:24px;background:#e6e6e6;border:1px solid #222;cursor:pointer" title="Default"></div>
              <div class="theme-swatch" data-theme="dark" style="width:24px;height:24px;background:#111;border:1px solid #222;cursor:pointer" title="Dark"></div>
              <div class="theme-swatch" data-theme="retro" style="width:24px;height:24px;background:linear-gradient(45deg,#ffefba,#ffc3a0);border:1px solid #222;cursor:pointer" title="Retro"></div>
            </div>
            <div class="small" style="margin-top:8px">Saved per browser</div>
          </div>
        </div>

        <hr/>

        <div class="yt-wrap" aria-hidden="false">
          <!-- YouTube playlist embed -->
          <iframe id="ytIframe" src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq" title="Melphia's Game playlist" allowfullscreen></iframe>
        </div>
      </div>

      <!-- Chat window -->
      <div class="panel chat-win" id="chatPanel" aria-live="polite" style="margin-top:12px">
        <div class="channel-header">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div id="winChannelLabel">//Exuro</div>
            <div style="display:flex;gap:12px;align-items:center">
              <div class="small" id="userCountSmall">0 users</div>
              <label class="small" for="doorToggle">Sound</label>
              <input type="checkbox" id="doorToggle" checked aria-checked="true" />
              <button class="close-btn" id="closeChatBtn" title="Close chat window" aria-label="Close chat">✖</button>
            </div>
          </div>
        </div>

        <div class="chat-body">
          <div class="chat-messages" id="chatMessages" role="log" aria-live="polite"></div>
          <div class="chat-controls">
            <input id="chatInput" placeholder="Write message..." maxlength="500" aria-label="Message input" />
            <select id="channelSelect" style="width:120px" aria-label="Select channel">
              <option value="exuro">//Exuro</option>
              <option value="sam">//Sam</option>
              <option value="nero">//Nero</option>
              <option value="nora">//Nora</option>
              <option value="loktal">//Loktal</option>
              <option value="pilgrim" style="display:none">//Pilgrim</option>
            </select>
            <button id="sendBtn" aria-label="Send message">POST</button>
          </div>
        </div>
      </div>

      <!-- Message board -->
      <div class="panel" style="margin-top:12px" aria-labelledby="boardHeading">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small" id="boardHeading">Local Message Board (ProBoards-style)</div>
          <div class="small">Posts persist; chat auto-deletes after 24 hours</div>
        </div>
        <div id="boardList" style="margin-top:8px;max-height:380px;overflow:auto" aria-live="polite"></div>
        <div class="board-controls" style="margin-top:8px">
          <input id="boardName" placeholder="Name (max 100)" style="width:180px;padding:6px" aria-label="Board name" />
          <textarea id="boardMsg" placeholder="Message (max 1000)" aria-label="Board message"></textarea>
          <button id="postBoardBtn" aria-label="Post to board">Post</button>
        </div>
      </div>
    </div>

    <!-- RIGHT column -->
    <div>
      <div class="panel">
        <div class="small">Active Users by Channel</div>
        <div id="activeContainer" style="margin-top:8px" aria-live="polite"></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="small">Direct Messages (DM)</div>
        <div id="dmList" style="margin-top:8px"></div>
        <div class="small" style="margin-top:8px">Click name to open DM window (AIM-style)</div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="small">System Feed</div>
        <div id="systemFeed" style="margin-top:8px;max-height:220px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Sounds -->
<audio id="soundDoor" src="https://assets.mixkit.co/sfx/download/mixkit-unlock-game-notification-253.wav" preload="auto"></audio>
<audio id="soundMsg" src="https://assets.mixkit.co/sfx/download/mixkit-positive-alert-600.wav" preload="auto"></audio>

<!-- Firebase (modular) -->
<script type="module">
/* ---------- Firebase SDKs ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove, onDisconnect, query, orderByChild, update, get, off } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";

/* ---------- Config (from your original) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.firebasestorage.app",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ---------- DOM refs ---------- */
const handleField = document.getElementById('handleField');
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');
const channelSelect = document.getElementById('channelSelect');
const channelSelectTop = document.getElementById('channelSelectTop');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const activeContainer = document.getElementById('activeContainer');
const mobileActive = document.getElementById('mobileActive');
const boardList = document.getElementById('boardList');
const boardName = document.getElementById('boardName');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const systemFeed = document.getElementById('systemFeed');
const dmList = document.getElementById('dmList');
const winChannelLabel = document.getElementById('winChannelLabel');
const userCountSmall = document.getElementById('userCountSmall');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatPanel = document.getElementById('chatPanel');
const openChatBtn = document.getElementById('openChatBtn');
const themeSwatches = document.querySelectorAll('.theme-swatch');
const soundDoor = document.getElementById('soundDoor');
const doorToggle = document.getElementById('doorToggle');
const soundMsg = document.getElementById('soundMsg');
const randomBtn = document.getElementById('randomBtn');
const loreBtn = document.getElementById('loreBtn');
const bootOverlay = document.getElementById('bootOverlay');
const bootLog = document.getElementById('bootLog');
const appRoot = document.querySelector('.app');

/* ---------- State ---------- */
let uid = null;
let myHandle = null;
let currentChannel = 'exuro';
let presenceRef = null;
let channelListeners = {}; // to detach listeners when switching
let lastHashes = new Set();

/* ---------- Boot animation ---------- */
function finishBoot(){
  bootLog.textContent = 'ready — welcome, Commander.';
  setTimeout(()=>{
    bootOverlay.style.transition = 'opacity 400ms'; bootOverlay.style.opacity = 0;
    setTimeout(()=>{ bootOverlay.remove(); document.getElementById('app').removeAttribute('aria-hidden'); }, 450);
  }, 900);
}
let bootPct = 0;
const bootInterval = setInterval(()=>{
  bootPct += Math.floor(Math.random()*12)+6;
  if(bootPct > 98) { bootPct = 100; clearInterval(bootInterval); finishBoot(); }
  bootLog.textContent = 'loading assets: ' + '█'.repeat(Math.floor(bootPct/8));
  document.getElementById('bootProgress').style.width = Math.min(420, 4.2*bootPct) + 'px';
}, 180);

/* ---------- Particles (light) ---------- */
const pCanvas = document.getElementById('particleCanvas');
const pCtx = pCanvas.getContext('2d');
function resizeCanvas(){ pCanvas.width = window.innerWidth; pCanvas.height = window.innerHeight; }
resizeCanvas(); window.addEventListener('resize', resizeCanvas);
let particles = [];
function spawnParticle(x,y){ particles.push({x,y,vx:(Math.random()-0.5)*0.8, vy:(Math.random()-0.5)*0.8, life:45, size:Math.random()*2+1}); }
function particleLoop(){
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.life--;
    pCtx.fillStyle = `rgba(127,255,212,${p.life/45})`;
    pCtx.fillRect(p.x, p.y, p.size, p.size);
    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(particleLoop);
}
particleLoop();
document.addEventListener('mousemove', e => spawnParticle(e.clientX, e.clientY));

/* ---------- Auth ---------- */
signInAnonymously(auth).catch(e => appendSystem('Auth error: ' + e.message));
onAuthStateChanged(auth, user => {
  if(user) { uid = user.uid; appendSystem('Signed in: ' + uid); }
});

/* ---------- Utilities ---------- */
function appendSystem(text){
  const el = document.createElement('div'); el.className = 'small'; el.style.padding='4px'; el.textContent = `${new Date().toLocaleTimeString()} - ${text}`;
  systemFeed.prepend(el);
}
function sanitizeHandle(s){ return String(s||'').replace(/[^\w\-\s]/g,'').slice(0,30).trim(); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- Hash helper (SHA-256) ---------- */
async function computeHash(str){
  if(window.crypto && crypto.subtle && crypto.subtle.digest){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    return hex;
  } else {
    // fallback: simple base64
    return btoa(unescape(encodeURIComponent(str))).slice(0,64);
  }
}

/* ---------- Presence (online) ---------- */
function setPresence(handle, channel){
  if(!uid) { appendSystem('Auth not ready for presence'); return; }
  if(presenceRef) {
    try { remove(presenceRef); } catch(e){ /* ignore */ }
  }
  presenceRef = ref(db, `online/${channel}/${uid}`);
  set(presenceRef, { name: handle, ts: Date.now(), channel, uid }).then(() => {
    try { onDisconnect(presenceRef).remove(); } catch(e) {}
    appendSystem(`Presence set: ${handle} @ ${channel}`);
  }).catch(e => appendSystem('Presence set failed: ' + e.message));
}

/* ---------- Watch online & render active users ---------- */
function watchOnline(){
  const onlineRef = ref(db, 'online');
  onValue(onlineRef, snap => {
    const data = snap.val() || {};
    renderActive(data);
    renderMobileActive(data);
    rebuildDMList(data);
  });
}
function renderActive(data){
  activeContainer.innerHTML = '';
  const channels = ['exuro','sam','nero','nora','loktal','pilgrim'];
  channels.forEach(ch => {
    const wrapper = document.createElement('div');
    wrapper.style.marginBottom = '10px';
    const title = document.createElement('div'); title.textContent = '//' + ch.charAt(0).toUpperCase() + ch.slice(1); title.style.fontWeight = '700';
    const count = data[ch] ? Object.keys(data[ch]).length : 0;
    const countSpan = document.createElement('span'); countSpan.textContent = ' ' + count + ' user' + (count!==1?'s':''); countSpan.style.marginLeft='8px';
    title.appendChild(countSpan);
    wrapper.appendChild(title);
    // users list
    const list = document.createElement('div');
    const usersObj = data[ch] || {};
    Object.entries(usersObj).forEach(([userId, u]) => {
      const row = document.createElement('div'); row.className = 'user-row';
      const dot = document.createElement('div'); dot.className = 'status-dot ' + (u ? 'dot-online' : 'dot-offline');
      const nameWrap = document.createElement('div'); nameWrap.className = 'tooltip';
      const uname = document.createElement('div'); uname.className = 'uname'; uname.textContent = u.name;
      const tip = document.createElement('div'); tip.className = 'tip';
      tip.textContent = `UID: ${userId} · Last: ${u.ts ? new Date(u.ts).toLocaleTimeString() : '-'} · Channel: ${u.channel || '-'}`;
      nameWrap.appendChild(uname); nameWrap.appendChild(tip);
      nameWrap.style.cursor = 'pointer';
      nameWrap.addEventListener('click', () => openDM(userId, u.name));
      row.appendChild(dot); row.appendChild(nameWrap);
      list.appendChild(row);
    });
    wrapper.appendChild(list);
    activeContainer.appendChild(wrapper);
  });
  // update userCountSmall
  const totals = data[currentChannel] ? Object.keys(data[currentChannel]).length : 0;
  userCountSmall.textContent = totals + ' user' + (totals!==1 ? 's' : '');
}
function renderMobileActive(data){
  if(!mobileActive) return;
  const channel = channelSelectTop.value || currentChannel;
  const users = (data[channel] && Object.values(data[channel])) || [];
  if(window.innerWidth <= 980){
    mobileActive.textContent = `Active in ${'//'+channel.charAt(0).toUpperCase()+channel.slice(1)}: ${users.length} user${users.length!==1?'s':''}`;
  } else {
    mobileActive.textContent = '';
  }
}

/* ---------- DM list ---------- */
function rebuildDMList(data){
  dmList.innerHTML = '';
  const seen = new Set();
  for(const ch in data){
    for(const uidKey in data[ch]||{}){
      const user = data[ch][uidKey];
      if(uidKey === uid) continue;
      if(!seen.has(uidKey)){
        seen.add(uidKey);
        const btn = document.createElement('div'); btn.textContent = user.name; btn.style.padding='6px'; btn.style.border='1px solid #ccc'; btn.style.marginBottom='6px'; btn.style.cursor='pointer';
        btn.addEventListener('click', ()=> openDM(uidKey, user.name));
        dmList.appendChild(btn);
      }
    }
  }
}

/* ---------- DM window (draggable AIM-style) ---------- */
function makeDraggable(el, titleBar){
  let dragging = false, offsetX=0, offsetY=0;
  titleBar.addEventListener('mousedown', e=>{
    dragging = true;
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    el.style.left = Math.max(6, e.clientX - offsetX) + 'px';
    el.style.top = Math.max(6, e.clientY - offsetY) + 'px';
  });
  document.addEventListener('mouseup', ()=>{ dragging = false; document.body.style.userSelect = ''; });
}

function openDM(targetUid, targetName){
  if(!uid){ alert('Please join first'); return; }
  if(targetUid === uid){ alert("Can't DM yourself"); return; }
  const pid = [uid, targetUid].sort().join('_');
  const w = document.createElement('div'); w.className = 'dm-window';
  w.style.right = '20px'; w.style.bottom = '20px';
  w.style.left = Math.min(window.innerWidth-300, 40) + 'px';
  w.style.top = Math.min(window.innerHeight-300, 60) + 'px';
  const t = document.createElement('div'); t.className = 'dm-title'; t.textContent = `DM: ${targetName}`;
  const msgs = document.createElement('div'); msgs.style.height='180px'; msgs.style.overflow='auto'; msgs.style.border='1px solid #ddd'; msgs.style.marginTop='6px'; msgs.style.padding='6px';
  const input = document.createElement('input'); input.placeholder='Type a DM...'; input.className='dm-input'; input.style.marginTop='6px';
  const send = document.createElement('button'); send.textContent='Send'; send.style.marginTop='6px';
  const close = document.createElement('button'); close.textContent='Close'; close.style.marginLeft='6px';
  w.appendChild(t); w.appendChild(msgs); w.appendChild(input); w.appendChild(send); w.appendChild(close);
  document.body.appendChild(w);
  makeDraggable(w, t);
  // listen for dm messages (only permitted if rule allows)
  const dmRef = ref(db, `dm/${pid}`);
  onChildAdded(dmRef, snap => {
    const o = snap.val();
    const el = document.createElement('div'); el.className = 'dm-msg';
    el.style.textAlign = (o.from === uid ? 'right' : 'left');
    el.textContent = `${o.fromName}: ${o.msg}`;
    msgs.appendChild(el); msgs.scrollTop = msgs.scrollHeight;
  });
  send.onclick = async ()=>{
    const text = input.value.trim(); if(!text) return;
    if(text.length > 1000) return alert('DM max 1000 chars');
    const ts = Date.now();
    const msgObj = { from: uid, to: targetUid, fromName: myHandle||'Anon', toName: targetName, msg: text, ts, uid: uid };
    // compute hash and update both dm and dmHashes to avoid duplicates
    const h = await computeHash(JSON.stringify({from:uid,to:targetUid,msg:text,ts}));
    const updates = {};
    const newKey = push(ref(db, `dm/${pid}`)).key;
    updates[`/dm/${pid}/${newKey}`] = msgObj;
    updates[`/dmHashes/${h}`] = { pid, key: newKey, ts, from: uid };
    update(ref(db), updates).then(()=>{ input.value=''; soundMsg.play().catch(()=>{}); }).catch(e=>appendSystem('DM send error: '+e.message));
  };
  close.onclick = ()=> { off(dmRef); w.remove(); };
}

/* ---------- Chat per-channel (safe listen/unlisten) ---------- */
function detachChannelListener(channel){
  if(channelListeners[channel]){
    try { off(channelListeners[channel].ref, channelListeners[channel].fn); } catch(e){ /*ignore*/ }
    delete channelListeners[channel];
  }
}
function listenChannel(channel){
  // detach previous
  for(const ch in channelListeners) detachChannelListener(ch);
  currentChannel = channel;
  winChannelLabel.textContent = '//' + channel.charAt(0).toUpperCase() + channel.slice(1);
  chatMessages.innerHTML = '';
  const channelRef = ref(db, `chat/${channel}`);
  const handler = (snap) => {
    const o = snap.val();
    if(!o) return;
    // validate (client-side) fields quickly
    const el = document.createElement('div'); el.className = 'msg';
    const nameHtml = `<span class="meta">${escapeHtml(o.name)}</span>`;
    const textHtml = `<span class="text"> ${escapeHtml(o.msg || o.text || '')}</span>`;
    const timeHtml = `<div class="small">${new Date(o.ts || Date.now()).toLocaleTimeString()}</div>`;
    el.innerHTML = nameHtml + ':' + textHtml + timeHtml;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    if(doorToggle.checked) soundMsg.play().catch(()=>{});
    spawnParticle(Math.random()*window.innerWidth, Math.random()*40 + 20);
  };
  onChildAdded(channelRef, handler);
  // store so we can off() later
  channelListeners[channel] = { ref: channelRef, fn: handler };
}

/* ---------- Post message (with duplicate prevention via msgHashes) ---------- */
async function postMessage(channel, name, msg){
  if(!uid) { appendSystem('Not authenticated'); return; }
  const trimmed = String(msg||'').trim();
  if(!trimmed) return;
  if(trimmed.length > 500) return alert('Chat message exceeds 500 chars');
  if((name||'').length > 30) return alert('Handle too long');
  const ts = Date.now();
  // timestamp cannot be in future (allow small skew)
  if(ts > Date.now() + 5000) return appendSystem('Invalid timestamp');
  // compute content hash
  const hash = await computeHash(`${channel}|${name}|${trimmed}|${uid}|${Math.floor(ts/1000)}`);
  // build new push key
  const newKey = push(ref(db, `chat/${channel}`)).key;
  const msgObj = { name, msg: trimmed, channel, ts, uid, hash };
  // write both chat and msgHash together using update to enforce atomic-ish write for rules
  const updates = {};
  updates[`/chat/${channel}/${newKey}`] = msgObj;
  updates[`/msgHashes/${hash}`] = { channel, key: newKey, ts, uid };
  try{
    await update(ref(db), updates);
    // bump presence timestamp
    if(uid) set(ref(db, `online/${channel}/${uid}`), { name, ts: Date.now(), channel, uid }).catch(()=>{});
  } catch(e){
    appendSystem('Chat post error: ' + e.message);
  }
}

/* ---------- Message Board ---------- */
function listenBoard(){
  const bRef = ref(db, 'board');
  onChildAdded(bRef, snap => renderBoardPost(snap.val()));
}
function renderBoardPost(p){
  if(!p) return;
  const text = (p.msg || p.text || '');
  if(text.includes('Archivist') && text.includes('ProBoards')) return; // drop mirrored archivist posts
  const el = document.createElement('div'); el.className='board-thread';
  el.innerHTML = `<div style="font-weight:700">${escapeHtml(p.name || p.user || 'Anon')}</div><div style="margin-top:6px">${escapeHtml(text)}</div><div class="small" style="margin-top:6px">${new Date(p.ts || Date.now()).toLocaleString()}</div>`;
  boardList.prepend(el);
}

/* ---------- UI Wiring ---------- */
joinBtn.addEventListener('click', async ()=>{
  const raw = sanitizeHandle(handleField.value || '');
  if(!raw){ alert('Enter a handle'); return; }
  myHandle = raw; handleField.value = myHandle;
  if(!uid){ alert('Auth not ready'); return; }
  // try to reserve handle (rules will reject if already taken)
  const handlePath = `handles/${myHandle}`;
  try{
    await set(ref(db, handlePath), { uid, joined: Date.now() });
    // set users profile
    await set(ref(db, `users/${uid}/profile`), { name: myHandle, firstSeen: Date.now() });
  } catch(e){
    appendSystem('Handle reservation failed: ' + e.message);
    alert('Handle unavailable. Try another.');
    return;
  }
  const ch = channelSelectTop.value || 'exuro';
  setPresence(myHandle, ch);
  joinBtn.style.display = 'none'; leaveBtn.style.display = 'inline-block';
  listenChannel(ch);
  appendSystem(`Joined as ${myHandle} on ${ch}`);
});
leaveBtn.addEventListener('click', ()=>{
  if(presenceRef) { remove(presenceRef).catch(()=>{}); presenceRef = null; }
  // optional: free handle only by owning uid (rules enforce)
  if(myHandle){
    remove(ref(db, `online`)).catch(()=>{}); // best-effort: remove online entries
  }
  joinBtn.style.display = 'inline-block'; leaveBtn.style.display = 'none'; myHandle = null;
  appendSystem('Left presence');
});
channelSelect.addEventListener('change', ()=>{
  channelSelectTop.value = channelSelect.value;
  listenChannel(channelSelect.value);
  if(myHandle) setPresence(myHandle, channelSelect.value);
});
channelSelectTop.addEventListener('change', ()=>{
  channelSelect.value = channelSelectTop.value;
  listenChannel(channelSelectTop.value);
  if(myHandle) setPresence(myHandle, channelSelectTop.value);
});
sendBtn.addEventListener('click', ()=>{
  if(!myHandle){ alert('Join first'); return; }
  const txt = chatInput.value.trim(); if(!txt) return;
  postMessage(channelSelect.value, myHandle, txt);
  chatInput.value = '';
  soundMsg.play().catch(()=>{});
});
chatInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault(); sendBtn.click();
  }
});
postBoardBtn.addEventListener('click', async ()=>{
  const name = (boardName.value || '').trim();
  const msg = (boardMsg.value || '').trim();
  if(!name || !msg) return alert('Board post requires name and message');
  if(name.length > 100) return alert('Name too long (100)');
  if(msg.length > 1000) return alert('Message too long (1000)');
  const r = push(ref(db, 'board'));
  try{
    await set(r, { name, msg, ts: Date.now(), uid: uid || null });
    boardName.value=''; boardMsg.value='';
    appendSystem('Posted to board');
  } catch(e){ appendSystem('Board post error: ' + e.message); }
});

/* close/open chat panel */
closeChatBtn.addEventListener('click', ()=>{ chatPanel.style.display='none'; openChatBtn.style.display='inline-block'; });
openChatBtn.addEventListener('click', ()=>{ chatPanel.style.display='block'; openChatBtn.style.display='none'; });

/* theme swatches */
themeSwatches.forEach(s => s.addEventListener('click', ()=>{
  const t = s.getAttribute('data-theme');
  applyTheme(t); localStorage.setItem('buu-theme', t);
}));
function applyTheme(t){
  if(t === 'dark'){
    document.documentElement.style.setProperty('--panel','#121212');
    document.documentElement.style.setProperty('--text','#eee');
    document.documentElement.style.setProperty('--bg-fallback','#000');
  } else if(t === 'retro'){
    document.documentElement.style.setProperty('--panel','#fff7e6');
    document.documentElement.style.setProperty('--text','#222');
  } else {
    document.documentElement.style.setProperty('--panel','#e6e6e6');
    document.documentElement.style.setProperty('--text','#111');
  }
}
const savedTheme = localStorage.getItem('buu-theme') || 'default'; applyTheme(savedTheme);

/* startup */
watchOnline(); listenBoard(); listenChannel(currentChannel);
appendSystem('Interface ready.');

/* ---------- prune old chat (24h) - server-side best, but keep client-triggered cleanup for safety ---------- */
setInterval(async ()=>{
  try{
    const rootSnap = await get(ref(db, 'chat'));
    const obj = rootSnap.val() || {};
    for(const ch in obj){
      for(const id in obj[ch]){
        const item = obj[ch][id];
        if(item && item.ts && (Date.now() - item.ts) > 24*60*60*1000){
          await remove(ref(db, `chat/${ch}/${id}`));
        }
      }
    }
  } catch(e){ /* ignore */ }
}, 60*60*1000);

/* ---------- Real-time watchers (board mirror & DM & online chain rebuild) ---------- */
const onlineRef = ref(db, 'online');
onValue(onlineRef, snapshot => {
  const data = snapshot.val() || {};
  renderActive(data);
  renderMobileActive(data);
  rebuildDMList(data);
});

/* ---------- Random effects button (7 effects) ---------- */
const effects = [
  ()=> document.body.style.filter = 'grayscale(1)',
  ()=> document.body.style.filter = 'saturate(1.6) hue-rotate(20deg)',
  ()=> document.getElementById('particleCanvas').style.opacity = 0.25,
  ()=> document.getElementById('particleCanvas').style.transform = 'scale(1.2)',
  ()=> { document.querySelectorAll('.panel').forEach((p,i)=>p.style.transform = `rotate(${(i%2?1:-1)*(Math.random()*1.6)}deg)`); },
  ()=> { document.documentElement.style.setProperty('--panel','#0b1220'); document.documentElement.style.setProperty('--text','#cfe'); },
  ()=> alert('Timeline ripple: anachronies enabled (visual only)')
];
randomBtn.addEventListener('click', ()=> {
  const f = effects[Math.floor(Math.random()*effects.length)];
  try{ f(); appendSystem('Random effect applied'); } catch(e){ appendSystem('Effect failed') }
});

/* AI Lore Expert - placeholder to replace hash with NotebookLM link */
loreBtn.addEventListener('click', ()=> {
  const url = '#'; // replace '#' with your NotebookLM/public URL
  if(url === '#') return alert('AI Lore Expert placeholder: replace the link in the code with your NotebookLM URL.');
  window.open(url, '_blank');
});
</script>
</body>
</html>
