<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Before Us Universe — BUU</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ────────────────────────────────────── DOS / CRT ────────────────────────────────────── */
:root{
  --dos-bg:#000; --dos-fg:#0f0; --dos-border:#0c0;
  --yahoo-blue:#1e73be; --yahoo-dark:#0961a6;
  --accent:#0ff; --muted:#088;
}
html,body{margin:0;height:100%;font-family:'Roboto Mono',monospace;background:var(--dos-bg);color:var(--dos-fg);overflow:hidden}
body{background:url('https://wallpapercave.com/wp/wp4468245.jpg') center/cover no-repeat}

/* CRT scan-lines */
#crt::before{
  content:"";position:fixed;top:0;left:0;right:0;bottom:0;
  background:repeating-linear-gradient(0deg,rgba(0,0,0,0.08),rgba(0,0,0,0.08) 2px,transparent 2px,transparent 4px);
  pointer-events:none;z-index:999;
}

/* Boot overlay */
#bootOverlay{position:fixed;inset:0;background:#000;color:#0f0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:'Press Start 2P',cursive}
#bootPanel{width:90%;max-width:800px;background:#001a00;border:4px solid var(--dos-border);padding:20px;box-shadow:0 0 30px #0f0}
#bootLog{line-height:1.6;white-space:pre-wrap;margin-bottom:20px}
#bootPrompt{color:#0ff}
#bootInput{background:#001a00;border:2px solid var(--dos-border);color:#0f0;font-family:inherit;padding:6px;width:70%;max-width:300px}
#bootBtn{background:#001a00;border:2px solid var(--dos-border);color:#0f0;padding:6px 12px;cursor:pointer}

/* Main app (hidden until login) */
#app{display:none;height:100%;padding:8px;box-sizing:border-box;overflow-y:auto}
.title-bar{display:flex;align-items:center;flex-wrap:wrap;gap:12px;padding:8px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P'}
.title-bar .logo{font-weight:700;letter-spacing:1px}
.top-links{display:flex;gap:12px;flex-wrap:wrap;margin-left:auto;align-items:center}
.top-links a{color:#fff;text-decoration:underline;font-size:13px}
#ortegaBtn{background:#ff0;color:#000;padding:6px 14px;border-radius:4px;font-weight:700;cursor:pointer}

/* Layout */
.layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
@media(max-width:980px){.layout{grid-template-columns:1fr}}

/* Panels – DOS style */
.panel{background:#001a00;border:3px solid var(--dos-border);padding:10px;border-radius:4px;box-shadow:0 0 12px rgba(0,255,0,0.3);position:relative;overflow:hidden}
.small{font-size:12px;color:var(--muted)}

/* YouTube */
.yt-wrap iframe{width:100%;max-width:720px;height:405px;border:4px solid var(--dos-border)}

/* Yahoo chat */
.chat-win{border:4px solid var(--yahoo-dark);border-radius:8px;overflow:hidden;background:#eaf6ff}
.chat-title{display:flex;justify-content:space-between;align-items:center;padding:6px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:12px}
.chat-body{padding:8px;display:grid;grid-template-columns:1fr 180px;gap:8px}
@media(max-width:700px){.chat-body{grid-template-columns:1fr}}
.chat-messages{height:340px;overflow:auto;background:#fff;border:2px solid #ccc;padding:8px;border-radius:4px}
.chat-row{display:flex;gap:8px;margin:6px 0;align-items:flex-start}
.chat-avatar{width:32px;height:32px;border-radius:50%;background:#d9eefc;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px}
.chat-bubble{max-width:78%;padding:8px;border-radius:8px;background:#fff;border:1px solid #cfe6ff;font-family:Arial}
.chat-bubble.me{background:#fff7d6;border:1px solid #f0d280;text-align:right}
.chat-meta{font-size:11px;color:#0a6fbf;font-weight:700;margin-bottom:4px}
.chat-controls{display:flex;gap:6px;margin-top:8px}
.chat-controls input{flex:1;padding:6px;border:2px inset #ccc;font-family:monospace}
.chat-controls select, .chat-controls button{padding:6px;border:2px outset #ccc;background:#dfefff;cursor:pointer}

/* Active users */
.user-row{display:flex;align-items:center;gap:8px;padding:4px;border-radius:4px;background:#fff;border:1px solid #ccc;cursor:pointer}
.status-dot{width:10px;height:10px;border-radius:50%;background:var(--online)}
.uname{font-family:'Press Start 2P';font-size:11px;color:#0a4b7a}
.tooltip{position:relative}
.tooltip .tip{position:absolute;left:105%;top:0;background:#111;color:#fff;padding:4px 8px;border-radius:4px;white-space:nowrap;display:none;z-index:99;font-size:11px}
.tooltip:hover .tip{display:block}

/* Message board */
.board-thread{background:#fff;border:2px solid var(--dos-border);padding:8px;margin-bottom:8px;border-radius:4px}

/* System feed */
#systemFeed{max-height:180px;overflow:auto;background:#001a00;border:2px solid var(--dos-border);padding:6px;font-size:12px}

/* DM window – AIM style */
.dm-window{position:fixed;background:#fff;border:3px solid #b8860b;border-radius:6px;z-index:9999;min-width:260px;max-width:420px;box-shadow:6px 6px 0 rgba(0,0,0,0.2)}
.dm-title{background:linear-gradient(180deg,#fddc6b,#f2c200);padding:6px;border-radius:4px;font-weight:700;cursor:move;font-family:'Press Start 2P';font-size:11px}
.dm-msg{background:#fff7d6;padding:6px;border-radius:6px;margin:4px 0;max-width:90%}

/* Particles */
#particleCanvas{position:fixed;inset:0;pointer-events:none;z-index:0}
</style>
</head>
<body>
<div id="crt"></div>

<!-- BOOT SCREEN -->
<div id="bootOverlay">
  <div id="bootPanel">
    <div id="bootLog" class="small"></div>
    <div id="bootPrompt">> ENTER HANDLE:</div>
    <input id="bootInput" type="text" maxlength="30" placeholder="//YourHandle">
    <button id="bootBtn">AUTHENTICATE</button>
    <div id="bootStatus" class="small" style="margin-top:8px;color:#0ff"></div>
  </div>
</div>

<canvas id="particleCanvas"></canvas>

<div id="app">
  <div class="title-bar">
    <div class="logo">BUU</div>
    <div style="flex:1"></div>
    <div class="top-links">
      <a href="https://tokillamockinggoblin.boards.net/" target="_blank">To Kill a Mocking Goblin</a>
      <a href="https://youtube.com/@Patrickauthor" target="_blank">Melphia’s Game (YT)</a>
      <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview" target="_blank">Book 1</a>
    </div>
    <button id="ortegaBtn">Project ://ORTEGA</button>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <div>
      <div class="panel">
        <div class="small">PLAYLIST</div>
        <div class="yt-wrap" style="margin-top:8px">
          <iframe src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq" allowfullscreen></iframe>
        </div>
      </div>

      <!-- Yahoo Chat -->
      <div class="panel chat-win" style="margin-top:12px">
        <div class="chat-title">
          <div style="display:flex;gap:12px;align-items:center">
            <span id="winChannelLabel">//EXURO</span>
            <span class="small" id="userCountSmall">0 users</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small" for="doorToggle" style="color:#fff">SOUND</label>
            <input type="checkbox" id="doorToggle" checked>
            <button id="closeChatBtn" style="background:#fff;color:#c00;padding:2px 6px;border-radius:4px">X</button>
          </div>
        </div>
        <div class="chat-body">
          <div class="chat-messages" id="chatMessages"></div>
          <div>
            <div class="small" style="margin-bottom:4px">USERS</div>
            <div id="activeContainer" style="max-height:320px;overflow:auto"></div>
          </div>
        </div>
        <div class="chat-controls">
          <input id="chatInput" placeholder="Say something..." maxlength="500">
          <select id="channelSelect">
            <option value="exuro">//Exuro</option>
            <option value="sam">//Sam</option>
            <option value="nero">//Nero</option>
            <option value="nora">//Nora</option>
            <option value="loktal">//Loktal</option>
          </select>
          <button id="sendBtn">SEND</button>
        </div>
      </div>

      <!-- Message Board -->
      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">MESSAGE BOARD</div>
          <div class="small">Posts persist – chat auto-deletes 24 h</div>
        </div>
        <div id="boardList" style="margin-top:8px;max-height:340px;overflow:auto"></div>
        <div style="margin-top:8px">
          <input id="boardName" placeholder="Name (max 100)" style="width:180px;padding:4px">
          <textarea id="boardMsg" placeholder="Message (max 1000)" style="width:100%;min-height:70px;margin-top:4px"></textarea>
          <button id="postBoardBtn" style="margin-top:4px">POST</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="panel">
        <div class="small">SYSTEM FEED</div>
        <div id="systemFeed"></div>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="small">DIRECT MESSAGES</div>
        <div id="dmList" style="margin-top:8px"></div>
        <div class="small" style="margin-top:4px">Click a name to open DM</div>
      </div>
    </div>
  </div>
</div>

<audio id="soundMsg" src="https://assets.mixkit.co/sfx/download/mixkit-positive-alert-600.wav" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove, onDisconnect, update, get, off } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";

const firebaseConfig = {apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",authDomain:"before-us-universe.firebaseapp.com",databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",projectId:"before-us-universe",storageBucket:"before-us-universe.firebasestorage.app",messagingSenderId:"477103463228",appId:"1:477103463228:web:01b53b6b29cb9d54315c39"};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ───── DOM ───── */
const bootOverlay = document.getElementById('bootOverlay');
const bootLog = document.getElementById('bootLog');
const bootInput = document.getElementById('bootInput');
const bootBtn = document.getElementById('bootBtn');
const bootStatus = document.getElementById('bootStatus');
const appRoot = document.getElementById('app');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const closeChatBtn = document.getElementById('closeChatBtn');
const userCountSmall = document.getElementById('userCountSmall');
const activeContainer = document.getElementById('activeContainer');
const boardList = document.getElementById('boardList');
const boardName = document.getElementById('boardName');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const systemFeed = document.getElementById('systemFeed');
const dmList = document.getElementById('dmList');
const ortegaBtn = document.getElementById('ortegaBtn');
const soundMsg = document.getElementById('soundMsg');

let uid = null, myHandle = null, currentChannel = 'exuro', presenceRef = null, channelListeners = {};

/* ───── BOOT SEQUENCE ───── */
const bootLines = [
  "INITIALIZING BEFORE US UNIVERSE...",
  "Loading kernel.............[OK]",
  "Mounting network...........[OK]",
  "Checking Firebase link.....[OK]",
  "Ready for authentication..."
];
let lineIdx = 0;
function typeBootLine(){
  if(lineIdx < bootLines.length){
    bootLog.textContent += bootLines[lineIdx] + "\n";
    lineIdx++;
    setTimeout(typeBootLine, 300 + Math.random()*400);
  }
}
typeBootLine();

/* ───── AUTH ───── */
signInAnonymously(auth).catch(e=>appendBoot("Auth error: "+e.message));
onAuthStateChanged(auth, u=>{ if(u) uid = u.uid; });

bootBtn.addEventListener('click', async ()=>{
  const raw = bootInput.value.trim().replace(/[^\w\-]/g,'').slice(0,30);
  if(!raw) return bootStatus.textContent = "Invalid handle";
  if(!uid) return bootStatus.textContent = "Auth not ready…";
  bootStatus.textContent = "Reserving…";
  const ok = await set(ref(db,`handles/${raw}`),{uid,joined:Date.now()}).then(()=>true).catch(()=>false);
  if(!ok) return bootStatus.textContent = "Handle taken";
  myHandle = raw;
  localStorage.setItem('buu-handle',myHandle);
  await set(ref(db,`users/${uid}/profile`),{name:myHandle,uid,firstSeen:Date.now()});
  setPresence(myHandle,currentChannel);
  finishBoot();
});

function finishBoot(){
  bootStatus.textContent = `Welcome, ${myHandle}`;
  setTimeout(()=>{bootOverlay.style.display='none';appRoot.style.display='block';appendSystem('System ready');},1200);
}

/* ───── UTILS ───── */
function appendSystem(t){ const d=document.createElement('div');d.textContent=`${new Date().toLocaleTimeString()} - ${t}`;systemFeed.prepend(d); }
function appendBoot(t){ bootLog.textContent += t+"\n"; }
function esc(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
async function hash(str){
  const e=new TextEncoder().encode(str);
  const b=await crypto.subtle.digest('SHA-256',e);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
}

/* ───── PRESENCE ───── */
function setPresence(h,ch){
  if(presenceRef) remove(presenceRef).catch(()=>{});
  presenceRef = ref(db,`online/${ch}/${uid}`);
  set(presenceRef,{name:h,ts:Date.now(),channel:ch,uid}).then(()=>onDisconnect(presenceRef).remove());
}

/* ───── ONLINE LIST ───── */
function watchOnline(){
  onValue(ref(db,'online'),snap=>{
    const data = snap.val()||{};
    renderActive(data);
    rebuildDMList(data);
  });
}
function renderActive(data){
  activeContainer.innerHTML='';
  const channels = ['exuro','sam','nero','nora','loktal'];
  let total=0;
  channels.forEach(ch=>{
    const users = data[ch]||{};
    total += Object.keys(users).length;
    const sec=document.createElement('div');
    sec.innerHTML=`<div style="font-weight:700;margin:6px 0">//${ch.toUpperCase()} (${Object.keys(users).length})</div>`;
    const list=document.createElement('div');
    Object.entries(users).forEach(([id,u])=>{
      const row=document.createElement('div');row.className='user-row tooltip';
      const dot=document.createElement('div');dot.className='status-dot';
      const name=document.createElement('div');name.className='uname';name.textContent=u.name;
      name.onclick=()=>openDM(id,u.name);
      const tip=document.createElement('div');tip.className='tip';tip.textContent='Click to DM';
      name.appendChild(tip);
      row.append(dot,name);
      list.appendChild(row);
    });
    sec.appendChild(list);
    activeContainer.appendChild(sec);
  });
  userCountSmall.textContent = total + (total===1?' user':' users');
}
function rebuildDMList(data){
  dmList.innerHTML='';
  const seen=new Set();
  for(const ch in data){
    for(const id in data[ch]){
      if(id===uid||seen.has(id))continue;
      seen.add(id);
      const b=document.createElement('div');
      b.textContent=data[ch][id].name;
      b.style.cssText='padding:4px;border:1px solid #ccc;margin:2px 0;cursor:pointer';
      b.onclick=()=>openDM(id,data[ch][id].name);
      dmList.appendChild(b);
    }
  }
}

/* ───── DM WINDOWS ───── */
async function registerDMPair(targetUid){
  const pid=[uid,targetUid].sort().join('_');
  const updates={};
  updates[`dmPairs/${pid}/users/${uid}`]=true;
  updates[`dmPairs/${pid}/users/${targetUid}`]=true;
  await update(ref(db),updates);
}
function openDM(tuid,tname){
  if(tuid===uid) return alert("Can't DM yourself");
  registerDMPair(tuid);
  const pid=[uid,tuid].sort().join('_');
  const win=document.createElement('div');win.className='dm-window';
  win.style.right='20px';win.style.bottom='20px';
  const title=document.createElement('div');title.className='dm-title';title.textContent=`DM: ${tname}`;
  const msgs=document.createElement('div');msgs.style.cssText='height:180px;overflow:auto;border:1px solid #ddd;margin-top:6px;padding:6px';
  const inp=document.createElement('input');inp.className='dm-input';inp.placeholder='Type…';
  const send=document.createElement('button');send.textContent='Send';
  const close=document.createElement('button');close.textContent='X';close.style.marginLeft='4px';
  win.append(title,msgs,inp,send,close);
  document.body.appendChild(win);
  makeDraggable(win,title);

  const dmRef=ref(db,`dm/${pid}`);
  onChildAdded(dmRef,snap=>{
    const o=snap.val();
    const el=document.createElement('div');el.className='dm-msg';
    el.style.textAlign = (o.from===uid?'right':'left');
    el.textContent = `${o.fromName}: ${o.msg}`;
    msgs.appendChild(el);msgs.scrollTop=msgs.scrollHeight;
  });

  send.onclick=async()=>{
    const txt=inp.value.trim();
    if(!txt||txt.length>1000) return;
    const ts=Date.now();
    const h=await hash(JSON.stringify({from:uid,to:tuid,msg:txt,ts}));
    const key=push(ref(db,`dm/${pid}`)).key;
    const updates={};
    updates[`/dm/${pid}/${key}`]={from:uid,to:tuid,fromName:myHandle,toName:tname,msg:txt,ts};
    updates[`/dmHashes/${h}`]={pid,key,ts,from:uid};
    await update(ref(db),updates);
    inp.value='';soundMsg.play().catch(()=>{});
  };
  close.onclick=()=>{off(dmRef);win.remove();};
}
function makeDraggable(el,bar){
  let ox=0,oy=0,drag=false;
  bar.onmousedown=e=>{drag=true;ox=e.clientX-el.getBoundingClientRect().left;oy=e.clientY-el.getBoundingClientRect().top;};
  document.onmousemove=e=>{if(drag){el.style.left=(e.clientX-ox)+'px';el.style.top=(e.clientY-oy)+'px';}};
  document.onmouseup=()=>{drag=false;};
}

/* ───── CHAT ───── */
function listenChannel(ch){
  for(const c in channelListeners) off(channelListeners[c].ref);
  currentChannel=ch;
  document.getElementById('winChannelLabel').textContent='//'+ch.toUpperCase();
  chatMessages.innerHTML='';
  const r=ref(db,`chat/${ch}`);
  const fn=snap=>{
    const o=snap.val(); if(!o) return;
    const row=document.createElement('div');row.className='chat-row';
    const av=document.createElement('div');av.className='chat-avatar';av.textContent=(o.name||'?').slice(0,2).toUpperCase();
    const bub=document.createElement('div');bub.className='chat-bubble';
    if(o.uid===uid) bub.classList.add('me');
    bub.innerHTML=`<div class="chat-meta">${o.name} · ${new Date(o.ts).toLocaleTimeString()}</div><div>${esc(o.msg)}</div>`;
    row.append(av,bub);
    chatMessages.appendChild(row);
    chatMessages.scrollTop=chatMessages.scrollHeight;
  };
  onChildAdded(r,fn);
  channelListeners[ch]={ref:r,fn};
}
async function postMessage(ch,name,msg){
  const m=msg.trim();
  if(!m||m.length>500) return;
  const ts=Date.now();
  const h=await hash(`${ch}|${name}|${m}|${uid}|${Math.floor(ts/1000)}`);
  const key=push(ref(db,`chat/${ch}`)).key;
  const updates={};
  updates[`/chat/${ch}/${key}`]={name,msg:m,ts,uid,hash:h};
  updates[`/msgHashes/${h}`]={channel:ch,key,ts,uid};
  await update(ref(db),updates);
  set(ref(db,`online/${ch}/${uid}`),{name,ts:Date.now(),channel:ch,uid});
}

/* ───── BOARD ───── */
function listenBoard(){
  onChildAdded(ref(db,'board'),snap=>{
    const p=snap.val();
    const el=document.createElement('div');el.className='board-thread';
    el.innerHTML=`<strong>${esc(p.name)}</strong><div style="margin-top:4px">${esc(p.msg)}</div><div class="small" style="margin-top:4px">${new Date(p.ts).toLocaleString()}</div>`;
    boardList.prepend(el);
  });
}

/* ───── UI HOOKS ───── */
sendBtn.onclick=()=>{ if(!myHandle) return alert('Login first'); postMessage(channelSelect.value,myHandle,chatInput.value); chatInput.value=''; soundMsg.play().catch(()=>{}); };
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});
postBoardBtn.onclick=async()=>{
  const n=boardName.value.trim(), m=boardMsg.value.trim();
  if(!n||!m||n.length>100||m.length>1000) return alert('Invalid');
  const r=push(ref(db,'board'));
  await set(r,{name:n,msg:m,ts:Date.now(),uid});
  boardName.value='';boardMsg.value='';
};
closeChatBtn.onclick=()=>{document.querySelector('.chat-win').style.display='none';};
channelSelect.onchange=()=>{listenChannel(channelSelect.value);setPresence(myHandle,channelSelect.value);};
ortegaBtn.onclick=()=>{alert('Project ://ORTEGA – RAG-LM integration coming soon');};

/* ───── STARTUP ───── */
watchOnline(); listenBoard(); listenChannel(currentChannel); appendSystem('Initializing...');

/* ───── PARTICLES ───── */
const pc=document.getElementById('particleCanvas'),ctx=pc.getContext('2d');
function resize(){pc.width=innerWidth;pc.height=innerHeight;} resize(); addEventListener('resize',resize);
let particles=[];
function spawn(x,y){particles.push({x,y,vx:(Math.random()-0.5)*0.8,vy:(Math.random()-0.5)*0.8,life:45,size:Math.random()*2+1});}
addEventListener('mousemove',e=>spawn(e.clientX,e.clientY));
function loop(){
  ctx.clearRect(0,0,pc.width,pc.height);
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.life--;
    ctx.fillStyle=`rgba(0,255,0,${p.life/45})`;
    ctx.fillRect(p.x,p.y,p.size,p.size);
    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(loop);
} loop();

/* ───── PRUNE OLD CHAT (24 h) ───── */
setInterval(async()=>{
  const snap=await get(ref(db,'chat'));
  const data=snap.val()||{};
  for(const ch in data){
    for(const id in data[ch]){
      if(data[ch][id].ts && Date.now()-data[ch][id].ts>24*60*60*1000){
        await remove(ref(db,`chat/${ch}/${id}`));
      }
    }
  }
},60*60*1000);
</script>
</body>
</html>
