<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Before Us Universe — BUU</title>
<style>
:root{
  --bg:#070709;--panel:#0f1112;--muted:#cfdff0;--accent:#00e6ff;
  --exuro:#aaf;--sam:#ffb470;--comp-bg:#0b0b0b;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#050507 0%,#0b0b0b 100%);color:var(--muted);font-family:"Courier New",monospace;}
a{color:var(--accent);text-decoration:none;}
.container{max-width:1200px;margin:18px auto;padding:18px;display:flex;flex-direction:column;gap:12px;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
header h1{margin:0;font-size:1.6rem;letter-spacing:1px}
.topbar{display:flex;gap:8px;align-items:center}
.links{display:flex;gap:8px}
.links a{display:inline-block;padding:6px 10px;border:1px solid rgba(0,230,255,0.12);border-radius:4px;color:var(--accent);background:transparent;font-size:0.9rem}
.status{font-size:0.9rem;color:#9fb8c9}
.maingrid{display:flex;gap:12px;align-items:stretch}
.leftcol{flex:2;display:flex;flex-direction:column;gap:12px;min-width:340px;}
.rightcol{flex:1;min-width:260px;display:flex;flex-direction:column;gap:12px}
.stream-toggle{display:flex;gap:8px;justify-content:center;margin-bottom:6px}
.btn{background:transparent;border:1px solid #222;color:var(--muted);padding:6px 10px;border-radius:4px;cursor:pointer}
.btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,230,255,0.03)}
.panel{background:var(--panel);border:1px solid #1e1f21;border-radius:6px;padding:12px;box-shadow:0 0 0 1px rgba(255,255,255,0.01) inset}
.stream{min-height:260px;overflow:auto;padding:8px;white-space:pre-wrap;font-size:0.95rem}
.stream p{margin:6px 0;padding:6px;border-radius:4px}
.stream .meta{font-size:0.8rem;color:#b9d3e0}
.exuro p{color:var(--exuro)}
.sam p{color:var(--sam)}
.glitch{position:relative;display:inline-block}
.glitch::before,.glitch::after{content:attr(data-text);position:absolute;left:0;top:0;opacity:0.7;color:var(--accent)}
.glitch::before{left:2px;text-shadow:-1px 0 var(--accent);animation:glitch1 2s infinite}
.glitch::after{left:-2px;text-shadow:1px 0 var(--accent);animation:glitch2 3s infinite}
@keyframes glitch1{0%,20%,40%,60%,80%,100%{transform:translate(0);}10%,30%,50%,70%,90%{transform:translate(-2px,1px)}}
@keyframes glitch2{0%,20%,40%,60%,80%,100%{transform:translate(0);}10%,30%,50%,70%,90%{transform:translate(2px,-1px)}}
.companion{background:#0b0e11;border:1px solid #1f2326;border-radius:6px;padding:10px;min-height:280px;overflow:auto}
.companion p{margin:6px 0;font-size:0.92rem;color:var(--accent)}
#activeUsers{background:#0b0e11;border:1px solid #1f2326;border-radius:6px;padding:8px;max-height:140px;overflow:auto}
#activeUsers p{margin:6px 0;color:#bfe8ff}
.input-area{display:flex;gap:8px;align-items:center;margin-top:6px}
.input-area input[type="text"],#handleField,#boardMsg{background:#0b0e11;border:1px solid #222;padding:8px;border-radius:4px;color:var(--muted);width:100%;font-family:monospace}
.sendBtn{padding:8px 12px;border-radius:4px;background:var(--accent);color:#000;border:none;cursor:pointer;font-weight:700}
#boardFrame{width:100%;height:500px;border:1px solid #222;border-radius:6px;background:#060708}
#bootScreen{position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--accent);font-family:monospace}
.boot-line{white-space:pre;font-size:1rem;margin:2px 0;opacity:0.95}
.boot-progress{margin-top:10px;border:1px solid rgba(255,255,255,0.03);padding:6px;width:60%;border-radius:4px;color:#bfe8ff}
.small{font-size:0.85rem;color:#9fb8c9}
@media(max-width:980px){.maingrid{flex-direction:column}#boardFrame{height:320px}}
</style>
</head>
<body>
<div id="bootScreen">
  <div class="boot-line" id="bootLineA"></div>
  <div class="boot-line" id="bootLineB"></div>
  <div class="boot-line" id="bootLineC"></div>
  <div class="boot-progress" id="bootProgress">[......................] 0%</div>
</div>

<div class="container" id="app" style="display:none;">
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <h1>Before Us Universe</h1>
    <div class="small">— companion site to the book</div>
  </div>
  <div class="topbar">
    <div class="status">CHANNEL ACTIVITY: <span id="channelActivity">000</span></div>
    <div class="links">
      <a href="https://www.youtube.com/@Patrickauthor" target="_blank">YouTube</a>
      <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview" target="_blank">Reedsy</a>
      <a href="https://web.archive.org/" target="_blank">Web Archive</a>
    </div>
  </div>
</header>

<div class="maingrid">
<div class="leftcol">
<div class="panel">
  <div id="loginPanel">
    <div class="small">Enter a handle to join the BUU chatroom.</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="handleField" placeholder="Choose a handle (e.g. CommanderSam)">
      <button id="enterBtn" class="sendBtn">JOIN</button>
    </div>
  </div>
</div>

<div class="panel" style="margin-top:8px">
  <div class="stream-toggle">
    <button class="btn active" data-channel="exuro">EXURO</button>
    <button class="btn" data-channel="sam">SAM</button>
    <button class="btn" data-channel="nora">NORA</button>
    <button class="btn" data-channel="nero">NERO</button>
    <button class="btn" data-channel="loktal">LOKTAL</button>
    <button class="btn" data-channel="pilgrim">Pilgrim</button>
    <div style="flex:1"></div>
    <button id="openBoardBtn" class="btn">Open Message Board</button>
  </div>
  <div id="streamsContainer">
    <div id="exuro" class="stream exuro panel" style="display:block"></div>
    <div id="sam" class="stream sam panel" style="display:none"></div>
    <div id="nora" class="stream panel" style="display:none"></div>
    <div id="nero" class="stream panel" style="display:none"></div>
    <div id="loktal" class="stream panel" style="display:none"></div>
    <div id="pilgrim" class="stream panel" style="display:none"></div>
  </div>
  <div class="input-area" style="margin-top:10px">
    <input type="text" id="chatInput" placeholder="Write to current stream...">
    <button id="sendChat" class="sendBtn">POST</button>
  </div>
  <div class="small" style="margin-top:8px">Messages auto-delete after 24 hours.</div>
</div>

<div class="panel" style="margin-top:8px">
  <div class="small">Community message board (ProBoards)</div>
  <iframe id="boardFrame" src="https://tokillamockinggoblin.boards.net/page/external-widget" title="ProBoards message board"></iframe>
</div>
</div>

<div class="rightcol">
<div class="panel companion">
  <strong style="color:#bfe8ff">Companion Log</strong>
  <div id="companionLog" style="margin-top:8px"></div>
</div>

<div class="panel">
  <strong>Active Users</strong>
  <div id="activeUsers"></div>
</div>

<div class="panel">
  <strong>Recent Activity</strong>
  <div id="recentActivity" style="margin-top:8px"></div>
</div>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.firebasestorage.app",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------- Boot ----------
const bootScreen=document.getElementById('bootScreen');
const bootLines=["SYSTEM BOOT","Loading Lux telemetry","Calibrating Vestus sensors","Decrypting Anu keys","Mounting Companion log","Finalizing boot"];
let i=0;
function bootStep(){
  if(i>=bootLines.length){bootScreen.style.display='none';document.getElementById('app').style.display='block';return;}
  const line=document.createElement('div'); line.className='boot-line'; line.textContent=bootLines[i++]; bootScreen.appendChild(line);
  setTimeout(bootStep,400+Math.random()*400);
}
bootStep();

// ---------- Login ----------
let handle=null, currentChannel='exuro', presenceRef=null;
document.getElementById('enterBtn').addEventListener('click',()=>{
  handle = (document.getElementById('handleField').value||'Anon'+Math.floor(Math.random()*9999)).replace(/[^a-zA-Z0-9]/g,'');
  document.getElementById('loginPanel').style.display='none';
  presenceRef=db.ref('online/'+handle); presenceRef.set(true); presenceRef.onDisconnect().remove();
  addSystemActivity(`${handle} joined`);
  listenChat(); listenOnline(); listenBoard(); startCompanionLore();
});

// ---------- Channels ----------
document.querySelectorAll('.stream-toggle .btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.stream-toggle .btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); switchChannel(b.dataset.channel);
  });
});
function switchChannel(ch){currentChannel=ch; document.querySelectorAll('.stream').forEach(d=>d.style.display=(d.id===ch)?'block':'none');}

// ---------- Chat ----------
const chatRef=db.ref('chat');
document.getElementById('sendChat').addEventListener('click',()=>{postChat(document.getElementById('chatInput').value);});
document.getElementById('chatInput').addEventListener('keypress',e=>{if(e.key==='Enter') postChat(document.getElementById('chatInput').value);});
function postChat(msg){if(!msg||!handle) return; chatRef.push({name:handle,msg:msg.slice(0,500),ts:Date.now(),channel:currentChannel}); document.getElementById('chatInput').value='';}

// ---------- Board ----------
const boardRef=db.ref('board');
function listenBoard(){boardRef.limitToLast(50).on('child_added',snap=>{const obj=snap.val(); if(!obj) return; const p=document.createElement('p'); p.textContent=`[${obj.name}] ${obj.title||''}: ${obj.msg}`; document.getElementById('recentActivity').appendChild(p);});}
document.getElementById('openBoardBtn').addEventListener('click',()=>{window.open('https://tokillamockinggoblin.boards.net','_blank');});

// ---------- Active Users ----------
function listenOnline(){db.ref('online').on('value',snap=>{const ul=document.getElementById('activeUsers'); ul.innerHTML=''; let cnt=0; snap.forEach(ch=>{const p=document.createElement('p'); p.textContent=ch.key; ul.appendChild(p); cnt++;}); document.getElementById('channelActivity').textContent=String(cnt).padStart(3,'0');});}

// ---------- Chat listener ----------
function listenChat(){chatRef.limitToLast(200).on('child_added',snap=>{const obj=snap.val(); if(!obj||!obj.msg) return; const target=document.getElementById(obj.channel)||document.getElementById('exuro'); const p=document.createElement('p'); p.innerHTML=`<span class="meta">[${obj.name}]</span> ${obj.msg}`; target.appendChild(p); target.scrollTop=target.scrollHeight;});}

// ---------- Companion Log ----------
const loreLines=["Exuro: Energy readings spike across Vestus","Sam: Temporal instability detected","Nora: Sensors show interference","Nero: Tactical arrays recalibrating","Loktal: Vessels on rim detected"];
function startCompanionLore(){let i=0; setInterval(()=>{const p=document.createElement('p'); p.textContent=loreLines[i++ % loreLines.length]; document.getElementById('companionLog').appendChild(p);},5000);}

// ---------- System activity ----------
function addSystemActivity(msg){const p=document.createElement('p'); p.textContent=msg; document.getElementById('recentActivity').appendChild(p);}

// ---------- Prune old messages ----------
function pruneOld(){const cutoff=Date.now()-24*60*60*1000; chatRef.once('value',snap=>{snap.forEach(s=>{if(s.val().ts<cutoff)s.ref.remove();});}); boardRef.once('value',snap=>{snap.forEach(s=>{if(s.val().ts<cutoff)s.ref.remove();});}); setTimeout(pruneOld,60*60*1000);} pruneOld();

// ---------- Secret Pilgrim channel unlock ----------
document.getElementById('handleField').addEventListener('keypress',e=>{
  if(e.key==='Enter' && e.target.value.toLowerCase()==='pilgrim123'){document.querySelector('[data-channel="pilgrim"]').style.display='block'; addSystemActivity('Pilgrim channel unlocked');}
});
</script>
</body>
</html>
