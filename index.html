<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Before Us Universe — BUU</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23001a1a'/><path d='M20 25h60v10h-60zM20 45h60v10h-60zM20 65h60v10h-60z' fill='%2300ffff'/><circle cx='50' cy='50' r='8' fill='%23ffcc00'/></svg>" type="image/svg+xml">
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<style>
:root{
--bg:#001a1a; --fg:#00ffff; --accent:#ffcc00; --border:#00cccc; --panel-bg:#002b2b;
--text-gray:#e6f7f7; --muted:#00aaaa; --online:#00ff9d; --yahoo-blue:#1e73be; --yahoo-dark:#0961a6;
}
html,body{margin:0;height:100%;font-family:'Roboto Mono',monospace;background:var(--bg);color:var(--fg);overflow:auto}
body{background:url('https://wallpapercave.com/wp/wp4468245.jpg') center/cover no-repeat}
#crt::before{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.06),rgba(0,0,0,0.06) 2px,transparent 2px,transparent 4px);pointer-events:none;z-index:999}
a.link-btn{background:var(--accent);color:#000;padding:6px 12px;border-radius:4px;font-weight:700;cursor:pointer;border:2px solid #000;margin:2px;font-size:11px;text-decoration:none;display:inline-block}
.panel-title::before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.03),rgba(0,0,0,0.03) 1px,transparent 1px,transparent 2px);pointer-events:none;opacity:0.5;}
.panel{border:3px solid var(--border); background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFElEQVR42mNk+A8AAwUBAScAAAQq9gD31A+6AAAAAElFTkSuQmCC') repeat; margin-bottom:20px;}
@keyframes glitch{2%,64%{transform:translate(2px,0) skew(5deg);}4%,60%{transform:translate(-2px,0) skew(-5deg);}62%{transform:translate(0,0) skew(3deg);}}
.glitch{animation:glitch 1s linear infinite;}
.glitch-update{animation:glitch 0.5s linear;}
.panel-title{animation:warp 1s ease-in;}
@keyframes warp{0%{transform:skewX(10deg);}100%{transform:skewX(0);}}
#marquee{position:relative;}
#marquee .particle{position:absolute;width:2px;height:2px;background:var(--fg);opacity:0.5;border-radius:50%;animation:float 5s linear infinite;}
@keyframes float{0%{transform:translate(0,0);}100%{transform:translate(20px,-20px);opacity:0;}}
.toggle-btn{background:var(--accent);color:#000;border:2px solid #000;padding:4px 8px;cursor:pointer;font-size:10px;margin-left:auto;animation:flicker 0.5s infinite alternate;}
@keyframes flicker{0%{opacity:1;}100%{opacity:0.7;}}
.panel-body{display:block;}
.collapsed .panel-body{display:none;}
#boardSearch{background:#001f1f;border:2px solid var(--border);color:var(--fg);padding:8px;width:100%;font-family:monospace;margin-bottom:8px;}
#marqueeWrap{position:fixed;left:0;right:0;top:0;height:38px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));z-index:99999;display:flex;align-items:center;padding:6px 12px;box-sizing:border-box}
#marqueeLabel{font-family:'Press Start 2P';font-size:12px;color:#fff;margin-right:12px;white-space:nowrap}
#marquee{flex:1;overflow:hidden;position:relative;height:20px}
#marqueeInner{position:absolute;white-space:nowrap;will-change:transform;display:inline-block;padding-left:100%}
#bootOverlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.9),rgba(0,0,0,0.95));color:var(--fg);z-index:99998;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:'Roboto Mono',monospace}
#bootPanel{width:92%;max-width:820px;background:var(--panel-bg);border:4px solid var(--border);padding:18px;box-shadow:0 0 30px rgba(0,255,255,0.06)}
#bootLog{line-height:1.6;white-space:pre-wrap;margin-bottom:12px;font-size:13px;color:var(--text-gray)}
#bootPrompt{color:var(--accent);margin-bottom:6px;animation:blink 1s step-end infinite;}
@keyframes blink{50%{opacity:0;}}
#bootInputs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#bootInput{background:#001f1f;border:2px solid var(--border);color:var(--fg);padding:8px;width:48%;min-width:160px;font-family:monospace}
#bootChannel{background:#001f1f;border:2px solid var(--border);color:var(--fg);padding:8px;font-family:monospace;width:48%;min-width:160px}
#bootBtn{background:var(--accent);border:2px solid #000;color:#000;padding:8px 14px;cursor:pointer;font-weight:700}
#bootBanner{margin-top:10px;background:rgba(0,0,0,0.35);padding:8px;border-radius:4px;color:var(--fg);font-size:12px}
#bootBroadcast{animation:glitch 3s infinite alternate;}
#app{display:none;padding:56px 12px 12px 12px;box-sizing:border-box;height:100%;overflow:auto}
.title-bar{display:flex;gap:8px;flex-wrap:nowrap;padding:8px;background:transparent;color:#fff;font-family:'Press Start 2P';font-size:13px;align-items:center;justify-content:flex-start;overflow-x:auto}
.title-bar::-webkit-scrollbar{height:12px;background:var(--panel-bg);border:1px solid var(--border);}
.title-bar::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px;}
.title-bar .logo{font-weight:700;letter-spacing:1px}
.controls-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
@media(max-width:980px){.layout{grid-template-columns:1fr}.layout > div:last-child{order:-1;}}
@media (max-width:600px){.title-bar{flex-wrap:nowrap;overflow-x:auto;}.title-bar{font-size:11px;}}
.panel{background:var(--panel-bg);border-radius:4px;box-shadow:0 0 12px rgba(0,255,255,0.08);margin-bottom:12px;overflow:hidden;position:relative;}
.panel-title{display:flex;align-items:center;justify-content:space-between;padding:6px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:12px}
.panel-body{padding:8px;color:var(--text-gray)}
.yt-wrap iframe{width:100%;max-width:720px;height:405px;border:4px solid var(--border);}
@media(max-width:600px){.yt-wrap iframe{height:200px;}}
.chat-win{display:flex;flex-direction:column;height:520px}
@media(max-width:600px){.chat-win{height:400px;}}
.chat-title{display:flex;justify-content:space-between;align-items:center;padding:8px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:12px}
.chat-main{display:flex;flex:1;overflow:hidden}
.chat-messages{flex:1;overflow:auto;background:#e6e6fa;border-right:1px solid rgba(0,0,0,0.1);padding:8px;color:#000}
.chat-users{background:#fffacd;border-left:1px solid rgba(0,0,0,0.1);padding:8px;overflow:auto;width:200px}
@media(max-width:700px){.chat-main{flex-direction:column}.chat-users{width:auto;border-left:0;border-top:1px solid rgba(0,0,0,0.1)}}
.chat-row{display:flex;gap:8px;margin:6px 0;align-items:flex-start}
.chat-avatar{width:36px;height:36px;border-radius:50%;background:#add8e6;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#001a1a}
@media(max-width:600px){.chat-avatar{width:24px;height:24px;font-size:10px;}}
.chat-bubble{max-width:78%;padding:10px;border-radius:8px;background:#e6e6fa;border:1px solid rgba(0,0,0,0.1);font-family:Arial;color:#000}
.chat-bubble.me{background:#fffacd;border:1px solid #f0d280;text-align:right;color:#222}
.chat-meta{font-size:11px;color:#808080;font-weight:700;margin-bottom:4px}
@media(max-width:600px){.chat-meta{font-size:9px;}}
.user-row{display:flex;gap:8px;align-items:center;padding:6px;font-size:12px;cursor:pointer}
@media(max-width:600px){.user-row{font-size:10px;}}
.status-dot{width:9px;height:9px;border-radius:50%;background:var(--online)}
.uname{font-family:'Press Start 2P';color:#ff0000;font-size:12px}
@media(max-width:600px){.uname{font-size:10px;}}
.chat-controls{display:flex;gap:6px;padding:8px;background:#fffacd;border-top:1px solid rgba(0,0,0,0.1)}
.chat-controls input{flex:1;padding:8px;border:2px inset rgba(0,0,0,0.1);background:#fff;color:#000}
.chat-controls button{padding:8px;border:2px outset rgba(0,0,0,0.1);background:#add8e6;cursor:pointer;color:#000}
.board-thread{background:#f0f8ff;border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:4px;font-family:Arial;color:#000;white-space:pre-wrap;}
.board-thread:nth-child(even) {background: #f0f0f0;}
.board-thread strong{color:#000080;font-size:14px}
.board-thread .small{color:#808080;font-style:italic;margin-top:4px;display:block}
#serverSelectPanel{margin-bottom:12px;padding:8px}
#serverSelectPanel .controls{display:flex;gap:8px;align-items:center}
#serverSelectPanel select{flex:1;padding:12px;background:#001f1f;border:3px solid var(--border);color:var(--fg);font-weight:700;font-size:14px;border-radius:6px}
#serverConfirm{background:var(--accent);color:#000;padding:10px;border:3px solid #000;cursor:pointer;font-weight:900;border-radius:6px;font-size:14px;box-shadow:0 0 10px var(--accent)}
#ortegaPanel button{width:100%;background:var(--accent);color:#000;padding:12px;border:3px solid #000;border-radius:6px;font-weight:900;cursor:pointer;font-size:14px}
#serverTrackingPanel .server-branch{margin-bottom:12px}
#serverTrackingPanel .server-title{font-weight:700;color:var(--accent);font-size:13px;cursor:pointer}
#serverTrackingPanel .user-list{margin-left:12px;margin-top:4px;font-size:12px}
#serverTrackingPanel .user-list div{margin:2px 0;padding:6px;background:#001f1f;border-radius:4px;cursor:pointer}
#serverTrackingPanel .current-server .server-title{color:#000;background:var(--accent);padding:6px;border-radius:4px}
.server-title .status-icon{margin-left:5px;font-size:14px;}
.status-icon.animated{animation:pulse 1s infinite alternate;}
@keyframes pulse{0%{opacity:1;}100%{opacity:0.5;}}
#systemFeed{max-height:100px;overflow:auto;background:var(--panel-bg);border:2px solid var(--border);padding:6px;font-size:12px;color:var(--text-gray)}
.dm-inline{border:1px solid rgba(255,255,255,0.03);padding:6px;margin:6px 0;background:#021212;border-radius:4px}
.small{font-size:11px;color:var(--muted)}
.typing-indicator { font-size: 12px; color: var(--muted); padding: 6px; font-style: italic; }
body,html{overflow-x:hidden}
a, button, .user-row{ -webkit-tap-highlight-color: transparent;}
a:active, button:active, .user-row:active{animation:glitch 0.2s;}
#revivalSitesPanel a {color: #ffffff;}
@media(max-width:600px){.panel{margin-bottom:12px;}.panel-title{font-size:10px;}.panel-body{padding:6px;font-size:12px;}}
body.glitch-transition{animation:glitch 1s linear, vhs 1s linear;}
@keyframes vhs{0%,100%{filter:brightness(1) contrast(1);}20%{filter:brightness(1.2) contrast(1.5);transform:skew(0.5deg);}40%{filter:brightness(0.8) contrast(0.8);transform:translate(2px,1px);}60%{filter:brightness(1.1) contrast(1.2);transform:skew(-0.5deg);}80%{filter:brightness(0.9) contrast(1);transform:translate(-2px,-1px);}}
.ad-banner{background:yellow;color:black;border:2px dashed red;padding:10px;margin:10px 0;font-family:'Press Start 2P';text-align:center;font-size:10px;animation:flash 2s infinite;}
@keyframes flash{0%{opacity:1;}50%{opacity:0.8;}100%{opacity:1;}}
body{-webkit-overflow-scrolling:touch;overflow-y:scroll;}
::-webkit-scrollbar{width:12px;background:var(--panel-bg);border:1px solid var(--border);}
::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px;}
#revivalSitesPanel .panel-body{max-height:100px;overflow:auto;}
#emailPanel .panel-body{height:auto;padding:4px;}
#ytBody .panel-body{height:auto;}
#soraBody .panel-body{height:auto;}
#boardBody{height:600px;}
#emailPanel iframe{height:200px;}
#stumbleBtn{width:200px;}
#fleetcommandBody{height:80vh;}
#entityBody{height:80vh;}
#tacticalBody{height:80vh;}
@media(max-width:600px){#fleetcommandBody{height:70vh;}}
@media (min-width: 601px) {
#startScreen h1 {font-size: 48px;}
.mode-btn {padding: 20px 40px; font-size: 20px;}
#hud {font-size: 16px;}
#controls {font-size: 14px;}
.ship-btn {padding: 10px 15px; font-size: 14px;}
}
.message { margin-bottom: 10px; }
.user { color: #ff0; }
.bot { color: #0f0; }
a { color: #0ff; text-decoration: underline; }
.donate-flash { animation: flash 1s infinite; display: inline-block; margin-left: 5px; }
</style>
</head>
<body>
<div id="marqueeWrap">
<div id="marqueeLabel">SYSTEM:</div>
<div id="marquee" aria-live="polite"><div id="marqueeInner">C:\\> Welcome to the Before Us Network — system: stable … MEMORY OK — DISK CHECK PASSED — NETWORK ACTIVE — AWAITING COMMAND… — — Site Under Construction —</div></div>
</div>
<iframe src="bootpage.html" style="position:fixed;inset:0;z-index:99998;width:100%;height:100%;border:none;"></iframe>
<div id="app">
<div class="title-bar">
<div class="logo">C//:BUU</div>
<a class="link-btn" href="https://www.paypal.com/paypalme/pmcdon13" target="_blank" rel="noopener noreferrer">PayPal<span class="donate-flash">Donate</span></a>
<a class="link-btn" href="https://venmo.com/hisrobustness" target="_blank" rel="noopener noreferrer">Venmo<span class="donate-flash">Donate</span></a>
<a class="link-btn" href="https://tokillamockinggoblin.boards.net/" target="_blank" rel="noopener noreferrer" title="Join Sam's DND Realm">To Kill a Mocking Goblin</a>
<a class="link-btn" href="https://youtube.com/@Patrickauthor" target="_blank" rel="noopener noreferrer">Melphia's YouTube</a>
<a class="link-btn" href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview" target="_blank" rel="noopener noreferrer" title="on reedsy">Read Sam's First Chapter</a>
<a class="link-btn" href="https://sora.chatgpt.com/profile/robustpvp" target="_blank" rel="noopener noreferrer">Sora</a>
<div class="controls-right">
</div>
</div>
<div style="text-align:center; margin:12px 0;">
<button id="stumbleBtn" style="background:var(--accent);color:#000;padding:10px;border:3px solid #000;cursor:pointer;font-weight:900;border-radius:6px;font-size:14px;display:inline-block;width:200px;margin:0 6px;">Stumble</button>
<button id="emailBtn" style="background:var(--accent);color:#000;padding:10px;border:3px solid #000;cursor:pointer;font-weight:900;border-radius:6px;font-size:14px;display:inline-block;width:200px;margin:0 6px;">Join Email List</button>
<button id="mindGameBtn" style="background:var(--accent);color:#000;padding:10px;border:3px solid #000;cursor:pointer;font-weight:900;border-radius:6px;font-size:14px;display:inline-block;width:200px;margin:0 6px;">//Mind Game (Under Construction)</button>
</div>
<div class="layout">
<div>
<iframe src="chatservers.html" style="width:100%; height:600px; border:none;"></iframe>
<div class="panel">
<div class="panel-title"><div class="title">//Discord</div></div>
<div class="panel-body">
<iframe src="https://discord.com/widget?id=1442244817265492070&theme=dark" width="100%" height="300" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
<a class="link-btn" href="https://discord.gg/kWkPH8d9" target="_blank" rel="noopener noreferrer">Join Discord</a>
</div>
</div>
<div class="panel collapsible collapsed">
<div class="panel-title"><div class="title">//PLAYLIST.SAM</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body" id="ytBody">
<div class="yt-wrap" style="margin:8px">
<iframe src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq" allowfullscreen></iframe>
</div>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
<div class="panel collapsible collapsed">
<div class="panel-title"><div class="title">//shortstreams.youtube</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body" id="soraBody">
<div id="shortstreams-wrap">
<iframe src="https://www.youtube.com/embed/videoseries?list=PLDpwpKvok1S8ff8zQ9joe7wx3QrL977Wu" allowfullscreen allow="autoplay; fullscreen"></iframe>
</div>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
<div class="panel collapsible collapsed">
<div class="panel-title"><div class="title">//fleetcommand (Under Construction)</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body" id="fleetcommandBody">
<iframe src="fleet.html" style="width:100%; height:100%; border:none;"></iframe>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
<iframe src="messageboards.html" style="width:100%; height:600px; border:none;"></iframe>
<div class="panel collapsible collapsed">
<div class="panel-title"><div class="title">//ENTITY (Under Construction)</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body" id="entityBody">
<iframe src="entity.html" style="width:100%; height:100%; border:none;"></iframe>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
<div class="panel collapsible collapsed">
<div class="panel-title"><div class="title">//TACTICALCOMMAND (Under Construction)</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body" id="tacticalBody">
<iframe src="tacticalcommand.html" style="width:100%; height:100%; border:none;"></iframe>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
</div>
<div>
<div class="panel" id="systemFeedPanel">
<div class="panel-title"><div class="small">SYSTEM FEED</div></div>
<div class="panel-body" id="systemFeed"></div>
</div>
<div class="panel" id="serverTrackingPanel">
<div class="panel-title"><div class="small">SERVER LIST</div></div>
<div class="panel-body" id="serverTrackingList" style="height:auto;min-height:150px;"></div>
<div id="dmList" style="margin-top:8px"></div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
<div id="ortegaPanel"><button id="ortegaBtn" aria-label="Project Ortega">Project ://ORTEGA (Under Maintenance)</button>
<div id="ortegaIframeContainer" style="display:none; max-height:300px; overflow-y:scroll; margin-top:10px; border:1px solid var(--border); padding:10px;">
<iframe id="ortegaIframe" src="" style="width:100%; height:100%;"></iframe>
</div>
</div>
<a href="https://sora.chatgpt.com/p/s_692415bc74c08191a0a5348aee788ebc?psh=HXVzZXItQ1F0ZXFVc3BzQ09hMzI5am9ycW5JS1Y1.h1JfPIVieaPG" target="_blank">
    <div class="ad-banner">Teleportors and Syntheizers only 999 credits</div>
</a>

<a href="https://sora.chatgpt.com/p/s_692415a63f0081918d36fcfb2535670c?psh=HXVzZXItQ1F0ZXFVc3BzQ09hMzI5am9ycW5JS1Y1.kJdH5e8d4z6b" target="_blank">
    <div class="ad-banner">Service: Time Travel Tours - See Dinosaurs!</div>
</a>

<a href="https://sora.chatgpt.com/p/s_6917fddaa4288191b1f8ebac4e791e56?psh=HXVzZXItQ1F0ZXFVc3BzQ09hMzI5am9ycW5JS1Y1.Sigsv6ochclj" target="_blank">
    <div class="ad-banner">Do you need more arms? Try Hexapro!</div>
</a>

<a href="https://sora.chatgpt.com/p/s_692415c7495c81919299dd5fccc83844?psh=HXVzZXItQ1F0ZXFVc3BzQ09hMzI5am9ycW5JS1Y1.v5d8OyNRYbyD" target="_blank">
    <div class="ad-banner">Have you or a loved one been affected by the mandela effect? Contact our time anomaly attorneys today!</div>
</a>
<div style="text-align:center; margin:12px 0;">
<a class="link-btn" href="https://spacehey.com/profile?id=4317004" target="_blank" rel="noopener noreferrer" title="Find Patrick on Spacehey">SpaceHey</a>
<a class="link-btn" href="https://web.archive.org/" target="_blank" rel="noopener noreferrer">Wayback Machine</a>
<a class="link-btn" href="https://www.oldversion.com/" target="_blank" rel="noopener noreferrer">OldVersion.com</a>
</div>
</div>
</div>
<div class="bottom-section">
<div class="panel collapsible collapsed">
<div class="panel-title"><div class="title">//GALLERIES</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body">
<iframe src="galleries.html" style="width:100%; height:80vh; border:none;"></iframe>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
</div>
<div class="panel collapsible collapsed" id="revivalSitesPanel">
<div class="panel-title"><div class="small">//REVIVAL.SITES</div><div class="toggle-btn" aria-label="Toggle">▼</div></div>
<div class="panel-body" style="height:auto;overflow:auto">
<iframe src="revival.html" style="width:100%; height:400px; border:none;"></iframe>
</div>
<div class="toggle-btn bottom-toggle" aria-label="Toggle">▲</div>
</div>
<div class="ticker" id="visitorPanel">
<div id="visitorCounter">Visitors: Loading...</div>
<div id="hitCounter">Hits: Loading...</div>
</div>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded,onValue, remove, onDisconnect, update, get, off, onChildRemoved, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",authDomain:"before-us-universe.firebaseapp.com",databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",projectId:"before-us-universe",storageBucket:"before-us-universe.firebasestorage.app",messagingSenderId:"477103463228",appId:"1:477103463228:web:01b53b6b29cb9d54315c39"};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const appRoot = document.getElementById('app');
const systemFeed = document.getElementById('systemFeed');
const dmList = document.getElementById('dmList');
const ortegaBtn = document.getElementById('ortegaBtn');
const marqueeInner = document.getElementById('marqueeInner');
const marqueeWrap = document.getElementById('marquee');

let uid = null, myHandle = null, currentChannel = 'exuro', presenceRef = null;
let feedCache = [];
let ortegaClickCount = 0;

onAuthStateChanged(auth, u => { if(u) uid = u.uid; });

// Listen for messages from iframes
window.addEventListener('message', (event) => {
  // Handle boot completion from bootpage iframe
  if (event.data.type === 'bootComplete') {
    myHandle = event.data.handle;
    currentChannel = event.data.channel;
    uid = event.data.uid;
    
    // Hide the iframe
    const bootIframe = document.querySelector('iframe[src="bootpage.html"]');
    if (bootIframe) {
      bootIframe.style.display = 'none';
    }
    
    // Show the main app
    appRoot.style.display = 'block';
    
    // Initialize presence
    presenceRef = ref(db, `online/${currentChannel}/${uid}`);
    set(presenceRef, {uid, name: myHandle, typing: false});
    onDisconnect(presenceRef).remove();
    
    appendSystem(`Connected as ${myHandle} on //${currentChannel.toUpperCase()}`);
    initializePanels();
  }
  
  // Send user data to chatservers iframe when requested
  if (event.data.type === 'requestUserData') {
    // Send user data to the iframe that requested it
    event.source.postMessage({
      type: 'userData',
      handle: myHandle,
      uid: uid,
      channel: currentChannel
    }, '*');
  }
});

function prependFeedEntry(text){
  const el = document.createElement('div');
  el.className = 'dm-inline';
  el.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
  systemFeed.prepend(el);
  while(systemFeed.children.length > 80) systemFeed.removeChild(systemFeed.lastChild);
}

function updateMarqueeFromCache(){
  if(feedCache.length === 0){
    marqueeInner.textContent = "C:\\> Welcome to the Before Us Network — system: stable … MEMORY OK — DISK CHECK PASSED — NETWORK ACTIVE — AWAITING COMMAND… — Site Under Construction —";
    startMarqueeAnimation();
    return;
  }
  const text = feedCache.slice(0,8).map(item => item.text).join(' ✦ ');
  marqueeInner.textContent = ' ' + text + ' ';
  startMarqueeAnimation();
}

let marqueeAnimId = null;
function startMarqueeAnimation(){
  if(marqueeAnimId) cancelAnimationFrame(marqueeAnimId);
  const inner = marqueeInner;
  inner.style.transform = 'translateX(0)';
  const wrapWidth = marquee.offsetWidth;
  const innerWidth = inner.offsetWidth || wrapWidth * 1.5;
  const speed = 80;
  let start = null;
  function step(ts){
    if(!start) start = ts;
    const elapsed = (ts - start) / 1000;
    const distance = speed * elapsed;
    inner.style.transform = `translateX(${-distance}px)`;
    if(distance > innerWidth + wrapWidth) start = ts;
    marqueeAnimId = requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

const feedRef = ref(db, 'feed');
onChildAdded(feedRef, snap => {
  const obj = {key: snap.key, text: snap.val(), ts: Date.now()};
  feedCache.unshift(obj);
  if(feedCache.length > 40) feedCache.pop();
  prependFeedEntry(obj.text);
  updateMarqueeFromCache();
});

get(feedRef).then(snap => {
  const data = snap.val() || {};
  feedCache = Object.entries(data).map(([k,v]) => ({key:k, text:v}));
  updateMarqueeFromCache();
});

let onlineWatchRef = ref(db, 'online');
function watchOnline(){
  onValue(onlineWatchRef, snap => {
    const data = snap.val() || {};
    renderServerTracking(data);
  });
}

function renderServerTracking(data){
  serverTrackingList.innerHTML = '';
  const channels = ['sam','exuro','nero','nora','loktal'];
  channels.forEach(ch => {
    // Filter out users without names
    const users = Object.values(data[ch] || {}).filter(u => u.name);
    const count = users.length;
    const iconColor = count > 0 ? 'lime' : 'red';
    const branch = document.createElement('div');
    branch.className = `server-branch ${ch === currentChannel ? 'current-server' : ''}`;
    branch.innerHTML = `<div class="server-title">//${ch.toUpperCase()} (${count}) <span class="status-icon ${count > 0 ? 'animated' : ''}" style="color:${iconColor}">●</span></div><div class="user-list"></div>`;
    const userList = branch.querySelector('.user-list');
    if(count === 0){
      userList.innerHTML = '<div>—</div>';
    } else {
      users.forEach(u => {
        const div = document.createElement('div');
        div.textContent = u.name + (u.typing ? ' (typing...)' : '');
        div.onclick = () => openDMInline(u.uid, u.name);
        userList.appendChild(div);
      });
    }
    serverTrackingList.appendChild(branch);
  });
}

function watchPresenceEvents() {
  const channels = ['sam','exuro','nero','nora','loktal'];
  channels.forEach(ch => {
    onChildAdded(ref(db, `online/${ch}`), snap => {
      const u = snap.val();
      if (u && u.uid !== uid && u.name) appendSystem(`User '${u.name}' joined //${ch.toUpperCase()}`);
    });
    onChildRemoved(ref(db, `online/${ch}`), snap => {
      const u = snap.val();
      if (u && u.uid !== uid && u.name) appendSystem(`User '${u.name}' left //${ch.toUpperCase()}`);
    });
  });
}

ortegaBtn.onclick = () => {
  ortegaClickCount++;
  if (ortegaClickCount >= 18) {
    document.body.classList.add('glitch-transition');
    setTimeout(() => {
      document.getElementById('ortegaIframeContainer').style.display = 'block';
      document.getElementById('ortegaIframe').src = 'ortega.html';
    }, 500);
    setTimeout(() => document.body.classList.remove('glitch-transition'), 1000);
  }
};

async function registerDMPair(tuid){
  const pid = [uid, tuid].sort().join('_');
  const updates = {};
  updates[`dmPairs/${pid}/users/${uid}`] = true;
  updates[`dmPairs/${pid}/users/${tuid}`] = true;
  await update(ref(db), updates).catch(() => {});
}

function openDMInline(tuid, tname){
  if(tuid === uid || !tname) return;
  registerDMPair(tuid);
  const pid = [uid, tuid].sort().join('_');
  if(document.querySelector(`[data-dmid="${pid}"]`)) return;
  const container = document.createElement('div'); container.className = 'dm-inline'; container.dataset.dmid = pid;
  const header = document.createElement('div'); header.textContent = `DM: ${tname}`; header.style.fontWeight = '700';
  const msgs = document.createElement('div'); msgs.style.cssText = 'max-height:160px;overflow:auto;margin-top:6px;padding:6px;background:#001f1f;border-radius:4px';
  const inp = document.createElement('input'); inp.placeholder = 'Type…'; inp.style.cssText = 'width:100%;padding:6px;margin-top:6px;background:#001818;border:1px solid rgba(255,255,255,0.03);color:var(--text-gray)';
  const send = document.createElement('button'); send.textContent = 'Send'; send.style.cssText = 'margin-top:6px;padding:6px;background:#006080;color:#fff;border:0;cursor:pointer';
  container.append(header, msgs, inp, send);
  dmList.prepend(container);
  const dmRef = ref(db, `dm/${pid}`);
  onChildAdded(dmRef, snap => {
    const o = snap.val();
    if (!o.fromName) return; // Skip messages without names
    const el = document.createElement('div'); el.style.margin = '6px 0';
    el.textContent = `${o.fromName}: ${o.msg}`;
    msgs.appendChild(el); msgs.scrollTop = msgs.scrollHeight;
    if(o.from !== uid){
      appendSystem(`New DM from ${o.fromName}`);
    }
  });
  send.onclick = async () => {
    const txt = inp.value.trim();
    if(!txt) return;
    const ts = Date.now();
    const key = push(ref(db, `dm/${pid}`)).key;
    const updates = {};
    updates[`/dm/${pid}/${key}`] = {from: uid, to: tuid, fromName: myHandle, toName: tname, msg: txt, ts};
    await update(ref(db), updates).catch(() => {});
    inp.value = '';
  };
}

function esc(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function appendSystem(t){
  const d = document.createElement('div');
  d.textContent = `[${new Date().toLocaleTimeString()}] ${t}`;
  d.style.fontSize = '12px';
  systemFeed.prepend(d);
}

function initializePanels(){
  document.querySelectorAll('.panel .panel-body').forEach(body => body.style.maxHeight = 'none');
  document.querySelectorAll('.toggle-btn.bottom-toggle').forEach(btn => {
    btn.onclick = () => btn.closest('.panel').classList.toggle('collapsed');
  });
  
  // Initialize online tracking after boot complete
  watchOnline();
  watchPresenceEvents();
}

// Don't call these immediately - wait for boot
appendSystem('Initializing...');
setTimeout(() => updateMarqueeFromCache(), 800);

for(let i=0; i<8; i++){
  const p = document.createElement('div'); p.className = 'particle';
  p.style.left = Math.random()*100 + '%';
  p.style.animationDelay = Math.random()*5 + 's';
  marqueeWrap.appendChild(p);
}

document.querySelectorAll('.collapsible .toggle-btn:not(.bottom-toggle)').forEach(btn => {
  btn.onclick = () => btn.closest('.panel').classList.toggle('collapsed');
});

window.addEventListener('beforeunload', () => {
  if(presenceRef) remove(presenceRef);
});

const revivalLinks = Array.from(document.querySelectorAll('#revivalSitesPanel .panel-body a'))
  .map(a => a.href)
  .filter(href => href.startsWith('http') && !href.includes('discord.gg') && !href.includes('en.wikipedia.org') && !href.includes('x.com') && !href.includes('robustpvp-lang.github.io'));

const toolbarLinks = [
  'https://tokillamockinggoblin.boards.net/',
  'https://youtube.com/@Patrickauthor',
  'https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview',
  'https://sora.chatgpt.com/profile/robustpvp'
];
revivalLinks.push(...toolbarLinks);

document.getElementById('stumbleBtn').onclick = () => {
  const randomLink = revivalLinks[Math.floor(Math.random() * revivalLinks.length)];
  const timestamp = Date.now();
  window.open(`${randomLink}?t=${timestamp}`, '_blank');
};

document.getElementById('emailBtn').onclick = () => {
  window.open('https://forms.gle/LBAkMsnVT7xrraYT8', '_blank');
};

document.getElementById('mindGameBtn').onclick = () => {
  document.body.classList.add('glitch-transition');
  setTimeout(() => window.open('mindgame.html', '_blank'), 500);
  setTimeout(() => document.body.classList.remove('glitch-transition'), 1000);
};
</script>
</body>
</html>
