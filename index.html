<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BuuHoo — Before Us Universe Chat</title>
<style>
  /* 90s Yahoo-esque / GeoCities parody vibe */
  :root{
    --bg1:#2f005f; --bg2:#ff66cc; --accent:#ffd84d; --muted:#c9a8ff; --card:#2a003f;
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: "Lucida Grande", Tahoma, Arial, sans-serif;background:linear-gradient(120deg,var(--bg1),#43106a 40%, #1b0b3a 100%);color:#fff}
  a{color:var(--accent)}
  /* Header */
  header{padding:18px;border-bottom:4px solid rgba(255,255,255,0.04);display:flex;align-items:center;gap:16px}
  .logo{font-weight:900;color:var(--accent);font-size:26px;letter-spacing:1px}
  .tag{color:var(--muted);font-size:13px}
  /* Layout */
  .wrap{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:1fr 420px;gap:18px;padding:0 12px}
  @media(max-width:920px){.wrap{grid-template-columns:1fr;}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:10px;padding:12px;border:2px solid rgba(255,255,255,0.03)}
  /* Threaded board */
  .board-top{display:flex;gap:8px;align-items:center;justify-content:space-between}
  #threads{height:320px;overflow:auto;border:2px dashed rgba(255,255,255,0.03);padding:8px;background:rgba(255,255,255,0.01);border-radius:6px}
  .thread-item{padding:8px;border-radius:6px;margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);cursor:pointer}
  .thread-item h4{margin:0;font-size:15px;color:var(--accent)}
  .thread-meta{font-size:12px;color:var(--muted);margin-top:6px}
  /* thread detail */
  #thread-detail{height:380px;overflow:auto;border:2px solid rgba(255,255,255,0.02);padding:10px;border-radius:6px;background:rgba(0,0,0,0.06)}
  .reply{padding:8px;border-radius:6px;margin-bottom:8px;background:rgba(255,255,255,0.015)}
  /* Chat */
  #chat-messages{height:320px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02));padding:8px;border-radius:6px;border:2px solid rgba(255,255,255,0.02)}
  .chat-line{margin-bottom:8px;font-size:13px}
  .meta{color:var(--muted);font-size:12px}
  .input, textarea{background:#0f0420;border:2px solid rgba(255,255,255,0.03);color:#fff;padding:8px;border-radius:6px;width:100%;font-family:inherit}
  button{background:var(--accent);border:2px solid #b48b2a;color:#1b0b0b;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  /* modal username */
  #modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.6));z-index:9999}
  .modal-box{background:#130022;border:4px solid var(--accent);padding:20px;border-radius:8px;text-align:center;min-width:280px}
  .modal-box h2{margin:0 0 10px;color:var(--accent)}
  /* footer */
  footer{max-width:1100px;margin:18px auto;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <header>
    <div class="logo">BuuHoo</div>
    <div class="tag">• Vintage Chatroom Parody • The Before Us Universe</div>
    <div style="margin-left:auto" class="small">Logged in as: <span id="current-user" style="font-weight:700">—</span></div>
  </header>

  <div class="wrap" role="main">
    <!-- Left: message board -->
    <section class="card" aria-labelledby="board-title">
      <div class="board-top">
        <div>
          <h3 id="board-title" style="margin:0;color:var(--accent)">Message Board (Threads)</h3>
          <div class="small">Create threads, open and reply — live updates</div>
        </div>
        <div id="online-count" class="small">Users: 0</div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <input id="thread-title" class="input" placeholder="New thread title..." />
        <button id="create-thread-btn">New Thread</button>
      </div>

      <div id="threads" aria-live="polite" style="margin-top:12px"></div>

      <div style="margin-top:12px">
        <div id="thread-detail" aria-live="polite"><div class="small">Open a thread to view replies.</div></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <textarea id="reply-text" rows="3" placeholder="Reply to thread..." style="flex:1"></textarea>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="post-reply-btn">Reply</button>
            <button id="close-thread-btn" style="background:transparent;border:2px solid var(--accent);color:var(--accent)">Close</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: live chat -->
    <aside class="card" aria-labelledby="chat-title">
      <h3 id="chat-title" style="margin-top:0;color:var(--accent)">Live Chat</h3>
      <div id="chat-messages" aria-live="polite"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chat-input" class="input" placeholder="Say something..." />
        <button id="send-chat-btn">Send</button>
      </div>

      <div style="margin-top:10px" class="small muted">This is a parody UI modeled on 90s chat rooms. Keep it friendly.</div>
    </aside>
  </div>

  <footer>© Patrick McDonald · BuuHoo — A playful archive experience</footer>

  <!-- Firebase + App (single-file) -->
  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, push, onValue, set, onDisconnect, child, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  // === CONFIG: your project (unchanged) ===
  const firebaseConfig = {
    apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
    authDomain: "before-us-universe.firebaseapp.com",
    databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
    projectId: "before-us-universe",
    storageBucket: "before-us-universe.appspot.com",
    messagingSenderId: "477103463228",
    appId: "1:47710346339"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === LOCAL STATE ===
  let CURRENT_USER = localStorage.getItem('buuhoo_user') || '';
  let CURRENT_UID = localStorage.getItem('buuhoo_uid') || '';
  if(!CURRENT_UID){ CURRENT_UID = Date.now().toString(); localStorage.setItem('buuhoo_uid', CURRENT_UID); }
  document.getElementById('current-user').textContent = CURRENT_USER || '—';

  // prompt for username modal behavior (simple)
  async function askForHandle(){
    if(CURRENT_USER && CURRENT_USER.length>0) return;
    let name = prompt("Welcome to BuuHoo — pick a handle (no profanity):");
    if(!name) name = 'anon'+Math.floor(Math.random()*9000);
    CURRENT_USER = name.trim().slice(0,30);
    localStorage.setItem('buuhoo_user', CURRENT_USER);
    document.getElementById('current-user').textContent = CURRENT_USER;
  }

  // initialize on page load
  window.addEventListener('load', async ()=>{
    await askForHandle();
    initPresence();
    bindUI();
    subscribeRealtime();
  });

  // === Presence (user count) ===
  function initPresence(){
    const onlineRef = ref(db, 'online/' + CURRENT_UID);
    set(onlineRef, { username: CURRENT_USER, since: Date.now() });
    onDisconnect(onlineRef).remove();
    // live count listener
    onValue(ref(db,'online'), snap=>{
      const count = snap ? snap.numChildren() : 0;
      document.getElementById('online-count').textContent = 'Users: ' + count;
    });
  }

  // === UI bindings ===
  function bindUI(){
    document.getElementById('create-thread-btn').addEventListener('click', createThread);
    document.getElementById('send-chat-btn').addEventListener('click', sendChat);
    document.getElementById('post-reply-btn').addEventListener('click', postReply);
    document.getElementById('close-thread-btn').addEventListener('click', ()=>{ SELECTED_THREAD = null; renderThreadDetail(); });
    // allow enter to send chat
    document.getElementById('chat-input').addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendChat(); }});
  }

  // === Sanitization & linkify ===
  function escapeHtml(str=''){ return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[s])); }
  function linkify(text=''){
    const raw = escapeHtml(text);
    const urlRegex = /((https?:\/\/|www\.)[^\s]+)/g;
    return raw.replace(urlRegex, (m)=>{
      let href = m;
      if(!/^https?:\/\//i.test(href)) href = 'https://' + href;
      return '<a href="'+href+'" target="_blank" rel="noopener noreferrer">'+escapeHtml(m)+'</a>';
    });
  }

  // === Realtime subscriptions ===
  const chatRef = ref(db,'chat');
  const threadsRef = ref(db,'threads');

  function subscribeRealtime(){
    // chat messages
    onValue(chatRef, snapshot=>{
      const el = document.getElementById('chat-messages');
      el.innerHTML = '';
      snapshot.forEach(child=>{
        const m = child.val();
        const d = document.createElement('div'); d.className='chat-line';
        const t = m.timestamp? new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):'';
        d.innerHTML = `<div class="meta">[${t}] <b>${escapeHtml(m.username)}</b></div><div>${linkify(m.text)}</div>`;
        el.appendChild(d);
      });
      el.scrollTop = el.scrollHeight;
    });

    // threads listing
    onValue(threadsRef, snapshot=>{
      const list = document.getElementById('threads');
      list.innerHTML = '';
      snapshot.forEach(child=>{
        const t = child.val(); const id = child.key;
        const item = document.createElement('div'); item.className='thread-item';
        item.innerHTML = `<h4>${escapeHtml(t.title)}</h4><div class="thread-meta small">Started by ${escapeHtml(t.username)} • ${new Date(t.timestamp).toLocaleDateString()}</div>`;
        item.addEventListener('click', ()=>{ openThread(id); });
        list.appendChild(item);
      });
    });
  }

  // === Thread operations ===
  let SELECTED_THREAD = null;

  async function createThread(){
    const title = document.getElementById('thread-title').value.trim();
    if(!title) return alert('Please enter a thread title');
    const payload = { title, username: CURRENT_USER, timestamp: Date.now() };
    const p = await push(threadsRef, payload);
    // automatically open the new thread
    openThread(p.key);
    document.getElementById('thread-title').value = '';
  }

  // render thread detail (replies)
  async function renderThreadDetail(){
    const container = document.getElementById('thread-detail');
    container.innerHTML = '';
    if(!SELECTED_THREAD){ container.innerHTML = '<div class="small">Open a thread to view and reply.</div>'; return; }
    // fetch thread meta
    const threadSnap = await get(child(ref(db), 'threads/' + SELECTED_THREAD));
    if(!threadSnap.exists()){ container.innerHTML = '<div class="small">Thread not found.</div>'; return; }
    const meta = threadSnap.val();
    const header = document.createElement('div'); header.innerHTML = `<div style="font-size:16px;color:var(--accent);font-weight:700">${escapeHtml(meta.title)}</div><div class="small">Started by ${escapeHtml(meta.username)}</div><hr/>`;
    container.appendChild(header);

    // list replies
    const repliesSnap = await get(child(ref(db), 'threadReplies/' + SELECTED_THREAD));
    if(!repliesSnap.exists()){ container.appendChild(document.createElement('div')); return; }
    repliesSnap.forEach(r=>{
      const rv = r.val();
      const el = document.createElement('div'); el.className='reply';
      el.innerHTML = `<div class="meta"><b>${escapeHtml(rv.username)}</b> • ${new Date(rv.timestamp).toLocaleString()}</div><div style="margin-top:6px">${linkify(rv.text)}</div>`;
      container.appendChild(el);
    });
    container.scrollTop = container.scrollHeight;
  }

  async function openThread(id){
    SELECTED_THREAD = id;
    await renderThreadDetail();
  }

  // post reply to current thread
  async function postReply(){
    if(!SELECTED_THREAD) return alert('Open a thread first.');
    const txt = document.getElementById('reply-text').value.trim();
    if(!txt) return;
    const repliesRef = ref(db, 'threadReplies/' + SELECTED_THREAD);
    await push(repliesRef, { username: CURRENT_USER, text: txt, timestamp: Date.now() });
    document.getElementById('reply-text').value = '';
    await renderThreadDetail();
  }

  // === Chat send ===
  async function sendChat(){
    const txt = document.getElementById('chat-input').value.trim();
    if(!txt) return;
    await push(chatRef, { username: CURRENT_USER, text: txt, timestamp: Date.now() });
    document.getElementById('chat-input').value = '';
  }
  // attach functions to global for button handlers
  window.sendChat = sendChat;
  window.createThread = createThread;
  window.postReply = postReply;
  window.openThread = openThread;

  // safe initial load: ensure top-level nodes exist (no-op if exist)
  set(ref(db,'_meta/initialized'), true);
  </script>
</body>
</html>
