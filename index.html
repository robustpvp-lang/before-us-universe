<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Before Us Universe</title>
<link rel="icon" href="favicon.ico" />
<style>
  body {
    background-color: #000;
    color: #0ff;
    font-family: "Lucida Console", monospace;
    text-align: center;
    overflow-x: hidden;
  }

  #loading {
    position: fixed;
    inset: 0;
    background: #000;
    color: #0ff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
    z-index: 9999;
  }

  #handle-form, #interface {
    margin-top: 1em;
  }

  input, select, button {
    background: #111;
    color: #0ff;
    border: 1px solid #0ff;
    padding: 0.4em;
    border-radius: 4px;
  }

  .window {
    background: #111;
    border: 1px solid #0ff;
    margin: 1em auto;
    width: 80%;
    max-width: 700px;
    height: 200px;
    overflow-y: auto;
    padding: 0.5em;
    text-align: left;
  }

  .board-post {
    border-bottom: 1px dashed #0ff;
    padding: 0.3em 0;
  }

  button:hover {
    background: #0ff;
    color: #000;
    cursor: pointer;
  }

  #links {
    margin: 1em auto;
  }
  #links a {
    margin: 0 0.5em;
    color: #0ff;
    text-decoration: none;
  }
  #links a:hover { text-decoration: underline; }

</style>
</head>
<body>
<div id="loading">INITIALIZING...</div>

<!-- Links -->
<div id="links">
  <a href="https://tokillamockinggoblin.boards.net/" target="_blank">To Kill a Mocking Goblin</a> |
  <a href="https://www.youtube.com/@Patrickauthor" target="_blank">Melphia's Game</a> |
  <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview" target="_blank">Book 1</a> |
  <a href="https://web.archive.org/" target="_blank">Wayback Machine</a>
</div>

<!-- Handle + Channel -->
<div id="handle-form" style="display:none;">
  <input id="handle" placeholder="Enter your handle..." maxlength="20" />
  <select id="channel-select">
    <option>//Sam</option>
    <option>//Exuro</option>
    <option>//Nero</option>
    <option>//Nora</option>
    <option>//Loktal</option>
    <option>//Pilgrim</option>
  </select>
  <button id="enter-btn">Enter</button>
</div>

<!-- Main Interface -->
<div id="interface" style="display:none;">
  <iframe id="youtube-stream"
    src="https://www.youtube.com/embed/live_stream?channel=UCOC2uG6EECwc0n9yi9C7oDw"
    width="90%" height="315" frameborder="0" allowfullscreen>
  </iframe>

  <p id="user-count">//Sam Active: 0</p>

  <section id="chat-section">
    <div id="chat-window" class="window"></div>
    <form id="chat-form">
      <input id="chat-msg" placeholder="Type a message..." maxlength="500" />
      <button type="submit">Send</button>
    </form>
  </section>

  <section id="board-section">
    <div id="board-window" class="window"></div>
    <form id="board-form">
      <input id="board-msg" placeholder="Post to message board..." maxlength="1000" />
      <button type="submit">Post</button>
    </form>
  </section>
</div>

<!-- Sounds -->
<audio id="door-in" src="https://assets.mixkit.co/sfx/download/mixkit-unlock-game-notification-253.wav"></audio>
<audio id="door-out" src="https://assets.mixkit.co/sfx/download/mixkit-retro-game-notification-212.wav"></audio>

<!-- Firebase Core -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, set, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
    authDomain: "before-us-universe.firebaseapp.com",
    databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
    projectId: "before-us-universe",
    storageBucket: "before-us-universe.firebasestorage.app",
    messagingSenderId: "477103463228",
    appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  const doorIn = document.getElementById("door-in");
  const doorOut = document.getElementById("door-out");
  const loading = document.getElementById("loading");
  const handleForm = document.getElementById("handle-form");
  const enterBtn = document.getElementById("enter-btn");
  const interfaceDiv = document.getElementById("interface");
  const userCount = document.getElementById("user-count");
  const chatWindow = document.getElementById("chat-window");
  const chatInput = document.getElementById("chat-msg");
  const chatForm = document.getElementById("chat-form");
  const boardWindow = document.getElementById("board-window");
  const boardInput = document.getElementById("board-msg");
  const boardForm = document.getElementById("board-form");
  const handleInput = document.getElementById("handle");
  const channelSelect = document.getElementById("channel-select");

  let userHandle = null;
  let currentChannel = "//Sam";

  setTimeout(() => {
    loading.style.display = "none";
    handleForm.style.display = "block";
  }, 2500);

  signInAnonymously(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) console.log("Signed in:", user.uid);
  });

  enterBtn.addEventListener("click", () => {
    userHandle = handleInput.value.trim() || "Anonymous";
    currentChannel = channelSelect.value;
    setupUserPresence();
    handleForm.style.display = "none";
    interfaceDiv.style.display = "block";
  });

  function setupUserPresence() {
    const userRef = ref(db, `online/${currentChannel}/${auth.currentUser.uid}`);
    set(userRef, userHandle);
    doorIn.play().catch(()=>{});
    window.addEventListener("beforeunload", () => {
      remove(userRef);
      doorOut.play().catch(()=>{});
    });

    onValue(ref(db, `online/${currentChannel}`), (snap) => {
      const users = snap.val();
      const count = users ? Object.keys(users).length : 0;
      userCount.textContent = `${currentChannel} Active: ${count}`;
    });
  }

  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const msg = chatInput.value.trim();
    if (!msg || !userHandle) return;
    push(ref(db, "chat"), { name: userHandle, msg, ts: Date.now(), channel: currentChannel });
    chatInput.value = "";
  });

  onChildAdded(ref(db, "chat"), (snap) => {
    const data = snap.val();
    if (data.channel === currentChannel) {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${data.name}:</strong> ${data.msg}`;
      chatWindow.appendChild(p);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
  });

  boardForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const msg = boardInput.value.trim();
    if (!msg || !userHandle) return;
    push(ref(db, "board"), { name: userHandle, msg, ts: Date.now() });
    boardInput.value = "";
  });

  onChildAdded(ref(db, "board"), (snap) => {
    const data = snap.val();
    const div = document.createElement("div");
    div.classList.add("board-post");
    div.innerHTML = `<b>${data.name}</b>: ${data.msg}`;
    boardWindow.appendChild(div);
    boardWindow.scrollTop = boardWindow.scrollHeight;
  });
</script>
</body>
</html>
