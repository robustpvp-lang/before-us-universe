<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Before Us Universe — BUU</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --panel:#e6e6e6; --panel-border:#000; --text:#111;
  --accent:#0aa; --muted:#555;
  --online:#00c853; --offline:#ff3d00;
  --bg-fallback:#08111a;
  --yahoo-blue-start:#2b8bd0;
  --yahoo-blue-end:#0b5ea8;
  --link-color:#0a6fbf;
  --link-hover:#33a0ff;
}
html,body{height:100%;margin:0;font-family:Roboto, "Press Start 2P", monospace;background:var(--bg-fallback);color:var(--text);-webkit-font-smoothing:antialiased}
body{background-color:var(--bg-fallback);background-image:url('https://wallpapercave.com/wp/wp4468245.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;overflow-y:auto}
#bootOverlay{position:fixed;left:0;top:0;width:100%;height:100%;background:#000;color:#7fffd4;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:20px}
#bootPanel{width:920px;max-width:95%;background:#07101a;border:3px solid #063;padding:18px;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.8)}
#bootTitle{font-family:Courier, monospace;color:#aaffdd;font-size:18px;margin-bottom:8px}
#bootText{font-family:Courier, monospace;color:#9ff;line-height:1.4}
#bootForm{margin-top:14px;display:flex;gap:8px;align-items:center}
#bootForm input[type="text"]{padding:8px;border:2px inset #022;font-family:Courier, monospace;color:#001;background:#e8fff6;border-radius:4px}
#bootForm button{padding:8px 12px;background:#063;border:2px solid #0a7;color:#cff;border-radius:6px;cursor:pointer}
.app{position:relative;z-index:1;max-width:1180px;margin:18px auto;padding:12px;box-sizing:border-box}
.title-bar{display:flex;align-items:center;gap:16px;padding:8px 12px;border-radius:6px;background:linear-gradient(90deg,var(--yahoo-blue-start),var(--yahoo-blue-end));color:#fff;font-family:Courier, monospace}
.title-bar .logo{font-weight:700;letter-spacing:1px}
.title-bar .subtitle{font-size:12px;opacity:0.95}
.title-bar a.resource-link{color:#fff;text-decoration:underline;opacity:0.95;margin-left:12px;font-size:13px}
.layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
@media(max-width:980px){ .layout{grid-template-columns:1fr} }
.panel{background:var(--panel);border:3px solid var(--panel-border);border-radius:6px;padding:10px;box-shadow:3px 3px 0 rgba(0,0,0,0.12);position:relative;overflow:hidden}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.yt-wrap{display:flex;justify-content:center}
.yt-wrap iframe{width:100%;max-width:720px;height:405px;border:4px solid var(--panel-border);background:#000}
.chat-win{border:4px solid #0b5ea8;border-radius:8px;overflow:hidden;position:relative;background:linear-gradient(180deg,#eaf6ff,#d7eeff)}
.chat-title{display:flex;justify-content:space-between;align-items:center;padding:8px;background:linear-gradient(90deg,#1e73be,#0961a6);color:#fff;font-family:Courier, monospace}
.chat-title .left{display:flex;gap:12px;align-items:center}
.chat-body{padding:10px}
.chat-messages{height:360px;overflow:auto;background:linear-gradient(180deg,#ffffffcc,#eef8ffcc);border:2px solid rgba(0,0,0,0.06);padding:12px;white-space:normal;border-radius:6px}
.chat-row{display:flex;gap:8px;margin:8px 0;align-items:flex-start}
.chat-avatar{width:36px;height:36px;border-radius:6px;background:#d9eefc;display:flex;align-items:center;justify-content:center;font-weight:700;font-family:Courier, monospace}
.chat-bubble{max-width:78%;padding:10px;border-radius:8px;background:#fff;border:1px solid #cfe6ff;font-family:Arial, Helvetica, sans-serif}
.chat-bubble.me{background:linear-gradient(180deg,#fff7d6,#fff2b3);border:1px solid #f0d280;text-align:right}
.chat-meta{font-size:12px;color:#0a6fbf;font-weight:700;margin-bottom:6px;font-family:Courier, monospace}
.chat-controls{display:flex;gap:8px;margin-top:8px}
.chat-controls input[type="text"]{flex:1;padding:8px;border:2px inset var(--panel-border);font-family:monospace}
.chat-controls button{padding:8px 10px;border:2px outset var(--panel-border);background:#dfefff;cursor:pointer;border-radius:6px}
.active-list{display:flex;flex-direction:column;gap:6px}
.user-row{display:flex;align-items:center;gap:8px;padding:6px;border-radius:4px;background:#fff;border:1px solid rgba(0,0,0,0.06)}
.status-dot{width:12px;height:12px;border-radius:50%;box-shadow:0 0 6px rgba(0,0,0,0.08)}
.dot-online{background:var(--online)}
.dot-offline{background:var(--offline)}
.uname{font-family:Courier, monospace;font-weight:700;color:#0a4b7a}
.board-thread{background:#fff;border:2px solid var(--panel-border);padding:10px;margin-bottom:8px;border-radius:6px}
textarea{width:100%;min-height:80px;padding:8px;border:2px inset var(--panel-border);font-family:monospace}
.tooltip{position:relative}
.tooltip .tip{position:absolute;left:110%;top:0;background:#111;color:#fff;padding:6px;border:1px solid #333;border-radius:4px;display:none;white-space:nowrap;z-index:999}
.tooltip:hover .tip{display:block}
#particleCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:0}
.dm-window{position:fixed;background:#fff;border:3px solid #b8860b;border-radius:6px;padding:8px;z-index:9999;min-width:260px;max-width:420px;box-shadow:6px 6px 0 rgba(0,0,0,0.15)}
.dm-title{background:linear-gradient(180deg,#fddc6b,#f2c200);padding:6px;border-radius:4px;font-weight:700;cursor:move;font-family:Courier, monospace}
.dm-msg{background:#fff7d6;padding:8px;border-radius:8px;margin:6px 0;max-width:90%}
.dm-input{width:100%;padding:6px;border:1px solid #ddd}
@media(max-width:600px){ .chat-messages{height:280px} .yt-wrap iframe{height:200px} }
</style>
</head>
<body>

<!-- Boot overlay -->
<div id="bootOverlay">
  <div id="bootPanel">
    <div id="bootTitle">BEFORE US UNIVERSE — SYSTEM LOGIN</div>
    <div id="bootText">
      <div>Establishing secure channel to Before Us Network...</div>
      <div style="margin-top:8px">Enter your handle (letters, numbers, _, -). It will be tied to your session.</div>
      <form id="bootForm" onsubmit="return false;">
        <input id="bootHandle" type="text" maxlength="30" placeholder="//YourHandle" />
        <button id="bootLoginBtn" type="button">Authenticate</button>
      </form>
      <div id="bootStatus" class="small" style="margin-top:10px;color:#9ff"></div>
    </div>
  </div>
</div>

<canvas id="particleCanvas"></canvas>

<div class="app" id="app" style="display:none">
  <div class="title-bar">
    <div class="logo">BUU</div>
    <div class="subtitle">Before Us Universe — community portal</div>
    <div style="margin-left:auto">
      <a class="resource-link" href="http://www.oldversion.com/" target="_blank" rel="noopener">OldVersion</a>
      <a class="resource-link" href="https://web.archive.org/" target="_blank" rel="noopener">Wayback Machine</a>
      <a class="resource-link" id="projOrtegaLink" href="#" target="_blank" rel="noopener">Project ://ORTEGA</a>
    </div>
  </div>

  <header style="margin-top:12px">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a href="https://tokillamockinggoblin.boards.net/" target="_blank" style="color:var(--link-color);text-decoration:none;font-weight:700">To Kill a Mocking Goblin</a>
      <a href="https://youtube.com/@Patrickauthor" target="_blank" style="color:var(--link-color);text-decoration:none;font-weight:700">Melphia's Game (YouTube)</a>
      <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview" target="_blank" style="color:var(--link-color);text-decoration:none;font-weight:700">Book 1</a>
    </div>
  </header>

  <div class="layout">
    <div>
      <div class="panel">
        <div class="small">Playlist</div>
        <div class="yt-wrap" style="margin-top:8px">
          <iframe id="ytIframe" src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq" title="Melphia's Game" allowfullscreen></iframe>
        </div>
      </div>

      <div class="panel chat-win" id="chatPanel" style="margin-top:12px">
        <div class="chat-title">
          <div class="left">
            <div id="winChannelLabel">//Exuro</div>
            <div class="small" style="margin-left:12px" id="userCountSmall">0 users</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small" for="doorToggle" style="color:#fff">Sound</label>
            <input type="checkbox" id="doorToggle" checked />
            <button id="closeChatBtn" title="Close chat" style="background:#fff;color:#900;border-radius:6px;padding:6px">X</button>
          </div>
        </div>
        <div class="chat-body">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-controls" style="margin-top:12px">
            <input id="chatInput" placeholder="Write message..." maxlength="500" />
            <select id="channelSelect">
              <option value="exuro">//Exuro</option>
              <option value="sam">//Sam</option>
              <option value="nero">//Nero</option>
              <option value="nora">//Nora</option>
              <option value="loktal">//Loktal</option>
            </select>
            <button id="sendBtn">POST</button>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Local Message Board</div>
          <div class="small">Posts persist; chat deletes after 24h</div>
        </div>
        <div id="boardList" style="margin-top:8px;max-height:380px;overflow:auto"></div>
        <div style="margin-top:8px">
          <input id="boardName" placeholder="Name (max 100)" style="width:180px;padding:6px" />
          <textarea id="boardMsg" placeholder="Message (max 1000)"></textarea>
          <button id="postBoardBtn">Post</button>
        </div>
      </div>
    </div>

    <div>
      <div class="panel">
        <div class="small">Active Users by Channel</div>
        <div id="activeContainer" style="margin-top:8px"></div>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="small">Direct Messages (DM)</div>
        <div id="dmList" style="margin-top:8px"></div>
        <div class="small" style="margin-top:8px">Click name to open DM</div>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="small">System Feed</div>
        <div id="systemFeed" style="margin-top:8px;max-height:220px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<audio id="soundMsg" src="https://assets.mixkit.co/sfx/download/mixkit-positive-alert-600.wav" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove, onDisconnect, query, orderByChild, update, get, off } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.firebasestorage.app",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* DOM */
const bootOverlay = document.getElementById('bootOverlay');
const bootHandle = document.getElementById('bootHandle');
const bootLoginBtn = document.getElementById('bootLoginBtn');
const bootStatus = document.getElementById('bootStatus');
const appRoot = document.getElementById('app');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const closeChatBtn = document.getElementById('closeChatBtn');
const userCountSmall = document.getElementById('userCountSmall');
const activeContainer = document.getElementById('activeContainer');
const boardList = document.getElementById('boardList');
const boardName = document.getElementById('boardName');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const systemFeed = document.getElementById('systemFeed');
const dmList = document.getElementById('dmList');
const projOrtegaLink = document.getElementById('projOrtegaLink');
const soundMsg = document.getElementById('soundMsg');

let uid = null;
let myHandle = null;
let currentChannel = 'exuro';
let presenceRef = null;
let channelListeners = {};

/* ---------- Boot/Login ---------- */
signInAnonymously(auth).catch(e => bootStatus.textContent = 'Auth error: ' + e.message);

onAuthStateChanged(auth, user => {
  if (user) {
    uid = user.uid;
    const stored = localStorage.getItem('buu-handle');
    if (stored && !myHandle) {
      attemptHandleReserve(stored).then(ok => {
        if (ok) { myHandle = stored; finishLogin(); }
        else { bootStatus.textContent = 'Handle taken. Choose another.'; }
      });
    }
  }
});

async function attemptHandleReserve(handle) {
  const handleRef = ref(db, `handles/${handle}`);
  try {
    await set(handleRef, { uid, joined: Date.now() });
    return true;
  } catch (e) {
    console.error(e);
    return false;
  }
}

bootLoginBtn.addEventListener('click', async () => {
  const raw = sanitizeHandle(bootHandle.value);
  if (!raw) return bootStatus.textContent = 'Enter a valid handle.';
  if (!uid) return bootStatus.textContent = 'Auth not ready...';

  bootStatus.textContent = 'Reserving handle...';
  const ok = await attemptHandleReserve(raw);
  if (!ok) return bootStatus.textContent = 'Handle taken. Try another.';

  myHandle = raw;
  localStorage.setItem('buu-handle', myHandle);
  await set(ref(db, `users/${uid}/profile`), { name: myHandle, uid, firstSeen: Date.now() });
  setPresence(myHandle, currentChannel);
  finishLogin();
});

function finishLogin() {
  bootStatus.textContent = `Welcome, ${myHandle}!`;
  setTimeout(() => {
    bootOverlay.style.display = 'none';
    appRoot.style.display = 'block';
    appendSystem('Interface ready.');
  }, 800);
}

/* ---------- Utils ---------- */
function appendSystem(text) {
  const el = document.createElement('div');
  el.className = 'small';
  el.style.padding = '4px';
  el.textContent = `${new Date().toLocaleTimeString()} - ${text}`;
  systemFeed.prepend(el);
}
function sanitizeHandle(s) { return (s || '').replace(/[^\w\-]/g, '').slice(0, 30).trim(); }
function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function computeHash(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ---------- Presence ---------- */
function setPresence(handle, channel) {
  if (!uid) return;
  if (presenceRef) remove(presenceRef).catch(() => {});
  presenceRef = ref(db, `online/${channel}/${uid}`);
  set(presenceRef, { name: handle, ts: Date.now(), channel, uid })
    .then(() => onDisconnect(presenceRef).remove())
    .catch(e => appendSystem('Presence error: ' + e.message));
}

/* ---------- Online Users ---------- */
function watchOnline() {
  onValue(ref(db, 'online'), snap => {
    const data = snap.val() || {};
    renderActive(data);
    rebuildDMList(data);
  });
}

function renderActive(data) {
  activeContainer.innerHTML = '';
  const channels = ['exuro','sam','nero','nora','loktal'];
  channels.forEach(ch => {
    const wrapper = document.createElement('div');
    wrapper.style.marginBottom = '10px';
    const title = document.createElement('div');
    title.innerHTML = `<strong>//${ch.charAt(0).toUpperCase() + ch.slice(1)}</strong> <small>(${Object.keys(data[ch] || {}).length})</small>`;
    wrapper.appendChild(title);
    const list = document.createElement('div');
    Object.entries(data[ch] || {}).forEach(([id, u]) => {
      const row = document.createElement('div'); row.className = 'user-row tooltip';
      const dot = document.createElement('div'); dot.className = 'status-dot dot-online';
      const name = document.createElement('div'); name.className = 'uname'; name.textContent = u.name;
      name.style.cursor = 'pointer';
      name.onclick = () => openDM(id, u.name);
      const tip = document.createElement('div'); tip.className = 'tip'; tip.textContent = 'Click to DM';
      name.appendChild(tip);
      row.appendChild(dot); row.appendChild(name);
      list.appendChild(row);
    });
    wrapper.appendChild(list);
    activeContainer.appendChild(wrapper);
  });
  userCountSmall.textContent = `${Object.keys(data[currentChannel] || {}).length} user${Object.keys(data[currentChannel] || {}).length !== 1 ? 's' : ''}`;
}

function rebuildDMList(data) {
  dmList.innerHTML = '';
  const seen = new Set();
  for (const ch in data) {
    for (const id in data[ch]) {
      const u = data[ch][id];
      if (id === uid || seen.has(id)) continue;
      seen.add(id);
      const btn = document.createElement('div');
      btn.textContent = u.name;
      btn.style.cssText = 'padding:6px;border:1px solid #ccc;margin:4px 0;cursor:pointer';
      btn.onclick = () => openDM(id, u.name);
      dmList.appendChild(btn);
    }
  }
}

/* ---------- DM ---------- */
function openDM(targetUid, targetName) {
  if (targetUid === uid) return alert("Can't DM yourself");
  const pid = [uid, targetUid].sort().join('_');
  const w = document.createElement('div'); w.className = 'dm-window';
  w.style.right = '20px'; w.style.bottom = '20px';
  const t = document.createElement('div'); t.className = 'dm-title'; t.textContent = `DM: ${targetName}`;
  const msgs = document.createElement('div'); msgs.style.height='180px'; msgs.style.overflow='auto'; msgs.style.border='1px solid #ddd'; msgs.style.marginTop='6px'; msgs.style.padding='6px';
  const input = document.createElement('input'); input.className='dm-input'; input.placeholder='Type DM...';
  const send = document.createElement('button'); send.textContent='Send';
  const close = document.createElement('button'); close.textContent='Close'; close.style.marginLeft='6px';
  w.append(t, msgs, input, send, close);
  document.body.appendChild(w);
  makeDraggable(w, t);

  const dmRef = ref(db, `dm/${pid}`);
  onChildAdded(dmRef, snap => {
    const o = snap.val();
    const el = document.createElement('div'); el.className = 'dm-msg';
    el.style.textAlign = (o.from === uid ? 'right' : 'left');
    el.textContent = `${o.fromName}: ${o.msg}`;
    msgs.appendChild(el); msgs.scrollTop = msgs.scrollHeight;
  });

  send.onclick = async () => {
    const text = input.value.trim();
    if (!text || text.length > 1000) return;
    const ts = Date.now();
    const h = await computeHash(JSON.stringify({from:uid,to:targetUid,msg:text,ts}));
    const key = push(ref(db, `dm/${pid}`)).key;
    const updates = {};
    updates[`/dm/${pid}/${key}`] = { from: uid, to: targetUid, fromName: myHandle, toName: targetName, msg: text, ts };
    updates[`/dmHashes/${h}`] = { pid, key, ts, from: uid };
    await update(ref(db), updates);
    input.value = ''; soundMsg.play().catch(()=>{});
  };

  close.onclick = () => { off(dmRef); w.remove(); };
}

function makeDraggable(el, bar) {
  let ox = 0, oy = 0, dragging = false;
  bar.onmousedown = e => { dragging = true; ox = e.clientX - el.getBoundingClientRect().left; oy = e.clientY - el.getBoundingClientRect().top; };
  document.onmousemove = e => { if(dragging) { el.style.left = (e.clientX - ox) + 'px'; el.style.top = (e.clientY - oy) + 'px'; } };
  document.onmouseup = () => dragging = false;
}

/* ---------- Chat ---------- */
function listenChannel(channel) {
  for (const ch in channelListeners) off(channelListeners[ch].ref);
  currentChannel = channel;
  document.getElementById('winChannelLabel').textContent = '//' + channel.charAt(0).toUpperCase() + channel.slice(1);
  chatMessages.innerHTML = '';
  const r = ref(db, `chat/${channel}`);
  const fn = snap => {
    const o = snap.val();
    if (!o) return;
    const row = document.createElement('div'); row.className = 'chat-row';
    const av = document.createElement('div'); av.className = 'chat-avatar'; av.textContent = (o.name||'?').slice(0,2).toUpperCase();
    const bub = document.createElement('div'); bub.className = 'chat-bubble';
    if (o.uid === uid) bub.classList.add('me');
    bub.innerHTML = `<div class="chat-meta">${o.name} · ${new Date(o.ts).toLocaleTimeString()}</div><div>${escapeHtml(o.msg)}</div>`;
    row.append(av, bub);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  };
  onChildAdded(r, fn);
  channelListeners[channel] = { ref: r, fn };
}

async function postMessage(channel, name, msg) {
  const trimmed = msg.trim();
  if (!trimmed || trimmed.length > 500) return;
  const ts = Date.now();
  const hash = await computeHash(`${channel}|${name}|${trimmed}|${uid}|${Math.floor(ts/1000)}`);
  const key = push(ref(db, `chat/${channel}`)).key;
  const updates = {};
  updates[`/chat/${channel}/${key}`] = { name, msg: trimmed, ts, uid, hash };
  updates[`/msgHashes/${hash}`] = { channel, key, ts, uid };
  await update(ref(db), updates);
  set(ref(db, `online/${channel}/${uid}`), { name, ts: Date.now(), channel, uid });
}

/* ---------- Board ---------- */
function listenBoard() {
  onChildAdded(ref(db, 'board'), snap => {
    const p = snap.val();
    const el = document.createElement('div'); el.className = 'board-thread';
    el.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div style="margin-top:6px">${escapeHtml(p.msg)}</div><div class="small" style="margin-top:6px">${new Date(p.ts).toLocaleString()}</div>`;
    boardList.prepend(el);
  });
}

/* ---------- UI ---------- */
sendBtn.onclick = () => {
  if (!myHandle) return alert('Login first');
  postMessage(channelSelect.value, myHandle, chatInput.value);
  chatInput.value = '';
  soundMsg.play().catch(()=>{});
};
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); } });

postBoardBtn.onclick = async () => {
  const name = boardName.value.trim();
  const msg = boardMsg.value.trim();
  if (!name || !msg || name.length > 100 || msg.length > 1000) return alert('Invalid input');
  const r = push(ref(db, 'board'));
  await set(r, { name, msg, ts: Date.now(), uid });
  boardName.value = ''; boardMsg.value = '';
};

closeChatBtn.onclick = () => { document.querySelector('.chat-win').style.display = 'none'; };

channelSelect.onchange = () => { listenChannel(channelSelect.value); setPresence(myHandle, channelSelect.value); };

projOrtegaLink.onclick = e => { e.preventDefault(); alert('Replace NOTEBOOKLM_URL in JS with your link.'); };

/* ---------- Start ---------- */
watchOnline();
listenBoard();
listenChannel(currentChannel);
appendSystem('Initializing...');

/* ---------- Particles ---------- */
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
resize(); addEventListener('resize', resize);
let particles = [];
function spawn(x, y) { particles.push({x,y,vx:(Math.random()-0.5)*0.8,vy:(Math.random()-0.5)*0.8,life:45,size:Math.random()*2+1}); }
addEventListener('mousemove', e => spawn(e.clientX, e.clientY));
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for (let i = particles.length-1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.life--;
    ctx.fillStyle = `rgba(127,255,212,${p.life/45})`;
    ctx.fillRect(p.x, p.y, p.size, p.size);
    if (p.life <= 0) particles.splice(i,1);
  }
  requestAnimationFrame(loop);
}
loop();

/* ---------- Auto-prune old chat (24h) ---------- */
setInterval(async () => {
  const snap = await get(ref(db, 'chat'));
  const data = snap.val() || {};
  for (const ch in data) {
    for (const id in data[ch]) {
      if (data[ch][id].ts && (Date.now() - data[ch][id].ts) > 24*60*60*1000) {
        await remove(ref(db, `chat/${ch}/${id}`));
      }
    }
  }
}, 60*60*1000);

</script>
</body>
</html>
