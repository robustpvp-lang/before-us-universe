<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Before Us Universe — BUU</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23001a1a'/><path d='M20 25h60v10h-60zM20 45h60v10h-60zM20 65h60v10h-60z' fill='%2300ffff'/><circle cx='50' cy='50' r='8' fill='%23ffcc00'/></svg>" type="image/svg+xml">
<style>
:root{
  --bg:#001a1a; --fg:#00ffff; --accent:#ffcc00; --border:#00cccc; --panel-bg:#002b2b;
  --proboards-blue:#1e73be; --proboards-dark:#0066cc; --proboards-gray:#f5f5f5; --proboards-border:#ccc; --proboards-muted:#666; --proboards-text:#444;
  --yahoo-blue:#1e73be; --yahoo-dark:#0961a6; --online:#00ff9d; --muted:#00aaaa;
  --text-gray:#444;
  --theme-name: 'cyber'; /* Default theme */
}

/* Dark Theme */
[data-theme="dark"] {
  --bg: #161625; --fg: #e1e1ff; --accent: #9A97F3; --border: #818cab;
  --panel-bg: #25253a; --proboards-blue: #818cab; --proboards-dark: #536390;
  --proboards-gray: #292922; --proboards-border: #424242; --proboards-muted: #424242; --proboards-text: #e1e1ff;
  --yahoo-blue: #818cab; --yahoo-dark: #536390; --online: #66bb6a; --muted: #536390;
  --text-gray: #e1e1ff;
}

/* Light Theme */
[data-theme="light"] {
  --bg: #fff; --fg: #424242; --accent: #302AE6; --border: #536390;
  --panel-bg: #f5f5f5; --proboards-blue: #1e73be; --proboards-dark: #0066cc;
  --proboards-gray: #f5f5f5; --proboards-border: #ccc; --proboards-muted: #666; --proboards-text: #444;
  --yahoo-blue: #1e73be; --yahoo-dark: #0961a6; --online: #00ff9d; --muted: #00aaaa;
  --text-gray: #444;
}

/* Matrix Green Theme */
[data-theme="matrix"] {
  --bg: #000; --fg: #00ff00; --accent: #00cc00; --border: #008800;
  --panel-bg: #001100; --proboards-blue: #00aa00; --proboards-dark: #008800;
  --proboards-gray: #002200; --proboards-border: #004400; --proboards-muted: #006600; --proboards-text: #00ff00;
  --yahoo-blue: #00aa00; --yahoo-dark: #008800; --online: #00ff00; --muted: #00aa00;
  --text-gray: #00ff00;
}

html,body{margin:0;height:100%;font-family:'Roboto Mono',monospace;background:var(--bg);color:var(--fg);overflow:hidden}
body{background:url('https://wallpapercave.com/wp/wp4468245.jpg') center/cover no-repeat}
#crt::before{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.06),rgba(0,0,0,0.06) 2px,transparent 2px,transparent 4px);pointer-events:none;z-index:999}
#bootOverlay{position:fixed;inset:0;background:#000;color:var(--fg);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:'Press Start 2P'}
#bootPanel{width:90%;max-width:800px;background:var(--panel-bg);border:4px solid var(--border);padding:20px;box-shadow:0 0 30px #00cccc}
#bootLog{line-height:1.6;white-space:pre-wrap;margin-bottom:20px;font-size:14px}
#bootPrompt{color:var(--accent)}
#bootInput{background:var(--panel-bg);border:2px solid var(--border);color:var(--fg);padding:6px;width:70%;max-width:300px}
#bootBtn{background:var(--panel-bg);border:2px solid var(--border);color:var(--accent);padding:6px 12px;cursor:pointer}
#app{display:none;height:100%;padding:8px;box-sizing:border-box;overflow-y:auto}
.title-bar{display:flex;gap:12px;flex-wrap:wrap;padding:8px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:13px;align-items:center}
.title-bar .logo{font-weight:700;letter-spacing:1px}
.link-btn{background:var(--accent);color:#000;padding:6px 12px;border-radius:4px;font-weight:700;cursor:pointer;border:2px solid #000;margin:2px;font-size:11px}
.layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
@media(max-width:980px){.layout{grid-template-columns:1fr}}
.panel{background:var(--panel-bg);border:3px solid var(--border);border-radius:4px;box-shadow:0 0 12px rgba(0,255,255,0.3);margin-bottom:12px;overflow:hidden}
.panel-title{display:flex;align-items:center;justify-content:space-between;padding:6px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:12px;cursor:pointer}
.panel-title .title{font-weight:700}
.panel-title .toggle-btn{background:#fff;color:#000;padding:2px 6px;border-radius:4px;font-size:10px;width:16px;text-align:center}
.panel-body{transition:max-height 0.3s ease;overflow:hidden}
.panel-body.collapsed{max-height:0 !important}
.yt-wrap iframe{width:100%;max-width:720px;height:405px;border:4px solid var(--border)}
.chat-win{display:flex;flex-direction:column;height:500px}
.chat-title{display:flex;justify-content:space-between;align-items:center;padding:8px;background:linear-gradient(90deg,var(--yahoo-blue),var(--yahoo-dark));color:#fff;font-family:'Press Start 2P';font-size:12px}
.chat-main{display:flex;flex:1;overflow:hidden}
.chat-messages{flex:1;overflow:auto;background:#fff;border-right:1px solid #ccc;padding:8px;color:var(--text-gray)}
.chat-users{background:#f0f8ff;border-left:1px solid #ccc;padding:8px;overflow:auto;width:180px}
@media(max-width:700px){.chat-main{flex-direction:column}.chat-users{width:auto;border-left:0;border-top:1px solid #ccc}}
.chat-row{display:flex;gap:8px;margin:6px 0;align-items:flex-start}
.chat-avatar{width:32px;height:32px;border-radius:50%;background:#d9eefc;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#0961a6}
.chat-bubble{max-width:78%;padding:8px;border-radius:8px;background:#fff;border:1px solid #cfe6ff;font-family:Arial;color:var(--text-gray)}
.chat-bubble.me{background:#fff7d6;border:1px solid #f0d280;text-align:right}
.chat-meta{font-size:11px;color:#0a6fbf;font-weight:700;margin-bottom:4px}
.user-row{display:flex;gap:4px;align-items:center;padding:4px;font-size:11px;cursor:pointer}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--online)}
.uname{font-family:'Press Start 2P';color:#0a4b7a}
.chat-controls{display:flex;gap:6px;padding:8px;background:#f0f8ff;border-top:1px solid #ccc}
.chat-controls input{flex:1;padding:6px;border:2px inset #ccc;background:#fff}
.chat-controls button{padding:6px;border:2px outset #ccc;background:#dfefff;cursor:pointer}
.board-header{background:var(--proboards-blue);color:#fff;padding:8px;font-weight:700;font-family:Arial;border-bottom:2px solid var(--proboards-border)}
.board-thread{background:var(--proboards-gray);border:1px solid var(--proboards-border);padding:10px;margin-bottom:10px;border-radius:4px;font-family:Arial;color:var(--text-gray)}
.board-thread strong{color:var(--proboards-dark);font-size:14px}
.board-thread .small{color:var(--proboards-muted);font-style:italic;margin-top:4px;display:block}
#serverSelectPanel{margin-bottom:12px}
#serverSelectPanel .controls{display:flex;gap:6px;align-items:center}
#serverSelectPanel select{flex:1;padding:6px;background:var(--panel-bg);border:2px solid var(--border);color:var(--fg)}
#serverConfirm{background:var(--accent);color:#000;padding:6px;border:2px solid #000;cursor:pointer;font-weight:700}
#ortegaPanel{margin-bottom:12px}
#ortegaBtn{width:100%;background:var(--accent);color:#000;padding:10px;border:2px solid #000;border-radius:4px;font-weight:700;cursor:pointer;font-size:14px}
#serverTrackingPanel{margin-bottom:12px}
#serverTrackingPanel .server-branch{margin-bottom:12px}
#serverTrackingPanel .server-title{font-weight:700;color:var(--accent);font-size:13px;cursor:pointer}
#serverTrackingPanel .user-list{margin-left:12px;margin-top:4px;font-size:11px}
#serverTrackingPanel .user-list div{margin:2px 0;padding:2px 6px;background:#001f1f;border-radius:2px;cursor:pointer}
#serverTrackingPanel .current-server .server-title{color:#000;background:var(--accent);padding:2px 6px;border-radius:2px}
#systemFeed{max-height:180px;overflow:auto;background:var(--panel-bg);border:2px solid var(--border);padding:6px;font-size:12px}
.dm-window{position:fixed;background:#fff;border:3px solid #b8860b;border-radius:6px;z-index:9999;min-width:260px;max-width:420px;box-shadow:6px 6px 0 rgba(0,0,0,0.2)}
.dm-title{background:linear-gradient(180deg,#fddc6b,#f2c200);padding:6px;border-radius:4px;font-weight:700;cursor:move;font-family:'Press Start 2P';font-size:11px}
.dm-msg{background:#fff7d6;padding:6px;border-radius:6px;margin:4px 0;max-width:90%}
#particleCanvas{position:fixed;inset:0;pointer-events:none;z-index:0}

/* Mobile Optimization for DMs */
@media (max-width: 600px) {
  .dm-window {
    position: relative !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
    width: 100%;
    margin-bottom: 10px;
  }
  .layout {
    grid-template-columns: 1fr;
  }
}

/* Typing Indicator */
.typing-indicator { font-size: 11px; color: var(--muted); padding: 4px; font-style: italic; }

/* Theme Switcher Styles */
.theme-switch-wrapper { display: flex; align-items: center; margin-left: auto; }
.theme-switch { display: inline-block; height: 20px; position: relative; width: 40px; }
.theme-switch input { display: none; }
.slider { background-color: var(--border); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 20px; }
.slider:before { background-color: var(--fg); bottom: 4px; content: ""; height: 12px; left: 4px; position: absolute; transition: .4s; width: 12px; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(20px); }

/* Edit/Delete Buttons */
.edit-btn, .delete-btn { font-size: 10px; margin-left: 5px; cursor: pointer; color: var(--accent); }
</style>
</head>
<body>
<div id="crt"></div>
<div id="bootOverlay">
  <div id="bootPanel">
    <div id="bootLog" class="small"></div>
    <div id="bootPrompt">> ENTER HANDLE:</div>
    <input id="bootInput" type="text" maxlength="30" placeholder="//YourHandle">
    <button id="bootBtn">AUTHENTICATE</button>
    <div id="bootStatus" class="small" style="margin-top:8px;color:var(--accent)"></div>
  </div>
</div>
<canvas id="particleCanvas"></canvas>
<div id="app">
  <div class="title-bar">
    <div class="logo">BUU</div>
    <button class="link-btn" onclick="window.open('https://tokillamockinggoblin.boards.net/','_blank')">To Kill a Mocking Goblin</button>
    <button class="link-btn" onclick="window.open('https://youtube.com/@Patrickauthor','_blank')">Melphia’s Game (YT)</button>
    <button class="link-btn" onclick="window.open('https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview','_blank')">Book 1</button>
    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider round"></div>
      </label>
      <em>Toggle Theme</em>
      <select id="themeSelect">
        <option value="cyber">Cyber</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="matrix">Matrix Green</option>
      </select>
    </div>
    <button id="enableNotifications">Enable Notifications</button>
  </div>
  <div class="layout">
    <div>
      <div class="panel">
        <div class="panel-title" onclick="togglePanel(this)">
          <div class="title">PLAYLIST</div>
          <div class="toggle-btn">−</div>
        </div>
        <div class="panel-body" id="ytBody">
          <div class="yt-wrap" style="margin:8px">
            <iframe src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq" allowfullscreen></iframe>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title" onclick="togglePanel(this)">
          <div class="title" id="chatTitle">//EXURO <span class="small" id="userCountSmall">0 users</span></div>
          <div class="toggle-btn">−</div>
        </div>
        <div class="panel-body chat-win" id="chatBody">
          <div class="chat-main">
            <div class="chat-messages" id="chatMessages"></div>
            <div id="typingIndicator" class="typing-indicator"></div>
            <div class="chat-users">
              <div class="small" style="margin-bottom:4px">USERS ONLINE</div>
              <div id="activeUsersList"></div>
            </div>
          </div>
          <div class="chat-controls">
            <input id="chatInput" placeholder="Say something..." maxlength="500">
            <button id="sendBtn">SEND</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title" onclick="togglePanel(this)">
          <div class="title">MESSAGE BOARD</div>
          <div class="toggle-btn">−</div>
        </div>
        <div class="panel-body" id="boardBody">
          <div class="small" style="margin:8px 0">Posts persist – chat deletes after 24h</div>
          <div id="boardList" style="max-height:340px;overflow:auto;margin:8px 0"></div>
          <div style="margin:8px">
            <input id="boardName" placeholder="Name (max 100)" style="width:180px;padding:4px" value="">
            <textarea id="boardMsg" placeholder="Message (max 1000)" style="width:100%;min-height:70px;margin-top:4px"></textarea>
            <button id="postBoardBtn" style="margin-top:4px">POST</button>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="panel" id="serverSelectPanel">
        <div class="small">SELECT SERVER</div>
        <div class="controls">
          <select id="channelSelect">
            <option value="exuro">//Exuro</option>
            <option value="sam">//Sam</option>
            <option value="nero">//Nero</option>
            <option value="nora">//Nora</option>
            <option value="loktal">//Loktal</option>
          </select>
          <button id="serverConfirm">Switch Server</button>
        </div>
      </div>
      <div class="panel" id="ortegaPanel">
        <button id="ortegaBtn">Project ://ORTEGA</button>
      </div>
      <div class="panel" id="serverTrackingPanel">
        <div class="small">SERVER TRACKING</div>
        <div id="serverTrackingList"></div>
      </div>
      <div class="panel">
        <div class="small">SYSTEM FEED</div>
        <div id="systemFeed"></div>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="small">DIRECT MESSAGES</div>
        <div id="dmList" style="margin-top:8px"></div>
        <div class="small" style="margin-top:4px">Click a name to open DM</div>
      </div>
    </div>
  </div>
</div>
<audio id="soundMsg" src="https://assets.mixkit.co/sfx/download/mixkit-positive-alert-600.wav" preload="auto"></audio>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove, onDisconnect, update, get, off } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
const firebaseConfig = {apiKey:"AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",authDomain:"before-us-universe.firebaseapp.com",databaseURL:"https://before-us-universe-default-rtdb.firebaseio.com",projectId:"before-us-universe",storageBucket:"before-us-universe.firebasestorage.app",messagingSenderId:"4771034632228",appId:"1:477103463228:web:01b53b6b29cb9d54315c39"};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const bootOverlay = document.getElementById('bootOverlay');
const bootLog = document.getElementById('bootLog');
const bootInput = document.getElementById('bootInput');
const bootBtn = document.getElementById('bootBtn');
const bootStatus = document.getElementById('bootStatus');
const appRoot = document.getElementById('app');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const serverConfirm = document.getElementById('serverConfirm');
const userCountSmall = document.getElementById('userCountSmall');
const activeUsersList = document.getElementById('activeUsersList');
const serverTrackingList = document.getElementById('serverTrackingList');
const boardList = document.getElementById('boardList');
const boardName = document.getElementById('boardName');
const boardMsg = document.getElementById('boardMsg');
const postBoardBtn = document.getElementById('postBoardBtn');
const systemFeed = document.getElementById('systemFeed');
const dmList = document.getElementById('dmList');
const ortegaBtn = document.getElementById('ortegaBtn');
const soundMsg = document.getElementById('soundMsg');
const chatTitle = document.getElementById('chatTitle');
let uid = null, myHandle = null, currentChannel = 'exuro', presenceRef = null, channelListeners = {};
function togglePanel(title) {
  const body = title.parentElement.nextElementSibling;
  const btn = title.querySelector('.toggle-btn');
  if (body.classList.contains('collapsed')) {
    body.classList.remove('collapsed');
    body.style.maxHeight = body.scrollHeight + 'px';
    btn.textContent = '−';
  } else {
    body.classList.add('collapsed');
    body.style.maxHeight = '0';
    btn.textContent = '+';
  }
}
function initializePanels() {
  document.querySelectorAll('.panel .panel-body').forEach(body => {
    if (!body.style.maxHeight || body.style.maxHeight === '0px') {
      body.style.maxHeight = body.scrollHeight + 'px';
    }
  });
  document.querySelectorAll('.panel-title').forEach(title => {
    title.onclick = () => togglePanel(title);
  });
}
const bootLines = ["INITIALIZING BEFORE US UNIVERSE...","Loading kernel.............[OK]","Mounting network...........[OK]","Checking Firebase link.....[OK]","Ready for authentication..."];
let lineIdx = 0;
function typeBootLine(){
  if(lineIdx < bootLines.length){
    bootLog.textContent += bootLines[lineIdx] + "\n";
    lineIdx++;
    setTimeout(typeBootLine, 300 + Math.random()*400);
  }
}
typeBootLine();
signInAnonymously(auth).catch(e=>bootStatus.textContent="Auth error: "+e.message);
onAuthStateChanged(auth, u=>{ if(u) uid = u.uid; });
bootBtn.addEventListener('click', async ()=>{
  const raw = bootInput.value.trim().replace(/[^\w\-]/g,'').slice(0,30);
  if(!raw) return bootStatus.textContent = "Invalid handle";
  if(!uid) return bootStatus.textContent = "Auth not ready…";
  // Easter-egg for Neo & Nero – friendly message + auto-accept
  if (['neo','nero'].includes(raw.toLowerCase())) {
    const lore = {
      neo: "Neo: The One who glitches the code. Your signal is too loud. Try a quieter alias.",
      nero: "Nero: The ghost in the machine. This handle is sealed in the archives. Choose another."
    };
    bootStatus.textContent = lore[raw.toLowerCase()];
    bootStatus.style.color = '#ff5555';
    setTimeout(() => {
      bootStatus.textContent = '';
      bootStatus.style.color = 'var(--accent)';
      // Auto-accept the handle after easter egg
      myHandle = raw;
      boardName.value = myHandle;
      set(ref(db,`users/${uid}/profile`),{name:myHandle,uid,firstSeen:Date.now()}).catch(console.error);
      setPresence(myHandle,currentChannel);
      finishBoot();
    }, 4000);
    return;
  }
  // No reservation check - direct accept
  bootStatus.textContent = "Authenticating…";
  myHandle = raw;
  boardName.value = myHandle;
  await set(ref(db,`users/${uid}/profile`),{name:myHandle,uid,firstSeen:Date.now()}).catch(console.error);
  setPresence(myHandle,currentChannel);
  finishBoot();
});
function finishBoot(){
  bootStatus.textContent = `Welcome, ${myHandle}`;
  setTimeout(()=>{
    bootOverlay.style.display='none';
    appRoot.style.display='block';
    initializePanels();
    appendSystem('System ready');
  },1200);
}
function appendSystem(t){
  const d=document.createElement('div');
  d.textContent=`[${new Date().toLocaleTimeString()}] ${t}`;
  d.style.fontSize = '11px';
  systemFeed.prepend(d);
  systemFeed.scrollTop = systemFeed.scrollHeight;
}
function esc(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
async function hash(str){
  const e=new TextEncoder().encode(str);
  const b=await crypto.subtle.digest('SHA-256',e);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
}
function setPresence(h,ch){
  if(presenceRef) remove(presenceRef).catch(()=>{});
  presenceRef = ref(db,`online/${ch}/${uid}`);
  set(presenceRef,{name:h,ts:Date.now(),channel:ch,uid}).then(()=>onDisconnect(presenceRef).remove());
}
const serverDescs = {
  exuro: 'Main hub for universal discussions.',
  sam: 'Lore about Sam - mysterious artifacts.',
  nero: 'Dark secrets and shadows.',
  nora: 'Exploration and adventures.',
  loktal: 'Tech and hacking zone.'
};
function renderServerTracking(data){
  serverTrackingList.innerHTML = '';
  const channels = ['exuro','sam','nero','nora','loktal'];
  channels.forEach(ch => {
    const usersObj = data[ch] || {};
    const users = Object.values(usersObj);
    const count = users.length;
    const branch = document.createElement('div');
    branch.className = `server-branch ${ch === currentChannel ? 'current-server' : ''}`;
    branch.innerHTML = `<div class="server-title">//${ch.toUpperCase()} (${count})</div><div class="small">${serverDescs[ch]}</div><div class="user-list collapsed"></div>`;
    const userListToggle = branch.querySelector('.server-title');
    userListToggle.onclick = () => {
      const userList = branch.querySelector('.user-list');
      userList.classList.toggle('collapsed');
      if (!userList.classList.contains('collapsed')) {
        userList.style.maxHeight = userList.scrollHeight + 'px';
      } else {
        userList.style.maxHeight = '0';
      }
    };
    const userList = branch.querySelector('.user-list');
    users.forEach(u => {
      const div = document.createElement('div');
      div.textContent = u.name + (u.typing ? ' (typing...)' : '');
      div.onclick = () => openDM(u.uid, u.name);
      userList.appendChild(div);
    });
    if(count === 0){
      const div = document.createElement('div');
      div.textContent = '—';
      div.style.opacity = '0.5';
      userList.appendChild(div);
    }
    serverTrackingList.appendChild(branch);
  });
}
function watchOnline(){
  onValue(ref(db,'online'),snap=>{
    const data = snap.val()||{};
    renderServerTracking(data);
    renderActiveUsers(data[currentChannel] || {});
    updateUserCount(data);
    rebuildDMList(data);
    updateTypingIndicator(data[currentChannel] || {});
  }, (error) => { appendSystem('Online watch error: ' + error.message); });
  setTimeout(() => {
    get(ref(db, 'online')).then(snap => {
      const data = snap.val() || {};
      renderServerTracking(data);
      renderActiveUsers(data[currentChannel] || {});
      updateUserCount(data);
      rebuildDMList(data);
      updateTypingIndicator(data[currentChannel] || {});
    });
  }, 1000);
}
function renderActiveUsers(usersObj){
  activeUsersList.innerHTML = '';
  const users = Object.values(usersObj || {});
  users.forEach(u=>{
    const row = document.createElement('div'); row.className = 'user-row';
    const dot = document.createElement('div'); dot.className = 'status-dot';
    const name = document.createElement('div'); name.className = 'uname'; name.textContent = u.name;
    name.onclick = () => openDM(u.uid, u.name);
    row.append(dot, name);
    activeUsersList.appendChild(row);
  });
}
function updateUserCount(data){
  const usersObj = data[currentChannel] || {};
  const count = Object.keys(usersObj).length;
  userCountSmall.textContent = count + (count===1?' user':' users');
  chatTitle.innerHTML = `//${currentChannel.toUpperCase()} <span class="small">${count} user${count===1?'':'s'}</span>`;
}
function rebuildDMList(data){
  dmList.innerHTML='';
  const seen=new Set();
  for(const ch in data){
    const usersObj = data[ch] || {};
    for(const id in usersObj){
      const u = usersObj[id];
      if(id===uid||seen.has(id))continue;
      seen.add(id);
      const b=document.createElement('div');
      b.textContent=u.name;
      b.style.cssText='padding:4px;border:1px solid #ccc;margin:2px 0;cursor:pointer';
      b.onclick=()=>openDM(id,u.name);
      dmList.appendChild(b);
    }
  }
}
function watchPresenceEvents() {
  const channels = ['exuro','sam','nero','nora','loktal'];
  channels.forEach(ch => {
    onChildAdded(ref(db, `online/${ch}`), snap => {
      const u = snap.val();
      if (u && u.uid !== uid) {
        appendSystem(`User '${u.name}' joined //${ch.toUpperCase()}`);
      }
    });
    onChildRemoved(ref(db, `online/${ch}`), snap => {
      const u = snap.val();
      if (u && u.uid !== uid) {
        appendSystem(`User '${u.name}' left //${ch.toUpperCase()}`);
      }
    });
  });
}
async function registerDMPair(tuid){
  const pid=[uid,tuid].sort().join('_');
  const updates={};
  updates[`dmPairs/${pid}/users/${uid}`]=true;
  updates[`dmPairs/${pid}/users/${tuid}`]=true;
  await update(ref(db),updates);
}
function openDM(tuid,tname){
  if(tuid===uid) return alert("Can't DM yourself");
  registerDMPair(tuid);
  const pid=[uid,tuid].sort().join('_');
  const win=document.createElement('div');win.className='dm-window';
  win.style.right='20px';win.style.bottom='20px';
  const title=document.createElement('div');title.className='dm-title';title.textContent=`DM: ${tname}`;
  const msgs=document.createElement('div');msgs.style.cssText='height:180px;overflow:auto;border:1px solid #ddd;margin-top:6px;padding:6px';
  const inp=document.createElement('input');inp.placeholder='Type…';
  const send=document.createElement('button');send.textContent='Send';
  const close=document.createElement('button');close.textContent='X';close.style.marginLeft='4px';
  win.append(title,msgs,inp,send,close);
  document.body.appendChild(win);
  makeDraggable(win,title);
  const dmRef=ref(db,`dm/${pid}`);
  onChildAdded(dmRef,snap=>{
    const o=snap.val();
    const el=document.createElement('div');el.className='dm-msg';
    el.style.textAlign = (o.from===uid?'right':'left');
    el.textContent = `${o.fromName}: ${o.msg}`;
    msgs.appendChild(el);msgs.scrollTop=msgs.scrollHeight;
  });
  send.onclick=async()=>{
    const txt=inp.value.trim();
    if(!txt||txt.length>1000) return;
    const ts=Date.now();
    const h=await hash(JSON.stringify({from:uid,to:tuid,msg:txt,ts}));
    const key=push(ref(db,`dm/${pid}`)).key;
    const updates={};
    updates[`/dm/${pid}/${key}`]={from:uid,to:tuid,fromName:myHandle,toName:tname,msg:txt,ts};
    updates[`/dmHashes/${h}`]={pid,key,ts,from:uid};
    await update(ref(db),updates);
    inp.value='';soundMsg.play().catch(()=>{});
  };
  close.onclick=()=>{off(dmRef);win.remove();};
}
function makeDraggable(el,bar){
  let ox=0,oy=0,drag=false;
  bar.onmousedown=e=>{drag=true;ox=e.clientX-el.getBoundingClientRect().left;oy=e.clientY-el.getBoundingClientRect().top;};
  document.onmousemove=e=>{if(drag){el.style.left=(e.clientX-ox)+'px';el.style.top=(e.clientY-oy)+'px';}};
  document.onmouseup=()=>{drag=false;};
}
function listenChannel(ch){
  for(const c in channelListeners) off(channelListeners[c].ref);
  currentChannel=ch;
  chatMessages.innerHTML='';
  const r=ref(db,`chat/${ch}`);
  const fn=snap=>{
    const o=snap.val(); if(!o || o.deleted) return;
    const row=document.createElement('div');row.className='chat-row';
    const av=document.createElement('div');av.className='chat-avatar';av.textContent=(o.name||'?').slice(0,2).toUpperCase();
    const bub=document.createElement('div');bub.className='chat-bubble';
    if(o.uid===uid) bub.classList.add('me');
    bub.innerHTML=`<div class="chat-meta">${o.name} · ${new Date(o.ts).toLocaleTimeString()}</div><div>${esc(o.msg)}</div>`;
    if (o.uid === uid) {
      const editBtn = document.createElement('span'); editBtn.className = 'edit-btn'; editBtn.textContent = '[Edit]';
      editBtn.onclick = async () => {
        const newMsg = prompt('Edit message:', o.msg);
        if (newMsg && newMsg !== o.msg) {
          const ts = Date.now();
          const h = await hash(`${currentChannel}|${o.name}|${newMsg}|${uid}|${Math.floor(ts/1000)}`);
          update(ref(db, `chat/${currentChannel}/${snap.key}`), {msg: newMsg, ts, hash: h});
          update(ref(db, `/msgHashes/${h}`), {channel: currentChannel, key: snap.key, ts, uid});
        }
      };
      const deleteBtn = document.createElement('span'); deleteBtn.className = 'delete-btn'; deleteBtn.textContent = '[Delete]';
      deleteBtn.onclick = () => {
        update(ref(db, `chat/${currentChannel}/${snap.key}`), {deleted: true});
      };
      bub.append(editBtn, deleteBtn);
    }
    row.append(av,bub);
    chatMessages.appendChild(row);
    chatMessages.scrollTop=chatMessages.scrollHeight;
    if (Notification.permission === 'granted' && document.hidden) {
      new Notification(`New message from ${o.name}`, { body: o.msg });
    }
  };
  onChildAdded(r,fn);
  channelListeners[ch]={ref:r,fn};
}
async function postMessage(ch,name,msg){
  const m=msg.trim();
  if(!m||m.length>500) return;
  const ts=Date.now();
  const h=await hash(`${ch}|${name}|${m}|${uid}|${Math.floor(ts/1000)}`);
  const key=push(ref(db,`chat/${ch}`)).key;
  const updates={};
  updates[`/chat/${ch}/${key}`]={name,msg:m,ts,uid,hash:h};
  updates[`/msgHashes/${h}`]={channel:ch,key,ts,uid};
  await update(ref(db),updates);
  set(ref(db,`online/${ch}/${uid}`),{name,ts:Date.now(),channel:ch,uid});
}
function listenBoard(){
  onChildAdded(ref(db,'board'),snap=>{
    const p=snap.val();
    const el=document.createElement('div');el.className='board-thread';
    el.innerHTML=`<strong>${esc(p.name)}</strong><br>${esc(p.msg)}<div class="small">Posted: ${new Date(p.ts).toLocaleString()}</div>`;
    boardList.prepend(el);
  });
}
sendBtn.onclick=()=>{ if(!myHandle) return alert('Login first'); postMessage(currentChannel,myHandle,chatInput.value); chatInput.value=''; soundMsg.play().catch(()=>{}); };
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});
postBoardBtn.onclick=async()=>{
  const n = myHandle || 'Anonymous';
  const m=boardMsg.value.trim();
  if(!m||m.length>1000) return alert('Invalid');
  const r=push(ref(db,'board'));
  await set(r,{name:n,msg:m,ts:Date.now(),uid});
  boardMsg.value='';
};
serverConfirm.onclick=()=>{
  const newCh = channelSelect.value;
  if(newCh !== currentChannel){
    if(confirm(`Switch to //${newCh.toUpperCase()}?`)){
      listenChannel(newCh);
      setPresence(myHandle, newCh);
      currentChannel = newCh;
    }
  }
};
ortegaBtn.onclick=()=>{alert('Project ://ORTEGA – RAG-LM genie coming soon');};
watchOnline();
watchPresenceEvents();
listenBoard(); listenChannel(currentChannel); appendSystem('Initializing...');
const pc=document.getElementById('particleCanvas'),ctx=pc.getContext('2d');
function resize(){pc.width=innerWidth;pc.height=innerHeight;} resize(); addEventListener('resize',resize);
let particles=[];
function spawn(x,y){particles.push({x,y,vx:(Math.random()-0.5)*0.8,vy:(Math.random()-0.5)*0.8,life:45,size:Math.random()*2+1});}
addEventListener('mousemove',e=>spawn(e.clientX,e.clientY));
function loop(){
  ctx.clearRect(0,0,pc.width,pc.height);
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.life--;
    ctx.fillStyle=`rgba(0,255,255,${p.life/45})`;
    ctx.fillRect(p.x,p.y,p.size,p.size);
    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(loop);
} loop();
setInterval(async()=>{
  const snap=await get(ref(db,'chat'));
  const data=snap.val()||{};
  for(const ch in data){
    for(const id in data[ch]){
      if(data[ch][id].ts && Date.now()-data[ch][id].ts>24*60*60*1000){
        await remove(ref(db,`chat/${ch}/${id}`));
      }
    }
  }
},60*60*1000);

// Theme Switcher
const themeSelect = document.getElementById('themeSelect');
themeSelect.addEventListener('change', (e) => {
  const theme = e.target.value;
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
});
const currentTheme = localStorage.getItem('theme') || 'cyber';
document.documentElement.setAttribute('data-theme', currentTheme);
themeSelect.value = currentTheme;

// Notifications
const enableNotifications = document.getElementById('enableNotifications');
enableNotifications.addEventListener('click', () => {
  if (!("Notification" in window)) return alert('Notifications not supported');
  Notification.requestPermission().then(permission => {
    if (permission === 'granted') enableNotifications.style.display = 'none';
  });
});

// Typing Indicators
let typingTimeout;
chatInput.addEventListener('input', () => {
  if (chatInput.value.trim()) {
    set(ref(db, `online/${currentChannel}/${uid}/typing`), true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      set(ref(db, `online/${currentChannel}/${uid}/typing`), false);
    }, 3000);
  } else {
    set(ref(db, `online/${currentChannel}/${uid}/typing`), false);
  }
});

function updateTypingIndicator(usersObj) {
  const typingUsers = Object.values(usersObj).filter(u => u.typing && u.uid !== uid).map(u => u.name);
  const typingIndicator = document.getElementById('typingIndicator');
  typingIndicator.textContent = typingUsers.length > 0 ? `${typingUsers.join(', ')} ${typingUsers.length > 1 ? 'are' : 'is'} typing...` : '';
}
</script>
</body>
</html>
