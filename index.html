<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before Us Universe — BUU</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
/* ---------- Retro Windows 98 ---------- */
* { box-sizing:border-box; }
body {
  margin:0; padding:0;
  font-family:'Press Start 2P',monospace;
  background:#008080;               /* classic teal */
  color:#000;
  overflow:hidden;
}
.window {
  position:absolute; background:#c0c0c0;
  border:2px solid #000; box-shadow:3px 3px 0 #000;
  min-width:300px; font-size:0.75rem;
}
.title-bar {
  background:#000080; color:#fff;
  padding:2px 4px; cursor:move;
  display:flex; justify-content:space-between; align-items:center;
}
.title-bar button { background:#c0c0c0; border:1px outset #000; width:16px; height:16px; font-weight:bold; }
.title-bar .close { background:#c0c0c0; }
.title-bar .minimize { background:#c0c0c0; }
.content { padding:6px; background:#e0e0e0; }
.inset { border:2px inset #000; background:#fff; padding:4px; }

/* ---------- Background (Base64) ---------- */
.bg {
  position:fixed; inset:0; z-index:-1;
  background:url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxISEhUTExIWFRUXFRcVFRcVFRcVFRcVFRUVFhUVFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGxAQGy0lICYtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAOEA4QMBIgACEQEDEQH/xAAcAAACAgMBAQAAAAAAAAAAAAAEBQMGAAIHAQj/xAA/EAABBAECBAYDCQgCAwAAAAAAAQIDEQQFEjEHBkFRYQYTIoGRobHR8DJCUmJxkfAVFTRTYnKC4f/EABoBAQEBAQEBAQAAAAAAAAAAAAABAgMEBQb/xAAtEQABBAECBAQFBAMAAAAAAAAAAQIRAwQhMUEFIkFRYXEygZGhsfAUUnGBkdHh8f/aAAwDAQACEQMRAD8A4QAAAAAAAH//2Q==') center/cover no-repeat;
}

/* ---------- Loading Screen ---------- */
#loading {
  position:fixed; inset:0; background:#000; color:#0f0;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:9999; font-size:1rem;
}
#loadingLore { margin-top:1rem; }

/* ---------- Header Links ---------- */
header {
  position:fixed; top:0; left:0; right:0; background:#c0c0c0;
  border-bottom:2px solid #000; padding:4px; text-align:center;
  z-index:100;
}
header a { margin:0 8px; color:#000; text-decoration:none; font-size:0.7rem; }

/* ---------- Modal Handle Prompt ---------- */
#handleModal {
  position:fixed; inset:0; background:rgba(0,0,0,0.8);
  display:flex; justify-content:center; align-items:center; z-index:2000;
}
#handleModal .window { width:320px; }
#handleModal input { width:100%; padding:6px; margin-top:8px; }

/* ---------- Chat Specific ---------- */
#chat .messages { height:220px; overflow-y:auto; }
#chat .message { margin-bottom:4px; }
#chat .system { color:#555; font-style:italic; }
#chat .nick { cursor:pointer; }
#chat #typing { font-style:italic; color:#777; }

/* ---------- Board Specific ---------- */
#board .post { padding:6px; border-bottom:1px dashed #000; position:relative; }
#board .reply { margin-left:20px; background:#f0f0f0; }
#board .actions { position:absolute; right:6px; top:6px; font-size:0.6rem; }

/* ---------- Misc ---------- */
button { font-family:inherit; cursor:pointer; }
input, textarea, select { font-family:inherit; }
</style>
</head>
<body>

<div class="bg"></div>

<div id="loading">
  <div>INITIALIZING BEFORE US UNIVERSE...</div>
  <div id="loadingLore"></div>
</div>

<header>
  <a href="https://tokillamockinggoblin.boards.net/">To Kill a Mocking Goblin</a>
  <a href="https://youtube.com/playlist?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq">Melphia's Game</a>
  <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview">Book 1</a>
  <a href="https://web.archive.org/">Wayback Machine</a>
</header>

<!-- ==== HANDLE MODAL ==== -->
<div id="handleModal">
  <div class="window">
    <div class="title-bar"><span>Choose Handle</span><button class="close" onclick="this.parentNode.parentNode.parentNode.remove()">X</button></div>
    <div class="content">
      <input id="modalHandle" placeholder="Max 16 chars" maxlength="16">
      <button id="lockHandleBtn" style="margin-top:8px;width:100%;">LOCK IN</button>
    </div>
  </div>
</div>

<!-- ==== YOUTUBE WINDOW ==== -->
<div class="window" style="left:20px;top:80px;width:580px;">
  <div class="title-bar">
    <span>YouTube – Melphia’s Game</span>
    <button class="minimize">_</button><button class="close">X</button>
  </div>
  <div class="content">
    <iframe width="100%" height="315"
      src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq"
      frameborder="0" allowfullscreen></iframe>
  </div>
</div>

<!-- ==== CHAT WINDOW ==== -->
<div id="chat" class="window" style="left:620px;top:80px;width:420px;">
  <div class="title-bar">
    <span>Live Chat – <span id="handleStatus"></span></span>
    <select id="channelSelect" style="font-family:inherit;">
      <option value="Exuro">//Exuro</option>
      <option value="Sam">//Sam</option>
      <option value="Nero">//Nero</option>
      <option value="Nora">//Nora</option>
      <option value="Loktal">//Loktal</option>
      <option value="Pilgrim">//Pilgrim (secret)</option>
    </select>
    <button class="minimize">_</button><button class="close">X</button>
  </div>
  <div class="content">
    <div class="messages inset" id="messages"></div>
    <div id="typing"></div>
    <input id="messageInput" placeholder="Type message…" maxlength="500" style="width:100%;margin-top:4px;">
    <button id="sendBtn" style="width:100%;margin-top:4px;">Send</button>
    <div id="activeUsers" style="margin-top:6px;font-size:0.65rem;"></div>
  </div>
</div>

<!-- ==== MESSAGE BOARD WINDOW ==== -->
<div id="board" class="window" style="left:20px;top:460px;width:1020px;">
  <div class="title-bar"><span>Message Board</span>
    <button class="minimize">_</button><button class="close">X</button>
  </div>
  <div class="content">
    <div id="posts" class="inset" style="height:300px;overflow-y:auto;"></div>
    <input id="boardName" placeholder="Your Name (max 100)" maxlength="100" style="width:100%;margin-top:6px;">
    <textarea id="boardMsg" placeholder="Your post (max 1000)" maxlength="1000" style="width:100%;height:80px;margin-top:4px;"></textarea>
    <button id="postBtn" style="width:100%;margin-top:4px;">Post</button>
  </div>
</div>

<audio id="doorSound" src="https://freesound.org/data/previews/3/3080_5159-lq.mp3"></audio>

<script type="module">
/* ============================================================= */
/*                     FIREBASE SETUP                           */
/* ============================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, onChildAdded, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.appspot.com",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
signInAnonymously(auth);

/* ============================================================= */
/*                     GLOBAL STATE                             */
/* ============================================================= */
let uid = null;
let currentHandle = "";
let currentChannel = "Exuro";
let nickColors = {};

/* ============================================================= */
/*                     HANDLE MODAL                             */
/* ============================================================= */
const modal = document.getElementById('handleModal');
const lockBtn = document.getElementById('lockHandleBtn');
lockBtn.onclick = () => {
  const h = document.getElementById('modalHandle').value.trim().substring(0,16);
  if (!h) return alert("Handle required!");
  currentHandle = h || "Anonymous";
  document.getElementById('handleStatus').innerHTML = `<span style="color:#0f0">locked in: ${currentHandle}</span>`;
  modal.remove();
  initUserOnline();
};

/* ============================================================= */
/*                     ONLINE TRACKING                          */
/* ============================================================= */
function initUserOnline() {
  if (!uid) return;
  const onlineRef = ref(db, `online/${uid}`);
  const data = { handle: currentHandle, online: true, ts: serverTimestamp() };
  set(onlineRef, data);

  // Update handle if user changes it later (optional input in chat header)
  const handleInputHeader = document.createElement('input');
  handleInputHeader.placeholder = "change handle";
  handleInputHeader.maxLength = 16;
  handleInputHeader.style.width = "80px";
  handleInputHeader.style.marginLeft = "8px";
  document.querySelector('#chat .title-bar').appendChild(handleInputHeader);
  handleInputHeader.onchange = () => {
    const nh = handleInputHeader.value.trim().substring(0,16) || "Anonymous";
    currentHandle = nh;
    set(onlineRef, { handle: nh, online: true, ts: serverTimestamp() });
    document.getElementById('handleStatus').innerHTML = `<span style="color:#0f0">locked in: ${nh}</span>`;
  };

  window.addEventListener('beforeunload', () => remove(onlineRef));
}

/* ============================================================= */
/*                     AUTH LISTENER                            */
/* ============================================================= */
onAuthStateChanged(auth, user => {
  if (user) { uid = user.uid; if (currentHandle) initUserOnline(); }
});

/* ============================================================= */
/*                     ACTIVE USERS LIST                        */
/* ============================================================= */
const activeDiv = document.getElementById('activeUsers');
function renderActiveUsers(snap) {
  const data = snap.val() || {};
  let html = "Active: ";
  for (let id in data) {
    const u = data[id];
    const col = nickColors[u.handle] || (nickColors[u.handle] = randomColor());
    html += `<span class="nick" style="color:${col}" title="${id}">${u.handle}</span> `;
  }
  activeDiv.innerHTML = html;
}
onValue(ref(db, 'online'), renderActiveUsers);

function randomColor() {
  const hue = Math.floor(Math.random()*360);
  return `hsl(${hue},80%,45%)`;
}

/* ============================================================= */
/*                     CHAT LOGIC                               */
/* ============================================================= */
const messagesDiv = document.getElementById('messages');
const typingDiv = document.getElementById('typing');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('messageInput');
const channelSel = document.getElementById('channelSelect');
const door = document.getElementById('doorSound');

function switchChannel(ch) {
  currentChannel = ch;
  messagesDiv.innerHTML = "";
  const chatRef = ref(db, `chat/${ch}`);
  onChildAdded(chatRef, snap => addMessage(snap.val()));
}
channelSel.onchange = () => switchChannel(channelSel.value);
switchChannel(currentChannel);

function addMessage({name, msg, ts, type="msg"}) {
  const div = document.createElement('div');
  div.className = 'message';
  if (type === "system") div.classList.add('system');
  const time = ts ? new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : "";
  const col = nickColors[name] || "#000";
  div.innerHTML = type==="system"
    ? `<em>${msg}</em>`
    : `<span class="nick" style="color:${col}">[${time}] ${name}:</span> ${escapeHtml(msg)}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* send message */
sendBtn.onclick = () => {
  if (!currentHandle) return alert("Set a handle first!");
  const txt = msgInput.value.trim();
  if (!txt) return;
  const payload = { name: currentHandle, msg: txt, ts: serverTimestamp() };
  push(ref(db, `chat/${currentChannel}`), payload);
  msgInput.value = "";
  door.currentTime = 0; door.play();
};

/* typing indicator (very light) */
let typingTimer;
msgInput.oninput = () => {
  if (!uid) return;
  const typRef = ref(db, `typing/${currentChannel}/${uid}`);
  set(typRef, {handle: currentHandle, ts: serverTimestamp()});
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => remove(typRef), 2000);
};
onValue(ref(db, `typing/${currentChannel}`), snap => {
  const data = snap.val() || {};
  const typers = Object.values(data).filter(t=>Date.now()-t.ts<3000).map(t=>t.handle);
  typingDiv.textContent = typers.length ? `${typers.join(', ')} typing…` : '';
});

/* join / leave system messages */
function broadcastSystem(msg) {
  push(ref(db, `chat/${currentChannel}`), {name:"", msg, ts: serverTimestamp(), type:"system"});
}
onValue(ref(db, 'online'), snap => {
  // we cannot detect exact joins here, but we can announce when our own status changes
});

/* ============================================================= */
/*                     MESSAGE BOARD (ProBoards style)         */
/* ============================================================= */
const postsDiv = document.getElementById('posts');
const boardNameInp = document.getElementById('boardName');
const boardMsgInp = document.getElementById('boardMsg');
const postBtn = document.getElementById('postBtn');
const boardRef = ref(db, "board");

onChildAdded(boardRef, snap => renderPost(snap.key, snap.val()));
function renderPost(key, {name, msg, ts, replyTo}) {
  const div = document.createElement('div');
  div.className = 'post';
  if (replyTo) div.classList.add('reply');
  const time = ts ? new Date(ts).toLocaleString() : "";
  div.innerHTML = `
    <strong style="color:${nickColors[name]||'#000'}">${escapeHtml(name)}</strong> <small>${time}</small>
    <div style="margin-top:4px;">${escapeHtml(msg).replace(/\n/g,'<br>')}</div>
    <div class="actions">
      <button onclick="quotePost('${key}',this)">Quote</button>
      <button onclick="replyPost('${key}',this)">Reply</button>
    </div>`;
  if (replyTo) {
    const parent = document.querySelector(`[data-key="${replyTo}"]`);
    if (parent) parent.appendChild(div);
    else postsDiv.appendChild(div);
  } else {
    div.dataset.key = key;
    postsDiv.appendChild(div);
  }
  postsDiv.scrollTop = postsDiv.scrollHeight;
}
window.quotePost = (key, btn) => {
  const post = btn.closest('.post');
  const text = post.querySelector('div:nth-child(2)').innerText;
  boardMsgInp.value = `> ${text}\n\n`;
  boardMsgInp.focus();
};
window.replyPost = (key, btn) => {
  const post = btn.closest('.post');
  const name = post.querySelector('strong').innerText;
  boardMsgInp.value = `@${name} `;
  boardMsgInp.focus();
  // store reply target for later
  window.pendingReply = key;
};

postBtn.onclick = () => {
  const name = (boardNameInp.value || currentHandle).trim().substring(0,100);
  const msg = boardMsgInp.value.trim().substring(0,1000);
  if (!name || !msg) return;
  const payload = {name, msg, ts: serverTimestamp()};
  if (window.pendingReply) payload.replyTo = window.pendingReply;
  push(boardRef, payload).then(() => {
    boardNameInp.value = "";
    boardMsgInp.value = "";
    delete window.pendingReply;
  });
};

/* ============================================================= */
/*                     DRAGGABLE / MINIMISE / CLOSE            */
/* ============================================================= */
document.querySelectorAll('.window').forEach(win => {
  const title = win.querySelector('.title-bar');
  let drag = false, ox, oy;
  title.onmousedown = e => {
    if (e.target.tagName==="BUTTON") return;
    drag = true;
    ox = e.clientX - win.offsetLeft;
    oy = e.clientY - win.offsetTop;
  };
  document.onmousemove = e => {
    if (!drag) return;
    win.style.left = (e.clientX - ox) + 'px';
    win.style.top  = (e.clientY - oy) + 'px';
  };
  document.onmouseup = () => drag = false;

  // minimise / close
  win.querySelector('.minimize').onclick = () => win.style.display = win.style.display==='none'?'block':'none';
  win.querySelector('.close').onclick = () => win.remove();
});

/* ============================================================= */
/*                     LOADING SCREEN                           */
/* ============================================================= */
const loadingLore = [
  "Loading Sector 1: The Voidborn... 23% complete",
  "Awakening ancient AI... 45% complete",
  "Multiversal rifts stabilizing... 68% complete",
  "Preparing Lux Fleet deployment... 89% complete",
  "Initialization complete. Welcome to the Before Us Universe."
];
let li = 0;
function showNext() {
  if (li < loadingLore.length) {
    document.getElementById('loadingLore').textContent = loadingLore[li++];
    setTimeout(showNext, 1100);
  } else {
    document.getElementById('loading').remove();
  }
}
showNext();

/* ============================================================= */
/*                     UTILS                                    */
/* ============================================================= */
function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}
</script>
</body>
</html>
