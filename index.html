<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before Us Universe</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
/* --- Body & Background --- */
body {
  margin: 0;
  font-family: 'Press Start 2P', monospace;
  background: url('https://i.imgur.com/fdI7QXD.jpg') no-repeat center center fixed;
  background-size: cover;
  color: #000;
  overflow-x: hidden;
}
/* --- Header / Top Links --- */
header {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
  padding: 0.5rem;
  background: #c0c0c0;
  border-bottom: 2px solid #000;
}
header a {
  color: #000;
  text-decoration: none;
  font-size: 0.8rem;
  padding: 0.2rem 0.5rem;
  background: #e0e0e0;
  border: 1px solid #000;
}
header a:hover {
  background: #d0d0d0;
}
/* --- Handle Input --- */
#handleInput {
  display:flex;
  justify-content:center;
  margin:0.5rem;
}
#handleInput input {
  padding:0.5rem;
  font-family:monospace;
  border:2px inset #000;
  background:#fff;
  color:#000;
  width:200px;
}
/* --- YouTube Embed --- */
#youtube {
  display:flex;
  justify-content:center;
  margin:0.5rem;
}
#youtube iframe {
  width:80%;
  height:315px;
  max-width:560px;
  border:2px solid #000;
}
/* --- Chat Window --- */
.chat-window {
  max-width:800px;
  margin:1rem auto;
  background: #e0e0e0;
  padding:0.5rem;
  border:2px solid #000;
  font-size:0.8rem;
  box-shadow: 2px 2px #888888;
  position: relative;
  cursor: move;
}
.chat-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#c0c0c0;
  border-bottom:2px solid #000;
  padding:0.3rem;
}
.messages {
  height:200px;
  overflow-y:auto;
  border:2px inset #000;
  background:#fff;
  padding:0.5rem;
  margin:0.5rem 0;
}
.message { margin-bottom:0.3rem; }
.user-online { color:green; animation: blink 1s infinite; }
.user-offline { color:red; }
@keyframes blink {
  0%{opacity:1;}
  50%{opacity:0;}
  100%{opacity:1;}
}
.tooltip { position: relative; display:inline-block; }
.tooltip .tooltiptext {
  visibility:hidden; width:140px; background-color:#000; color:#0f0;
  text-align:center; border-radius:6px; padding:5px; position:absolute; z-index:1; top:-5px; left:105%;
}
.tooltip:hover .tooltiptext { visibility:visible; }
/* --- Active Users --- */
#activeUsers { font-size:0.7rem; margin-top:0.5rem; }
/* --- Message Board --- */
#board {
  max-width:800px;
  margin:1rem auto;
  background: #e0e0e0;
  padding:0.5rem;
  border:2px solid #000;
  font-size:0.8rem;
}
.post { border-bottom:1px dashed #000; margin-bottom:0.5rem; padding-bottom:0.5rem; background:#fff; }
/* --- Lore Section --- */
#lore { margin:1rem; font-size:0.8rem; max-width:800px; color:#000; background:#e0e0e0; padding:0.5rem; border:2px inset #000; }
/* --- Loading --- */
#loading {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:1000;
  color:#0f0;
  font-size:0.8rem;
}
#loadingLore { margin-top:1rem; }
/* --- Inputs --- */
input, textarea, select, button { font-family: 'Press Start 2P', monospace; }
button { margin-top:0.5rem; border:2px outset #000; background:#c0c0c0; color:#000; cursor:pointer; }
</style>
</head>
<body>

<div id="loading">
  <div id="loadingText">INITIALIZING...</div>
  <div id="loadingLore"></div>
</div>

<header>
  <a href="https://tokillamockinggoblin.boards.net/">To Kill a Mocking Goblin</a>
  <a href="https://youtube.com/playlist?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq&si=anZaakmimPIGuYwO">Melphia's Game</a>
  <a href="https://reedsy.com/discovery/book/before-us-1-melphia-s-game-patrick-mcdonald#preview">Book 1</a>
  <a href="https://web.archive.org/">Wayback Machine</a>
</header>

<div id="handleInput">
  <input type="text" id="handle" placeholder="Enter your handle" maxlength="16">
</div>

<div id="youtube">
  <iframe src="https://www.youtube.com/embed/videoseries?list=PLc1nF09D92pJCy_TQVOpfZg0BE-vAJJVq&si=anZaakmimPIGuYwO" frameborder="0" allowfullscreen></iframe>
</div>

<div class="chat-window" id="chat">
  <div class="chat-header">
    <div>Live Chat</div>
    <select id="channelSelect">
      <option value="Exuro">//Exuro</option>
      <option value="Sam">//Sam</option>
      <option value="Nero">//Nero</option>
      <option value="Nora">//Nora</option>
      <option value="Loktal">//Loktal</option>
      <option value="Pilgrim">//Pilgrim (secret)</option>
    </select>
  </div>
  <div class="messages" id="messages"></div>
  <input type="text" id="messageInput" placeholder="Type your message (max 500 chars)">
  <button id="sendBtn">Send</button>
  <div id="activeUsers"></div>
</div>

<div id="board">
  <h2>Message Board</h2>
  <div id="posts"></div>
  <input type="text" id="boardName" placeholder="Your Name (max 100)">
  <textarea id="boardMsg" placeholder="Your post (max 1000)"></textarea>
  <button id="postBtn">Post</button>
</div>

<div id="lore"></div>
<audio id="doorSound" src="https://freesound.org/data/previews/3/3080_5159-lq.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGdiOrMFolYWNMvckE4fbp_VhWA80BaII",
  authDomain: "before-us-universe.firebaseapp.com",
  databaseURL: "https://before-us-universe-default-rtdb.firebaseio.com",
  projectId: "before-us-universe",
  storageBucket: "before-us-universe.appspot.com",
  messagingSenderId: "477103463228",
  appId: "1:477103463228:web:01b53b6b29cb9d54315c39"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase();
const auth = getAuth();

signInAnonymously(auth);

let currentHandle = "";
const handleInput = document.getElementById('handle');
handleInput.addEventListener('change', () => { currentHandle = handleInput.value.trim() || "Anonymous"; });

const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const channelSelect = document.getElementById('channelSelect');
const activeUsersDiv = document.getElementById('activeUsers');
const doorSound = document.getElementById('doorSound');

function updateActiveUsers() {
  const onlineRef = ref(db, "online");
  onValue(onlineRef, snapshot => {
    const data = snapshot.val() || {};
    let display = "Active Users: ";
    for (let user in data) {
      display += `<span class='tooltip ${data[user].online ? "user-online" : "user-offline"}'>${data[user].handle}<span class="tooltiptext">${user}</span></span> `;
    }
    activeUsersDiv.innerHTML = display;
  });
}
updateActiveUsers();

sendBtn.addEventListener('click', () => {
  if (!currentHandle) { alert("Enter a handle first"); return; }
  const msg = messageInput.value.trim();
  if (!msg) return;
  const channel = channelSelect.value;
  const msgRef = push(ref(db, `chat/${channel}`));
  set(msgRef, { name: currentHandle, msg });
  messageInput.value = "";
  doorSound.play();
});

function listenChannel(channel) {
  messagesDiv.innerHTML = "";
  const chatRef = ref(db, `chat/${channel}`);
  onChildAdded(chatRef, snapshot => {
    const { name, msg } = snapshot.val();
    const div = document.createElement('div');
    div.classList.add('message');
    div.innerHTML = `<strong>${name}:</strong> ${msg}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}
channelSelect.addEventListener('change', () => listenChannel(channelSelect.value));
listenChannel(channelSelect.value);

// Local message board
const postsDiv = document.getElementById('posts');
const postBtn = document.getElementById('postBtn');
const boardName = document.getElementById('boardName');
const boardMsg = document.getElementById('boardMsg');
const boardRef = ref(db, "board");
onChildAdded(boardRef, snapshot => {
  const { name, msg } = snapshot.val();
  const div = document.createElement('div');
  div.classList.add('post');
  div.innerHTML = `<strong>${name}</strong>: ${msg}`;
  postsDiv.appendChild(div);
});

postBtn.addEventListener('click', () => {
  if (!boardName.value.trim() || !boardMsg.value.trim()) return;
  push(boardRef, { name: boardName.value.trim(), msg: boardMsg.value.trim() });
  boardName.value = "";
  boardMsg.value = "";
});

// Dynamic loading & lore
const loadingDiv = document.getElementById('loadingText');
const loreDiv = document.getElementById('loadingLore');
const loreContent = [
  "Loading Sector 1: The Voidborn... 23% complete",
  "Awakening ancient AI... 45% complete",
  "Multiversal rifts stabilizing... 68% complete",
  "Preparing Lux Fleet deployment... 89% complete",
  "Initialization complete. Welcome to the Before Us Universe."
];
let idx = 0;
function nextLore() {
  if (idx < loreContent.length) {
    loreDiv.innerText = loreContent[idx];
    idx++;
    setTimeout(nextLore, 1000);
  } else {
    document.getElementById('loading').style.display = "none";
  }
}
nextLore();

// Update online status
onAuthStateChanged(auth, user => {
  if (user) {
    const onlineRef = ref(db, `online/${user.uid}`);
    set(onlineRef, { handle: currentHandle || "Anonymous", online: true });
    window.addEventListener('beforeunload', () => remove(onlineRef));
  }
});

// --- Draggable Chat Window ---
const chatWindow = document.querySelector('.chat-window');
let isDragging = false, offsetX = 0, offsetY = 0;
chatWindow.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - chatWindow.offsetLeft;
  offsetY = e.clientY - chatWindow.offsetTop;
});
document.addEventListener('mousemove', e => {
  if (!isDragging) return;
  chatWindow.style.left = `${e.clientX - offsetX}px`;
  chatWindow.style.top = `${e.clientY - offsetY}px`;
});
document.addEventListener('mouseup', e => { isDragging = false; });
</script>
</body>
</html>
