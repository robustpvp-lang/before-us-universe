<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FleetCommand: Tactical</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --dos-green: #00ff00;
        --dos-bg: #000000;
        --hud-bg: rgba(0, 20, 0, 0.8);
        --game-width: 575px;
        --game-height: 431px; /* Approx 4:3 ratio */
    }

    body {
        background-color: #111;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        font-family: 'Courier New', Courier, monospace;
        color: white;
    }

    /* Main Game Wrapper - Locked to 575px */
    #game-wrapper {
        position: relative;
        width: var(--game-width);
        height: var(--game-height);
        border: 4px solid #333;
        background-color: #000;
        box-shadow: 0 0 20px rgba(0,0,0,0.8);
        overflow: hidden;
    }

    canvas {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #020617;
    }

    /* UI Overlay - Handles HUD and Screens */
    .ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass through to canvas */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    /* Top HUD Bar */
    .hud-bar {
        background-color: var(--hud-bg);
        padding: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
        pointer-events: auto; /* Re-enable clicks for buttons */
        height: 50px;
    }

    .hud-btn {
        background: #374151;
        border: 1px solid #6b7280;
        color: white;
        font-size: 12px;
        padding: 4px 10px;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
        transition: background 0.2s;
    }
    .hud-btn:hover { background: #4b5563; }
    .hud-btn:active { transform: translateY(1px); }

    .score-display {
        font-size: 18px;
        color: var(--dos-green);
        font-weight: bold;
    }

    /* Screens (Title, Game Over, Map) */
    .screen {
        position: absolute;
        top: 50px; /* Below HUD */
        left: 0;
        width: 100%;
        height: calc(100% - 50px);
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: auto;
        z-index: 10;
    }

    .hidden { display: none !important; }

    h1 { color: var(--dos-green); font-size: 32px; margin-bottom: 10px; text-transform: uppercase; text-shadow: 0 0 10px var(--dos-green); }
    h2 { color: #ef4444; font-size: 28px; margin-bottom: 10px; }
    p { color: #ccc; margin-bottom: 20px; font-size: 14px; text-align: center; padding: 0 20px; }

    .action-btn {
        padding: 10px 20px;
        font-size: 16px;
        background: var(--dos-green);
        color: black;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }
    .action-btn:hover { background: #fff; }

    /* Map Grid Styling */
    #map-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        width: 80%;
        height: 60%;
        border: 1px solid #444;
        padding: 5px;
    }
    .map-cell { background: #111; border: 1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #444; }
    .map-cell.active { background: #064e3b; color: #34d399; border-color: #059669; }
    .map-cell.player-loc { background: #1e3a8a; color: white; border: 1px solid #3b82f6; }

    /* Helper text below game */
    .controls-hint {
        width: var(--game-width);
        margin-top: 10px;
        color: #666;
        font-size: 12px;
        text-align: center;
    }
</style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="575" height="431"></canvas>
    
    <div class="ui-layer">
        <div class="hud-bar">
            <div class="flex gap-2">
                <button class="hud-btn" id="btn-map" onclick="toggleMap()">Map</button>
                <button class="hud-btn" id="btn-switch" onclick="switchShip()">Switch Ship</button>
            </div>
            <div class="score-display">SCORE: <span id="score-val">0</span></div>
            <div class="text-xs text-gray-400">LVL <span id="level-val">1</span></div>
        </div>

        <div id="title-screen" class="screen">
            <h1>FLEET COMMAND</h1>
            <p>Sector 7 is under attack.<br>Initialize defense protocols.</p>
            <button class="action-btn" onclick="startGame()">INITIALIZE</button>
        </div>

        <div id="game-over-screen" class="screen hidden">
            <h2>SIGNAL LOST</h2>
            <p>Your fleet has been decimated.</p>
            <p>Final Score: <span id="final-score">0</span></p>
            <button class="action-btn" onclick="resetGame()">REBOOT SYSTEM</button>
        </div>

        <div id="map-screen" class="screen hidden">
            <h1 style="font-size: 20px; margin-bottom: 10px;">TACTICAL MAP</h1>
            <div id="map-grid">
                </div>
            <p style="margin-top: 15px; margin-bottom: 5px;">PAUSED</p>
            <button class="hud-btn" onclick="toggleMap()">RESUME</button>
        </div>
    </div>
</div>

<div class="controls-hint">
    WASD / Arrows to Move &bull; SPACE to Shoot
</div>

<script>
    /**
     * GAME CONFIGURATION
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const uiScore = document.getElementById('score-val');
    const uiLevel = document.getElementById('level-val');
    const uiFinalScore = document.getElementById('final-score');
    const titleScreen = document.getElementById('title-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const mapScreen = document.getElementById('map-screen');
    const mapGrid = document.getElementById('map-grid');

    // Game State
    let gameRunning = false;
    let isPaused = false;
    let score = 0;
    let level = 1;
    let lastTime = 0;
    let spawnTimer = 0;
    let spawnDelay = 2000;

    // Ships Configuration
    const shipTypes = [
        { name: 'Interceptor', color: '#3b82f6', width: 30, speed: 5, hp: 3, shotDelay: 200 }, // Balanced
        { name: 'Bomber', color: '#ef4444', width: 40, speed: 3, hp: 5, shotDelay: 400 },      // Slow, Tanky
        { name: 'Stealth', color: '#eab308', width: 20, speed: 7, hp: 2, shotDelay: 150 }      // Fast, Weak
    ];
    let currentShipIdx = 0;

    // Entities
    const player = {
        x: canvas.width / 2,
        y: canvas.height - 50,
        width: 30,
        height: 30,
        dx: 0,
        dy: 0,
        hp: 3,
        maxHp: 3,
        lastShot: 0,
        shooting: false
    };

    let bullets = [];
    let enemies = [];
    let particles = [];

    // Controls
    const keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false, w:false, s:false, a:false, d:false, " ":false };

    /**
     * INITIALIZATION
     */
    function init() {
        // Generate Map Grid visual
        mapGrid.innerHTML = '';
        for(let i=0; i<16; i++) {
            const div = document.createElement('div');
            div.className = 'map-cell';
            if(i === 13) div.classList.add('player-loc'); // Fake player location
            else if(i < 4) div.classList.add('active');   // Fake enemies
            div.innerText = i < 4 ? 'HOSTILE' : (i===13 ? 'YOU' : '.');
            mapGrid.appendChild(div);
        }

        // Set initial ship stats
        applyShipStats();

        // Start Loop
        requestAnimationFrame(gameLoop);
    }

    function applyShipStats() {
        const type = shipTypes[currentShipIdx];
        player.width = type.width;
        player.maxHp = type.hp; // Only applies on reset usually, but we'll keep current HP relative
        // Update button text
        document.getElementById('btn-switch').innerText = `SHIP: ${type.name}`;
    }

    function startGame() {
        gameRunning = true;
        isPaused = false;
        score = 0;
        level = 1;
        player.hp = shipTypes[currentShipIdx].hp;
        bullets = [];
        enemies = [];
        particles = [];
        player.x = canvas.width / 2;
        player.y = canvas.height - 50;
        
        titleScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        mapScreen.classList.add('hidden');
        
        updateHUD();
    }

    function resetGame() {
        startGame();
    }

    function toggleMap() {
        if(!gameRunning) return;
        isPaused = !isPaused;
        if(isPaused) {
            mapScreen.classList.remove('hidden');
        } else {
            mapScreen.classList.add('hidden');
        }
    }

    function switchShip() {
        currentShipIdx = (currentShipIdx + 1) % shipTypes.length;
        applyShipStats();
        // If playing, flash message? (Optional)
    }

    function updateHUD() {
        uiScore.innerText = score;
        uiLevel.innerText = level;
    }

    /**
     * GAME LOOP
     */
    function gameLoop(timestamp) {
        const dt = timestamp - lastTime;
        lastTime = timestamp;

        if (gameRunning && !isPaused) {
            update(dt);
            draw();
        }

        requestAnimationFrame(gameLoop);
    }

    function update(dt) {
        // 1. Player Movement
        const ship = shipTypes[currentShipIdx];
        if (keys.ArrowLeft || keys.a) player.x -= ship.speed;
        if (keys.ArrowRight || keys.d) player.x += ship.speed;
        if (keys.ArrowUp || keys.w) player.y -= ship.speed;
        if (keys.ArrowDown || keys.s) player.y += ship.speed;

        // Clamp bounds
        player.x = Math.max(player.width/2, Math.min(canvas.width - player.width/2, player.x));
        player.y = Math.max(player.height/2, Math.min(canvas.height - player.height/2, player.y));

        // 2. Shooting
        if (keys[" "] && Date.now() - player.lastShot > ship.shotDelay) {
            bullets.push({ x: player.x, y: player.y - 20, width: 4, height: 10, color: '#ffff00' });
            player.lastShot = Date.now();
        }

        // 3. Bullets
        bullets.forEach(b => b.y -= 8);
        bullets = bullets.filter(b => b.y > -10);

        // 4. Spawning Enemies
        if (Date.now() - spawnTimer > spawnDelay) {
            spawnEnemy();
            spawnTimer = Date.now();
        }

        // 5. Enemies Update
        enemies.forEach(e => {
            e.y += e.speed;
            e.x += Math.sin(e.y * 0.05) * 2; // Wavy movement
        });

        // 6. Collision
        bullets.forEach((b, bi) => {
            enemies.forEach((e, ei) => {
                if (rectIntersect(b.x, b.y, b.width, b.height, e.x, e.y, e.width, e.height)) {
                    // Hit
                    createParticles(e.x + e.width/2, e.y + e.height/2, e.color);
                    enemies.splice(ei, 1);
                    bullets.splice(bi, 1);
                    score += 10;
                    updateHUD();
                    
                    // Level up simple logic
                    if(score % 100 === 0) {
                        level++;
                        spawnDelay = Math.max(500, spawnDelay - 2
